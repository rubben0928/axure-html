<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>å·¥ç¨‹è¨ˆç®—ç¨¿ç´™ - å–®åƒ¹è¡¨èˆ‡å–®åƒ¹è³‡æ–™åº«ï¼ˆä¿®æ­£ç‰ˆï¼‰</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
<style>
    /* åŸºæœ¬é‡ç½® */
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%}
    body{
        font-family:"Microsoft JhengHei","Noto Sans TC",Arial,sans-serif;
        background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
        padding:20px;color:#2c3e50;
    }
    .container{max-width:1400px;margin:0 auto;background:#fff;border-radius:14px;overflow:hidden;box-shadow:0 18px 40px rgba(0,0,0,.18);}

    /* Header */
    .header{background:linear-gradient(135deg,#2c3e50 0%,#34495e 100%);color:#fff;padding:26px}
    .header h1{font-size:28px;margin-bottom:8px}
    .header-info{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:10px}
    .info-item{background:rgba(255,255,255,.08);padding:10px 14px;border-radius:10px}
    .info-label{font-size:13px;opacity:.9}
    .info-value{font-weight:700;font-size:16px}

    .calculation-summary {
    background: #e8f5e9;
    padding: 12px;
    border-radius: 8px;
    margin-bottom: 16px;
    border: 1px solid #c8e6c9;
    animation: fadeIn 0.3s ease;
}

.calculation-summary .total-label {
    font-weight: 700;
    color: #2e7d32;
}

.calculation-summary .total-value {
    font-size: 20px;
    font-weight: 800;
    color: #1b5e20;
}

/* é å®šé€²åº¦é ç±¤æ¨£å¼è£œå…… */
#schedule .info-card {
    background: #fff;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 6px 14px rgba(0,0,0,.04);
}

#schedule .range-handle:hover {
    transform: translateY(-50%) scale(1.1);
}

#schedule .month-mark {
    pointer-events: none;
}

#schedule .range-handle .progress-indicator {
    pointer-events: none;
    transition: opacity 0.2s;
}

#schedule .range-handle:hover .progress-indicator {
    opacity: 1;
}

/* éŸ¿æ‡‰å¼èª¿æ•´ */
@media (max-width: 900px) {
    #schedule .range-slider-container {
        min-width: 300px;
    }
    
    #schedule .controls {
        flex-direction: column;
    }
    
    #schedule .controls button {
        width: 100%;
        margin-bottom: 8px;
    }
}

/* Tabs */
    .tabs{display:flex;background:#f8f9fa;border-bottom:3px solid #667eea}
    .tab{flex:1;padding:14px;text-align:center;cursor:pointer;font-weight:700;border:none;background:#e9ecef;transition:all .18s}
    .tab:hover{background:#dee2e6}
    .tab.active{background:#fff;color:#667eea;position:relative}
    .tab.active::after{content:"";position:absolute;left:0;right:0;bottom:-3px;height:3px;background:#667eea}
    .tab-content{display:none;padding:26px;animation:fadeIn .25s ease}
    .tab-content.active{display:block}
    @keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:none}}

    /* common form */
    .form-group{margin-bottom:16px}
    label{display:block;margin-bottom:6px;font-weight:700;font-size:14px;color:#2c3e50}
    input,select,textarea,button{font-family:inherit}
    input,select,textarea{width:100%;padding:10px 12px;border-radius:8px;border:1px solid #e0e0e0;font-size:14px}
    input:focus,select:focus,textarea:focus{outline:none;box-shadow:0 0 0 4px rgba(102,126,234,.08);border-color:#667eea}

    .cascading-selects{display:grid;grid-template-columns:1fr 1fr;gap:18px;margin-bottom:20px}

    .calculation-input{background:#f8f9fa;padding:18px;border-radius:12px;border:1px solid #e9ecef;margin-bottom:16px}
    .calc-row{display:grid;grid-template-columns:1fr 2fr 1fr auto;gap:12px;align-items:end;margin-bottom:12px}
    .edit-calc-row{display:grid;grid-template-columns:1fr 2fr 1fr auto;gap:12px;align-items:end;margin-bottom:12px;padding:10px;border-radius:8px;background:#fbfcfd;border:1px solid #eee}

    .btn{padding:10px 18px;border-radius:10px;cursor:pointer;border:none;font-weight:700;box-shadow:0 6px 18px rgba(0,0,0,.08)}
    .btn-primary{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff}
    .btn-success{background:linear-gradient(135deg,#11998e 0%,#38ef7d 100%);color:#fff}
    .btn-warning{background:linear-gradient(135deg,#f2994a 0%,#f2c94c 100%);color:#fff}
    .btn-danger{background:linear-gradient(135deg,#eb3349 0%,#f45c43 100%);color:#fff;padding:8px 12px}
    .btn-secondary{background:#6c757d;color:#fff}

    .result{background:#fff;padding:8px 12px;border-radius:8px;border:1px solid #e0e0e0;text-align:center;font-weight:700}
    .items-list{margin-top:20px}
    .work-area-section{background:#f8f9fa;padding:18px;border-left:6px solid #667eea;border-radius:10px;margin-bottom:16px}
    .work-area-title{color:#667eea;font-weight:700;font-size:18px}
    .item-card{background:#fff;padding:14px;border-radius:10px;box-shadow:0 6px 14px rgba(0,0,0,.04);margin-bottom:12px;border-left:4px solid #764ba2}
    .item-header{display:flex;justify-content:space-between;align-items:center}
    .item-name{font-weight:800;color:#2c3e50}
    .item-details{color:#6c757d;font-size:13px;margin-top:8px}

    /* table base */
    table{width:100%;border-collapse:collapse;margin-top:10px;background:#fff;border-radius:8px;overflow:hidden;box-shadow:0 4px 14px rgba(0,0,0,.06)}
    th{padding:12px 14px;text-align:left;font-weight:800;color:#fff;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%)}
    td{padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle}

    /* ---- å–®åƒ¹è¡¨æ¨£å¼ï¼ˆä¸»è¦ä¿®æ”¹ï¼‰ ---- */
    .price-table{width:100%;border-collapse:collapse;margin-bottom:20px;overflow:hidden;border-radius:10px}
    .price-table th{background:linear-gradient(135deg,#11998e 0%,#38ef7d 100%);color:#fff;text-align:center}
    .price-table td{padding:12px 14px;border-bottom:1px solid #e9ecef;text-align:center}
    .price-table td:nth-child(1), .price-table th:nth-child(1){text-align:left;padding-left:18px}
    .price-table td:nth-child(2), .price-table th:nth-child(2){text-align:center}
    .price-table td:nth-child(3), .price-table th:nth-child(3){text-align:center}
    .price-table td:nth-child(4), .price-table th:nth-child(4),
    .price-table td:nth-child(5), .price-table th:nth-child(5){text-align:right;padding-right:18px}
    .price-table .project-row{background:#f0f8ff;font-weight:700}
    .price-table .material-row{background:#ffffff}
    .price-table .total-row{background:#e8f5e9;font-weight:900;border-top:2px solid #11998e}
    .price-table-wrapper{overflow-x:auto;padding-bottom:8px}

    .price-table-section h3{color:#2c3e50;margin-bottom:12px;padding-bottom:10px;border-bottom:2px solid #667eea}
    
    /* å–®åƒ¹è¡¨æ¨™é ­è³‡è¨Š */
    .price-table-header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 10px;
        padding: 10px;
        background: #f8f9fa;
        border-radius: 8px;
        font-weight: bold;
    }
    .price-table-header div {
        margin-right: 20px;
    }

    /* database */
    .price-database-section{background:#fff;padding:18px;border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,.04)}
    .database-tabs{display:flex;gap:8px;margin-bottom:12px}
    .database-tab{flex:1;text-align:center;padding:12px;cursor:pointer;border-radius:8px;background:#f5f5f5;font-weight:700}
    .database-tab.active{background:#667eea;color:#fff}
    .database-search{display:flex;gap:12px;margin-bottom:12px}
    .material-list{max-height:300px;overflow:auto;border:1px solid #ddd;border-radius:8px;padding:8px}

    /* modal */
    .modal{display:none;position:fixed;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,.55);z-index:1200;align-items:center;justify-content:center;padding:24px}
    .modal.show{display:flex}
    .modal-content{width:100%;max-width:900px;background:#fff;border-radius:12px;overflow:hidden;box-shadow:0 30px 80px rgba(0,0,0,.35);animation:modalIn .22s ease}
    @keyframes modalIn{from{transform:translateY(18px);opacity:0}to{transform:none;opacity:1}}
    .modal-header{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;padding:18px;display:flex;justify-content:space-between;align-items:center}
    .modal-body{padding:18px}
    .modal-footer{padding:14px 18px;background:#f8f9fa;display:flex;justify-content:flex-end;gap:10px}
    .close{background:none;border:none;color:#fff;font-size:26px;cursor:pointer}

    /* utility */
    .action-buttons{display:flex;gap:8px;justify-content:flex-end;margin-top:10px}
    .empty-state{text-align:center;padding:28px;color:#6c757d}
    .empty-state-icon{font-size:48px;opacity:.3;margin-bottom:8px}
    .database-content{display:none}
    .database-content.active{display:block}
    .new-material{color:#e74c3c;font-weight:bold}
    
    /* å·¥æ–™é¸æ“‡è¡¨æ ¼æ¨£å¼ */
    .material-select-row input[type="number"] {
        width: 80px;
        padding: 6px;
        border: 1px solid #ddd;
        border-radius: 6px;
        text-align: center;
    }
    .material-select-row input[type="number"]:focus {
        outline: none;
        box-shadow: 0 0 0 2px rgba(102,126,234,.2);
        border-color: #667eea;
    }


/* åœŸçŸ³æ–¹è¡¨æ ¼æ ·å¼ */
#earthworkTable {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
    background: #fff;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 4px 14px rgba(0,0,0,.06);
}

#earthworkTable th {
    padding: 12px 8px;
    text-align: center;
    font-weight: 800;
    color: #fff;
    background: linear-gradient(135deg,#667eea 0%,#764ba2 100%);
    border: 1px solid #ddd;
}

#earthworkTable th[colspan="3"] {
    background: linear-gradient(135deg,#11998e 0%,#38ef7d 100%);
}

#earthworkTable td {
    padding: 8px;
    border-bottom: 1px solid #eee;
    vertical-align: middle;
    border: 1px solid #ddd;
}

#earthworkTable input {
    width: 100%;
    padding: 6px;
    border: 1px solid #ddd;
    border-radius: 4px;
    text-align: center;
}

#earthworkTable input:focus {
    outline: none;
    box-shadow: 0 0 0 2px rgba(102,126,234,.2);
    border-color: #667eea;
}

    /* æ•¸é‡è¡¨ç‰¹æ®Šæ¨£å¼ */
.header-box {
    background-color: #ff9933;
    color: black;
    padding: 10px 20px;
    font-size: 18px;
    font-weight: bold;
    display: inline-block;
    margin-bottom: 15px;
}

.quantity-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
}

.quantity-table th, 
.quantity-table td {
    border: 1px solid #333;
    padding: 8px;
    text-align: center;
}

.diagonal-line {
    position: absolute;
    width: 100%;
    height: 100%;
    top: 0;
    left: 0;
}

.diagonal-line svg {
    width: 100%;
    height: 100%;
}

.label-top {
    position: absolute;
    font-size: 14px;
}

.label-bottom {
    position: absolute;
    font-size: 14px;
}

.project-name {
    text-align: left;
    padding-left: 15px;
    background-color: #e6ffe6;
}

.sub-header {
    font-size: 11px;
    line-height: 1.3;
}

    /* é ç®—ç›¸é—œæ¨£å¼ */
    .budget-summary {
        background-color: #e8f5e9;
        border-radius: 8px;
        padding: 15px;
        margin-top: 20px;
        border: 1px solid #c8e6c9;
    }
    
    .budget-total {
        font-size: 1.5rem;
        font-weight: 700;
        color: #1b5e20;
        text-align: center;
        margin-top: 10px;
    }

    .checkbox-group {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        margin-bottom: 15px;
    }
    
    .checkbox-group .form-check {
        min-width: 180px;
    }

    .section-title {
        color: #2c7744;
        border-bottom: 2px solid #8bc34a;
        padding-bottom: 8px;
        margin-bottom: 20px;
        font-weight: 700;
    }

    @media(max-width:900px){
        .cascading-selects{grid-template-columns:1fr}
        .calc-row,.edit-calc-row{grid-template-columns:1fr}
        th,td{padding:10px;font-size:13px}
    }
.empty-state {
    text-align: center;
    padding: 40px 20px;
    color: #6c757d;
}

.empty-state-icon {
    font-size: 48px;
    opacity: 0.3;
    margin-bottom: 16px;
}

.empty-state h3 {
    margin-bottom: 8px;
    font-weight: 600;
}

.empty-state p {
    opacity: 0.7;
}
/* æ•¸é‡è¡¨æ¨£å¼èª¿æ•´ */
.quantity-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
    font-size: 14px;
}

.quantity-table th, 
.quantity-table td {
    border: 1px solid #333;
    padding: 8px;
    text-align: center;
    min-width: 80px;
}

.quantity-table th {
    background-color: #f5f5f5;
    font-weight: bold;
}

.project-name {
    text-align: left;
    padding-left: 15px;
    background-color: #e6ffe6;
    font-weight: bold;
}

.diagonal-line {
    position: absolute;
    width: 100%;
    height: 100%;
    top: 0;
    left: 0;
}

.diagonal-line svg {
    width: 100%;
    height: 100%;
}

.label-top {
    position: absolute;
    font-size: 14px;
    top: 3px;
    right: 15px;
}

.label-bottom {
    position: absolute;
    font-size: 14px;
    bottom: 8px;
    left: 10px;
}

/* Autocomplete æ¨£å¼ */
.autocomplete {
  position: relative;
  display: inline-block;
  width: 100%;
}

.autocomplete-items {
  position: absolute;
  border: 1px solid #ddd;
  border-bottom: none;
  border-top: none;
  z-index: 99;
  top: 100%;
  left: 0;
  right: 0;
  max-height: 200px;
  overflow-y: auto;
  background: white;
}

.autocomplete-items div {
  padding: 10px;
  cursor: pointer;
  background-color: #fff;
  border-bottom: 1px solid #ddd;
}

.autocomplete-items div:hover {
  background-color: #e9e9e9;
}

.autocomplete-active {
  background-color: #667eea !important;
  color: white;
}

.material-search-box {
  position: relative;
  margin-bottom: 15px;
}

.material-search-box i {
  position: absolute;
  left: 12px;
  top: 50%;
  transform: translateY(-50%);
  color: #6c757d;
  z-index: 1;
}

.material-search-box input {
  padding-left: 40px;
  width: 100%;
}

</style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1>ğŸ—ï¸ é ç®—æ›¸ç·¨è£½ä½œæ¥­</h1>
        <div class="header-info">
            <div class="info-item">
                <div class="info-label">å·¥ç¨‹åç¨±</div>
                <div class="info-value">é¾œå±±å¤§é™‚åœ³æ°´é–€æ›´æ–°æ”¹å–„å·¥ç¨‹</div>
            </div>
            <div class="info-item">
                <div class="info-label">æ–½å·¥åœ°é»</div>
                <div class="info-value">è‹—æ —ç¸£è‹—æ —å¸‚</div>
            </div>
        </div>
    </div>

    <div class="tabs">
        <button class="tab active" data-tab="main">å·¥ç¨‹è¨ˆç®—ç¨¿ç´™</button>
        <button class="tab" data-tab="earthwork">åœŸçŸ³æ–¹è¨ˆç®—</button>
        <button class="tab" data-tab="quantity">æ•¸é‡ç¸½è¡¨</button>
        <button class="tab" data-tab="vertical">æ•¸é‡è¡¨(ç›´å¼)</button>
        <button class="tab" data-tab="price">å–®åƒ¹è¡¨</button>
        <button class="tab" data-tab="basic">å·¥ç¨‹é ç®—æ›¸åŸºæœ¬è³‡æ–™</button>
        <button class="tab" data-tab="budget">é ç®—</button>
        <button class="tab" data-tab="schedule">é å®šé€²åº¦</button>
        <button class="tab" data-tab="database">å–®åƒ¹è³‡æ–™åº«ç®¡ç†</button>
    </div>

    <!-- MAIN TAB -->
    <div id="main" class="tab-content active">
        <div class="cascading-selects">
            <div class="form-group">
                <label>é¸æ“‡å·¥å€</label>
                <select id="workArea">
                    <option value="">è«‹é¸æ“‡å·¥å€</option>
                    <option value="é¾œå±±å¤§é™‚åœ³æ°´é–€æ›´æ–°æ”¹å–„">é¾œå±±å¤§é™‚åœ³æ°´é–€æ›´æ–°æ”¹å–„</option>
                    <option value="å±¯ä¸‹åŸ¤åœ³å°çµ¦4ä¹‹1">å±¯ä¸‹åŸ¤åœ³å°çµ¦4ä¹‹1</option>
<option value="è‹¥ç„¡å·¥å€ï¼Œå¯æä¾›æ‰‹å‹•è¼¸å…¥">è‹¥ç„¡å·¥å€ï¼Œå¯æä¾›æ‰‹å‹•è¼¸å…¥</option>
                </select>
            </div>
            <div class="form-group">
                <label>é¸æ“‡é¡åˆ¥</label>
                <select id="category" disabled><option>è«‹å…ˆé¸æ“‡å·¥å€</option></select>
            </div>
        </div>

        <div id="itemSelection" style="display:none;">
            <div class="form-group">
                <label>é¸æ“‡é …ç›®</label>
                <select id="item"><option>è«‹é¸æ“‡é …ç›®</option></select>
            </div>

           <div id="calculationSection" style="display:none;">
    <div class="calculation-input">
        <h3 style="color:#667eea;margin-bottom:12px;">ğŸ“ è¨ˆç®—å¼è¼¸å…¥</h3>
        
        <!-- æ–°å¢ï¼šç¸½è¨ˆé¡¯ç¤ºå€åŸŸ -->
        <div class="calculation-summary" style="background:#e8f5e9;padding:12px;border-radius:8px;margin-bottom:16px;border:1px solid #c8e6c9;">
            <div style="display:flex;justify-content:space-between;align-items:center;">
                <div style="font-weight:700;color:#2e7d32;">åˆè¨ˆï¼š</div>
                <div id="currentTotal" style="font-size:20px;font-weight:800;color:#1b5e20;">0.00</div>
            </div>
        </div>
        
        <div id="calcRows"></div>
        <div style="margin-top:8px;">
            <button class="btn btn-success" onclick="addCalcRow()">â• æ–°å¢è¨ˆç®—å¼</button>
        </div>
    </div>
    <div style="display:flex;gap:10px">
        <button class="btn btn-primary" onclick="saveCalculation()">ğŸ’¾ å„²å­˜è¨ˆç®—</button>
        <button class="btn btn-warning" onclick="clearCalcRows()">ğŸ§¹ æ¸…ç©º</button>
    </div>
</div>
        </div>

        <div class="items-list">
            <h2 style="margin-bottom:14px;">ğŸ“‹ å·²æ–°å¢é …ç›®</h2>
            <div id="itemsList"></div>
        </div>
    </div>

    
<!-- EARTHWORK TAB -->
<div id="earthwork" class="tab-content">
    <h2 style="margin-bottom:12px;">ğŸ“Š åœŸçŸ³æ–¹è¨ˆç®—</h2>
    
    <!-- æ–°å¢å·¥åŒºé€‰æ‹© -->
    <div class="form-group" style="margin-bottom:20px;">
        <label>é¸æ“‡å·¥å€</label>
        <select id="earthworkWorkArea" style="max-width:300px;">
            <option value="">è«‹é¸æ“‡å·¥å€</option>
            <option value="é¾œå±±å¤§é™‚åœ³æ°´é–€æ›´æ–°æ”¹å–„">é¾œå±±å¤§é™‚åœ³æ°´é–€æ›´æ–°æ”¹å–„</option>
            <option value="å±¯ä¸‹åŸ¤åœ³å°çµ¦4ä¹‹1">å±¯ä¸‹åŸ¤åœ³å°çµ¦4ä¹‹1</option>
 <option value="è‹¥ç„¡å·¥å€ï¼Œå¯æä¾›æ‰‹å‹•è¼¸å…¥">è‹¥ç„¡å·¥å€ï¼Œå¯æä¾›æ‰‹å‹•è¼¸å…¥</option>
        </select>
    </div>
    
    <div style="background:#f8f9fa;padding:16px;border-radius:10px">
        <div style="overflow:auto">
            <table id="earthworkTable">
                <thead>
                    <tr>
                        <th>è·é›¢</th>
                        <!-- æŒ–æ–¹ç›¸å…³æ ä½ -->
                        <th colspan="3" style="text-align:center;background:#e8f5e9">æŒ–æ–¹</th>
                        <!-- å¡«æ–¹ç›¸å…³æ ä½ -->
                        <th colspan="3" style="text-align:center;background:#fff3cd">å¡«æ–¹</th>
                        <th>æ“ä½œ</th>
                    </tr>
                    <tr>
                        <th></th>
                        <!-- æŒ–æ–¹å­æ ä½ -->
                        <th>æ–·é¢ç©</th>
                        <th>å¹³å‡æ–·é¢ç©</th>
                        <th>åœŸç©</th>
                        <!-- å¡«æ–¹å­æ ä½ -->
                        <th>æ–·é¢ç©</th>
                        <th>å¹³å‡æ–·é¢ç©</th>
                        <th>åœŸç©</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody id="earthworkBody"></tbody>
            </table>
        </div>
        <div class="action-buttons">
            <button class="btn btn-success" onclick="addEarthworkRow()">â• æ–°å¢è³‡æ–™</button>
            <button class="btn btn-primary" onclick="saveEarthworkData()">ğŸ’¾ å„²å­˜è³‡æ–™</button>
            <button class="btn btn-warning" onclick="importToMainCalculation()">ğŸ“¤ å¸¶å…¥å·¥ç¨‹è¨ˆç®—ç¨¿ç´™</button>
            <button class="btn btn-export" onclick="exportEarthwork()">ğŸ“¥ åŒ¯å‡ºåœŸçŸ³æ–¹è¨ˆç®—è¡¨</button>
        </div>
        <div style="margin-top:14px;display:grid;grid-template-columns:1fr 1fr;gap:12px">
            <div style="background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;padding:12px;border-radius:8px;text-align:center">
                <div style="opacity:.9">è·é›¢å°è¨ˆ</div>
                <div id="totalDistance" style="font-size:20px;font-weight:800">0.00 m</div>
            </div>
            <div style="background:linear-gradient(135deg,#11998e 0%,#38ef7d 100%);color:#fff;padding:12px;border-radius:8px;text-align:center">
                <div style="opacity:.9">é é‹æ£„åœŸ</div>
                <div id="totalExcess" style="font-size:20px;font-weight:800">0.00 mÂ³</div>
            </div>
        </div>
    </div>
</div>

<!-- æ•¸é‡è¡¨ -->
<div id="quantity" class="tab-content">
    <div class="card" style="background:#fff;padding:18px;border-radius:10px;box-shadow:0 6px 14px rgba(0,0,0,.04);margin-bottom:16px">
        <div style="background:#f8f9fa;padding:12px;border-radius:8px;margin-bottom:12px;font-weight:700">æ•¸é‡ç¸½è¡¨</div>
        <div class="action-buttons mb-3">
            <button class="btn btn-primary" id="collectData">
                <i class="fas fa-database me-2"></i>è³‡æ–™å½™é›†
            </button>
        </div>
        
        <div class="alert alert-success" id="dataCollectionAlert" style="display:none;background:#d4edda;color:#155724;padding:10px;border-radius:6px;margin-bottom:12px">
            è³‡æ–™åŒ¯å…¥å®Œæˆ!
        </div>
        
        <!-- å°‡æ•´å€‹è¡¨æ ¼å€åŸŸç”¨divåŒ…èµ·ä¾†ï¼Œä¸¦è¨­å®šåˆå§‹ç‚ºéš±è— -->
        <div id="quantityTableContainer" style="display:none;">
            <div style="overflow:auto">
                <table class="quantity-table" id="quantityTable">
                    <thead>
    <tr>
        <th rowspan="4" style="width: 250px; height: 120px; position: relative; padding: 0;">
            <div class="diagonal-line">
                <svg>
                    <line x1="0" y1="0" x2="100%" y2="50%" stroke="black" stroke-width="1"/>
                    <line x1="0" y1="0" x2="100%" y2="75%" stroke="black" stroke-width="1"/>
                    <line x1="0" y1="0" x2="100%" y2="100%" stroke="black" stroke-width="1"/>
                </svg>
            </div>
            <span class="label-top" style="top: 3px; right: 15px;">é …ç›®</span>
            <span class="label-bottom" style="top: 22px; left: 80px;">èªªæ˜</span>
            <span class="label-bottom" style="top: 50px; left: 100px;">å–®ä½</span>
            <span class="label-bottom" style="bottom: 8px; left: 10px;">å·¥ç¨‹åç¨±</span>
        </th>
        <th>é é‹æ£„åœŸ</th>
        <th>æŒ–å¡«æ–¹</th>
        <th>æŒ–æ–¹(æ©Ÿæ¢°æ–½å·¥)</th>
        <th>é‘½å­”æ¤ç­‹<br>è²»</th>
        <th>140kgf/cm2<br>é æ‹Œæ··å‡åœŸ<br>åŠæ¾†æ³¨</th>
        <th>é»ç„Šé‹¼çµ²ç¶²</th>
        <th></th>
        <th></th>
        <th></th>
        <th></th>
        <th></th>
        <th></th>
    </tr>
    <tr>
        <th></th>
        <th></th>
        <th></th>
        <th></th>
        <th></th>
        <th></th>
        <th></th>
        <th></th>
        <th></th>
        <th></th>
        <th></th>
        <th></th>
    </tr>
    <tr>
        <th>mÂ³</th>
        <th>mÂ³</th>
        <th>æ”¯</th>
        <th>å­”</th>
        <th>mÂ³</th>
        <th>mÂ³</th>
        <th></th>
        <th></th>
        <th></th>
        <th></th>
        <th></th>
        <th></th>
    </tr>
</thead>
                    <tbody id="quantityTableBody">
                        <!-- é€™è£¡æœƒç”±JavaScriptå‹•æ…‹ç”Ÿæˆå…§å®¹ -->
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- æ·»åŠ ä¸€å€‹åˆå§‹ç‹€æ…‹çš„æç¤º -->
        <div id="quantityEmptyState" class="empty-state">
            <div class="empty-state-icon">ğŸ“Š</div>
            <h3>å°šæœªå½™é›†è³‡æ–™</h3>
            <p>è«‹é»æ“Šã€Œè³‡æ–™å½™é›†ã€æŒ‰éˆ•ï¼Œå¾å·¥ç¨‹è¨ˆç®—ç¨¿ç´™åŒ¯å…¥è³‡æ–™</p>
        </div>
    </div>
</div>

    <!-- æ•¸é‡è¡¨(ç›´å¼) -->
    <div id="vertical" class="tab-content">
        <h3 class="section-title">æ•¸é‡è¡¨(ç›´å¼)</h3>
        
        <div class="card" style="background:#fff;padding:18px;border-radius:10px;box-shadow:0 6px 14px rgba(0,0,0,.04);margin-bottom:16px">
            <div style="background:#f8f9fa;padding:12px;border-radius:8px;margin-bottom:12px;font-weight:700">å·¥ç¨‹æ•¸é‡ç¸½è¡¨</div>
            <div style="overflow:auto">
                <table class="table" style="width:100%;border-collapse:collapse;margin-top:10px;background:#fff;border-radius:8px;overflow:hidden;box-shadow:0 4px 14px rgba(0,0,0,.06)" id="verticalTable">
                    <thead>
                        <tr>
                            <th style="padding:12px 14px;text-align:left;font-weight:800;color:#fff;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%)">ç·¨è™Ÿ</th>
                            <th style="padding:12px 14px;text-align:left;font-weight:800;color:#fff;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%)">å·¥ç¨‹é …ç›®</th>
                            <th style="padding:12px 14px;text-align:left;font-weight:800;color:#fff;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%)">èªªæ˜</th>
                            <th style="padding:12px 14px;text-align:left;font-weight:800;color:#fff;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%)">å–®ä½</th>
                            <th style="padding:12px 14px;text-align:left;font-weight:800;color:#fff;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%)">æ•¸é‡</th>
                        </tr>
                    </thead>
                    <tbody id="verticalTableBody">
                        <tr>
                            <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle">1</td>
                            <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle">æŒ–å¡«æ–¹</td>
                            <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle"></td>
                            <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle">mÂ³</td>
                            <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle">709.00</td>
                        </tr>
                        <tr>
                            <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle">2</td>
                            <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle">140kgf/cmÂ²é æ‹Œæ··å‡åœŸåŠæ¾†æ³¨</td>
                            <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle"></td>
                            <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle">mÂ³</td>
                            <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle">138.00</td>
                        </tr>
                        <tr>
                            <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle">3</td>
                            <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle">é‘½å­”æ¤ç­‹è²»</td>
                            <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle"></td>
                            <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle">å­”</td>
                            <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle">330.00</td>
                        </tr>
                        <tr>
                            <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle">4</td>
                            <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle">é é‹æ£„åœŸ</td>
                            <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle"></td>
                            <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle">mÂ³</td>
                            <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle">120.00</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- PRICE TAB -->
    <div id="price" class="tab-content">
        <h2 style="margin-bottom:12px;">ğŸ’° å–®åƒ¹åˆ†æè¡¨</h2>
        <div id="priceTablesContainer">
            <div class="empty-state">
                <div class="empty-state-icon">ğŸ’°</div>
                <h3>å°šæœªç”¢ç”Ÿå–®åƒ¹åˆ†æè¡¨</h3>
                <p>è«‹å…ˆåœ¨ã€Œå·¥ç¨‹è¨ˆç®—ç¨¿ç´™ã€é ç±¤ä¸­æ–°å¢é …ç›®</p>
            </div>
        </div>
    </div>

    <!-- å·¥ç¨‹é ç®—æ›¸åŸºæœ¬è³‡æ–™ -->
    <div id="basic" class="tab-content">
        <h3 class="section-title">å·¥ç¨‹é ç®—æ›¸åŸºæœ¬è³‡æ–™</h3>
        
        <div class="card" style="background:#fff;padding:18px;border-radius:10px;box-shadow:0 6px 14px rgba(0,0,0,.04);margin-bottom:16px">
            <div style="background:#f8f9fa;padding:12px;border-radius:8px;margin-bottom:12px;font-weight:700">ä¸»é«”å·¥ä½œè²»(å°è¨ˆ:)</div>
            <div class="action-buttons mb-3">
                <button class="btn btn-primary" id="collectProjectData">
                    <i class="fas fa-database me-2"></i>å·¥ç¨‹è³‡æ–™å½™é›†
                </button>
            </div>

<!-- æ·»åŠ é€™å€‹è¡¨æ ¼å®¹å™¨ï¼Œåˆå§‹ç‚ºéš±è— -->
        <div id="basicDataTableContainer" style="display:none;">
            <div style="overflow:auto">
                <table class="table" style="width:100%;border-collapse:collapse;margin-top:10px;background:#fff;border-radius:8px;overflow:hidden;box-shadow:0 4px 14px rgba(0,0,0,.06)" id="basicDataTable">
                    <thead>
                        <tr>
                            <th style="padding:12px 14px;text-align:left;font-weight:800;color:#fff;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%)">å·¥ç¨‹é …ç›®</th>
                            <th style="padding:12px 14px;text-align:left;font-weight:800;color:#fff;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%)">èªªæ˜</th>
                            <th style="padding:12px 14px;text-align:left;font-weight:800;color:#fff;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%)">å–®ä½</th>
                            <th style="padding:12px 14px;text-align:left;font-weight:800;color:#fff;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%)">æ•¸é‡</th>
                            <th style="padding:12px 14px;text-align:left;font-weight:800;color:#fff;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%)">é ç®—å–®åƒ¹</th>
                            <th style="padding:12px 14px;text-align:left;font-weight:800;color:#fff;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%)">é ç®—å·¥ç¨‹è²»</th>
                        </tr>
                    </thead>
                    <tbody id="basicDataTableBody">
                        <!-- é€™è£¡æœƒç”±JavaScriptå‹•æ…‹ç”Ÿæˆå…§å®¹ -->
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- ç©ºç‹€æ…‹æç¤º -->
        <div id="basicDataEmptyState" class="empty-state">
            <div class="empty-state-icon">ğŸ“‹</div>
            <h3>å°šæœªå½™é›†è³‡æ–™</h3>
            <p>è«‹é»æ“Šã€Œå·¥ç¨‹è³‡æ–™å½™é›†ã€æŒ‰éˆ•ï¼Œå¾å·¥ç¨‹è¨ˆç®—ç¨¿ç´™åŒ¯å…¥è³‡æ–™</p>
        </div>
            
           <div style="background:#f8f9fa;padding:12px;border-radius:8px;margin-bottom:12px;font-weight:700">
    è·æ¥­å®‰å…¨è¡›ç”Ÿè²»(å°è¨ˆ: <span id="safetySubtotal">0.00</span>)
    
    <!-- æ–°å¢æœå°‹åŠŸèƒ½ä»‹é¢ -->
    <div style="display:flex;gap:10px;margin-top:12px;align-items:center;">
        <div style="flex:1;position:relative">
            <div style="display:flex;gap:8px;">
                <div style="flex:1;position:relative">
                    <i class="fas fa-search" style="position:absolute;left:12px;top:50%;transform:translateY(-50%);color:#6c757d;z-index:1"></i>
                    <input type="text" 
                           placeholder="è¼¸å…¥å·¥æ–™åç¨±æˆ–ç·¨ç¢¼æœå°‹..." 
                           style="padding-left:40px;width:100%;border-radius:6px;border:1px solid #ddd;padding:10px 12px 10px 40px;background:#fff;font-size:14px;"
                           readonly>
                    <!-- ä¸‹æ‹‰é¸å–®ç¯„ä¾‹ -->
                    <div style="position:absolute;top:100%;left:0;right:0;background:white;border:1px solid #ddd;border-radius:6px;margin-top:4px;box-shadow:0 4px 12px rgba(0,0,0,0.1);display:none;z-index:1000;">
                        <div style="padding:10px 12px;background:#f8f9fa;border-bottom:1px solid #ddd;">
                            <strong>æœå°‹çµæœ (ç¤ºç¯„)</strong>
                        </div>
                        <div style="padding:8px 12px;border-bottom:1px solid #eee;cursor:pointer;background:#f0f8ff;">
                            <div><strong>å®‰å…¨è­¦ç¤ºç‡ˆ</strong> <span style="float:right;color:#28a745">$800.00</span></div>
                            <div style="font-size:12px;color:#666">å–®ä½ï¼šçµ„ | ç·¨ç¢¼ï¼šSAF001</div>
                        </div>
                        <div style="padding:8px 12px;border-bottom:1px solid #eee;cursor:pointer;">
                            <div><strong>äº¤é€šéŒ</strong> <span style="float:right;color:#28a745">$500.00</span></div>
                            <div style="font-size:12px;color:#666">å–®ä½ï¼šå€‹ | ç·¨ç¢¼ï¼šSAF002</div>
                        </div>
                        <div style="padding:8px 12px;border-bottom:1px solid #eee;cursor:pointer;">
                            <div><strong>å¤œé–“ç…§æ˜ç‡ˆå…·</strong> <span style="float:right;color:#28a745">$500.00</span></div>
                            <div style="font-size:12px;color:#666">å–®ä½ï¼šç› | ç·¨ç¢¼ï¼šSAF003</div>
                        </div>
                        <div style="padding:8px 12px;border-bottom:1px solid #eee;cursor:pointer;">
                            <div><strong>è­¦å‘Šæ¨™ç¤ºç‰Œ</strong> <span style="float:right;color:#28a745">$600.00</span></div>
                            <div style="font-size:12px;color:#666">å–®ä½ï¼šçµ„ | ç·¨ç¢¼ï¼šSAF004</div>
                        </div>
                        <div style="padding:10px 12px;text-align:center;background:#f8f9fa;color:#6c757d;font-size:12px;">
                            é»æ“Šé …ç›®å¯å¸¶å…¥åˆ—è¡¨
                        </div>
                    </div>
                </div>
                            </div>
            <div style="margin-top:8px;font-size:12px;color:#6c757d;display:flex;gap:12px;flex-wrap:wrap;">
                <span><i class="fas fa-info-circle"></i> å¯æœå°‹å–®åƒ¹è³‡æ–™åº«ç®¡ç†çš„å·¥æ–™é …ç›®</span>
                            </div>
        </div>
        <button class="btn btn-primary" style="white-space:nowrap;height:fit-content" disabled>
            <i class="fas fa-plus-circle"></i> æ–°å¢
        </button>
    </div>
</div>
    
    <div style="overflow:auto; margin-top:12px">
        <table class="table" style="width:100%;border-collapse:collapse;margin-top:10px;background:#fff;border-radius:8px;overflow:hidden;box-shadow:0 4px 14px rgba(0,0,0,.06)">
            <thead>
                <tr>
                    <th style="padding:12px 14px;text-align:left;font-weight:800;color:#fff;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%)">é¸æ“‡</th>
                    <th style="padding:12px 14px;text-align:left;font-weight:800;color:#fff;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%)">å·¥ç¨‹é …ç›®</th>
                    <th style="padding:12px 14px;text-align:left;font-weight:800;color:#fff;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%)">èªªæ˜</th>
                    <th style="padding:12px 14px;text-align:left;font-weight:800;color:#fff;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%)">å–®ä½</th>
                    <th style="padding:12px 14px;text-align:left;font-weight:800;color:#fff;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%)">æ•¸é‡</th>
                    <th style="padding:12px 14px;text-align:left;font-weight:800;color:#fff;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%)">é ç®—å–®åƒ¹</th>
                    <th style="padding:12px 14px;text-align:left;font-weight:800;color:#fff;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%)">é ç®—å·¥ç¨‹è²»</th>
                </tr>
            </thead>
            <tbody>
                <!-- å¤œé–“ç…§æ˜ç‡ˆå…· -->
                <tr>
                    <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle;text-align:center">
                        <button class="btn btn-danger btn-sm" onclick="removeSafetyItem('nightLight')" style="padding:4px 8px;font-size:12px">ğŸ—‘ï¸</button>
                    </td>
                    <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle">å¤œé–“ç…§æ˜ç‡ˆå…·</td>
                    <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle">æŠ˜èˆŠèˆ‡æè€—</td>
                    <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle">ç›</td>
                    <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle">
                        <input type="number" class="fee-qty safety-qty" value="1.00" step="0.01" min="0" 
                               style="width:70px;padding:4px;border:1px solid #ddd;border-radius:4px;text-align:center">
                    </td>
                    <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle" class="unit-price">500.00</td>
                    <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle" class="fee-amount safety-amount">500.00</td>
                </tr>
                <!-- äº¤é€šéŒ -->
                <tr>
                    <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle;text-align:center">
                      <button class="btn btn-danger btn-sm" onclick="removeSafetyItem('nightLight')" style="padding:4px 8px;font-size:12px">ğŸ—‘ï¸</button>

                    </td>
                    <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle">äº¤é€šéŒ</td>
                    <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle">æŠ˜èˆŠèˆ‡æè€—</td>
                    <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle">å€‹</td>
                    <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle">
                        <input type="number" class="fee-qty safety-qty" value="1.00" step="0.01" min="0" 
                               style="width:70px;padding:4px;border:1px solid #ddd;border-radius:4px;text-align:center">
                    </td>
                    <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle" class="unit-price">500.00</td>
                    <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle" class="fee-amount safety-amount">500.00</td>
                </tr>
                <!-- å®‰å…¨è­¦ç¤ºç‡ˆ -->
                <tr>
                    <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle;text-align:center">
                       <button class="btn btn-danger btn-sm" onclick="removeSafetyItem('nightLight')" style="padding:4px 8px;font-size:12px">ğŸ—‘ï¸</button>

                    </td>
                    <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle">å®‰å…¨è­¦ç¤ºç‡ˆ</td>
                    <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle">æŠ˜èˆŠèˆ‡æè€—</td>
                    <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle">çµ„</td>
                    <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle">
                        <input type="number" class="fee-qty safety-qty" value="1.00" step="0.01" min="0" 
                               style="width:70px;padding:4px;border:1px solid #ddd;border-radius:4px;text-align:center">
                    </td>
                    <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle" class="unit-price">800.00</td>
                    <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle" class="fee-amount safety-amount">800.00</td>
                </tr>
                <!-- è­¦å‘Šæ¨™ç¤ºç‰Œ -->
                <tr>
                    <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle;text-align:center">
                       <button class="btn btn-danger btn-sm" onclick="removeSafetyItem('nightLight')" style="padding:4px 8px;font-size:12px">ğŸ—‘ï¸</button>

                    </td>
                    <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle">è­¦å‘Šæ¨™ç¤ºç‰Œ</td>
                    <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle">æŠ˜èˆŠèˆ‡æè€—</td>
                    <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle">çµ„</td>
                    <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle">
                        <input type="number" class="fee-qty safety-qty" value="1.00" step="0.01" min="0" 
                               style="width:70px;padding:4px;border:1px solid #ddd;border-radius:4px;text-align:center">
                    </td>
                    <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle" class="unit-price">600.00</td>
                    <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle" class="fee-amount safety-amount">600.00</td>
                </tr>
                <!-- å®‰å…¨å¸½ -->
                <tr>
                    <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle;text-align:center">
                       <button class="btn btn-danger btn-sm" onclick="removeSafetyItem('nightLight')" style="padding:4px 8px;font-size:12px">ğŸ—‘ï¸</button>

                    </td>
                    <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle">å®‰å…¨å¸½</td>
                    <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle">æŠ˜èˆŠèˆ‡æè€—</td>
                    <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle">çµ„</td>
                    <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle">
                        <input type="number" class="fee-qty safety-qty" value="1.00" step="0.01" min="0" 
                               style="width:70px;padding:4px;border:1px solid #ddd;border-radius:4px;text-align:center">
                    </td>
                    <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle" class="unit-price">600.00</td>
                    <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle" class="fee-amount safety-amount">600.00</td>
                </tr>
                <!-- é»ƒè‰²è­¦ç¤ºå¸¶ -->
                <tr>
                    <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle;text-align:center">
                       <button class="btn btn-danger btn-sm" onclick="removeSafetyItem('nightLight')" style="padding:4px 8px;font-size:12px">ğŸ—‘ï¸</button>

                    </td>
                    <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle">é»ƒè‰²è­¦ç¤ºå¸¶</td>
                    <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle">æŠ˜èˆŠèˆ‡æè€—</td>
                    <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle">çµ„</td>
                    <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle">
                        <input type="number" class="fee-qty safety-qty" value="1.00" step="0.01" min="0" 
                               style="width:70px;padding:4px;border:1px solid #ddd;border-radius:4px;text-align:center">
                    </td>
                    <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle" class="unit-price">600.00</td>
                    <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle" class="fee-amount safety-amount">600.00</td>
                </tr>
                <!-- è·æ¥­å®‰å…¨æ•™è‚²è¬›ç¿’ -->
                <tr>
                    <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle;text-align:center">
                        <button class="btn btn-danger btn-sm" onclick="removeSafetyItem('nightLight')" style="padding:4px 8px;font-size:12px">ğŸ—‘ï¸</button>

                    </td>
                    <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle">è·æ¥­å®‰å…¨æ•™è‚²è¬›ç¿’</td>
                    <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle">æŠ˜èˆŠèˆ‡æè€—</td>
                    <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle">çµ„</td>
                    <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle">
                        <input type="number" class="fee-qty safety-qty" value="1.00" step="0.01" min="0" 
                               style="width:70px;padding:4px;border:1px solid #ddd;border-radius:4px;text-align:center">
                    </td>
                    <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle" class="unit-price">600.00</td>
                    <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle" class="fee-amount safety-amount">600.00</td>
                </tr>
                <!-- å…¶ä»–å®‰è¡›è¨­æ–½åŠç®¡ç†ç¶­è­·è²» -->
                <tr>
                    <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle;text-align:center">
                       <button class="btn btn-danger btn-sm" onclick="removeSafetyItem('nightLight')" style="padding:4px 8px;font-size:12px">ğŸ—‘ï¸</button>

                    </td>
                    <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle">å…¶ä»–å®‰è¡›è¨­æ–½åŠç®¡ç†ç¶­è­·è²»</td>
                    <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle">æŠ˜èˆŠèˆ‡æè€—</td>
                    <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle">çµ„</td>
                    <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle">
                        <input type="number" class="fee-qty safety-qty" value="1.00" step="0.01" min="0" 
                               style="width:70px;padding:4px;border:1px solid #ddd;border-radius:4px;text-align:center">
                    </td>
                    <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle" class="unit-price">600.00</td>
                    <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle" class="fee-amount safety-amount">600.00</td>
                </tr>
            </tbody>
        </table>
    </div>
</div>
            
<!-- ç’°å¢ƒä¿è­·æªæ–½è²»éƒ¨åˆ† - ä¿®æ”¹å¾Œ -->
<div class="card mt-4" style="background:#fff;padding:18px;border-radius:10px;box-shadow:0 6px 14px rgba(0,0,0,.04);margin-bottom:16px">
    <div style="background:#f8f9fa;padding:12px;border-radius:8px;margin-bottom:12px;font-weight:700">ç’°å¢ƒä¿è­·æªæ–½è²»(å°è¨ˆ:)</div>

<!-- æ–°å¢æœå°‹åŠŸèƒ½ä»‹é¢ -->
    <div style="display:flex;gap:10px;margin-top:12px;align-items:center;">
        <div style="flex:1;position:relative">
            <div style="display:flex;gap:8px;">
                <div style="flex:1;position:relative">
                    <i class="fas fa-search" style="position:absolute;left:12px;top:50%;transform:translateY(-50%);color:#6c757d;z-index:1"></i>
                    <input type="text" 
                           placeholder="è¼¸å…¥å·¥æ–™åç¨±æˆ–ç·¨ç¢¼æœå°‹..." 
                           style="padding-left:40px;width:100%;border-radius:6px;border:1px solid #ddd;padding:10px 12px 10px 40px;background:#fff;font-size:14px;"
                           readonly>
                    <!-- ä¸‹æ‹‰é¸å–®ç¯„ä¾‹ -->
                    <div style="position:absolute;top:100%;left:0;right:0;background:white;border:1px solid #ddd;border-radius:6px;margin-top:4px;box-shadow:0 4px 12px rgba(0,0,0,0.1);display:none;z-index:1000;">
                        <div style="padding:10px 12px;background:#f8f9fa;border-bottom:1px solid #ddd;">
                            <strong>æœå°‹çµæœ (ç¤ºç¯„)</strong>
                        </div>
                        <div style="padding:8px 12px;border-bottom:1px solid #eee;cursor:pointer;background:#f0f8ff;">
                            <div><strong>å®‰å…¨è­¦ç¤ºç‡ˆ</strong> <span style="float:right;color:#28a745">$800.00</span></div>
                            <div style="font-size:12px;color:#666">å–®ä½ï¼šçµ„ | ç·¨ç¢¼ï¼šSAF001</div>
                        </div>
                        <div style="padding:8px 12px;border-bottom:1px solid #eee;cursor:pointer;">
                            <div><strong>äº¤é€šéŒ</strong> <span style="float:right;color:#28a745">$500.00</span></div>
                            <div style="font-size:12px;color:#666">å–®ä½ï¼šå€‹ | ç·¨ç¢¼ï¼šSAF002</div>
                        </div>
                        <div style="padding:8px 12px;border-bottom:1px solid #eee;cursor:pointer;">
                            <div><strong>å¤œé–“ç…§æ˜ç‡ˆå…·</strong> <span style="float:right;color:#28a745">$500.00</span></div>
                            <div style="font-size:12px;color:#666">å–®ä½ï¼šç› | ç·¨ç¢¼ï¼šSAF003</div>
                        </div>
                        <div style="padding:8px 12px;border-bottom:1px solid #eee;cursor:pointer;">
                            <div><strong>è­¦å‘Šæ¨™ç¤ºç‰Œ</strong> <span style="float:right;color:#28a745">$600.00</span></div>
                            <div style="font-size:12px;color:#666">å–®ä½ï¼šçµ„ | ç·¨ç¢¼ï¼šSAF004</div>
                        </div>
                        <div style="padding:10px 12px;text-align:center;background:#f8f9fa;color:#6c757d;font-size:12px;">
                            é»æ“Šé …ç›®å¯å¸¶å…¥åˆ—è¡¨
                        </div>
                    </div>
                </div>
                            </div>
            <div style="margin-top:8px;font-size:12px;color:#6c757d;display:flex;gap:12px;flex-wrap:wrap;">
                <span><i class="fas fa-info-circle"></i> å¯æœå°‹å–®åƒ¹è³‡æ–™åº«ç®¡ç†çš„å·¥æ–™é …ç›®</span>
                            </div>
        </div>
        <button class="btn btn-primary" style="white-space:nowrap;height:fit-content" disabled>
            <i class="fas fa-plus-circle"></i> æ–°å¢
        </button>
    </div>

    
    <div style="overflow:auto; margin-top:12px">
        <table class="table" style="width:100%;border-collapse:collapse;margin-top:10px;background:#fff;border-radius:8px;overflow:hidden;box-shadow:0 4px 14px rgba(0,0,0,.06)">
            <thead>
                <tr>
                    <th style="padding:12px 14px;text-align:left;font-weight:800;color:#fff;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%)">é¸æ“‡</th>
                    <th style="padding:12px 14px;text-align:left;font-weight:800;color:#fff;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%)">å·¥ç¨‹é …ç›®</th>
                    <th style="padding:12px 14px;text-align:left;font-weight:800;color:#fff;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%)">èªªæ˜</th>
                    <th style="padding:12px 14px;text-align:left;font-weight:800;color:#fff;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%)">å–®ä½</th>
                    <th style="padding:12px 14px;text-align:left;font-weight:800;color:#fff;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%)">æ•¸é‡</th>
                    <th style="padding:12px 14px;text-align:left;font-weight:800;color:#fff;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%)">é ç®—å–®åƒ¹</th>
                    <th style="padding:12px 14px;text-align:left;font-weight:800;color:#fff;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%)">é ç®—å·¥ç¨‹è²»</th>
                </tr>
            </thead>
            <tbody>
                <!-- ç’°ä¿ç®¡ç†äººå“¡äººäº‹è²» -->
                <tr>
                   <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle;text-align:center">
                        <button class="btn btn-danger btn-sm" onclick="removeSafetyItem('nightLight')" style="padding:4px 8px;font-size:12px">ğŸ—‘ï¸</button>

                    </td>
                    <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle">ç’°ä¿ç®¡ç†äººå“¡äººäº‹è²»</td>
                    <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle"></td>
                    <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle">å…¨</td>
                    <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle">
                        <input type="number" class="fee-qty env-qty" value="1" step="1" min="0" 
                               style="width:70px;padding:4px;border:1px solid #ddd;border-radius:4px;text-align:center">
                    </td>
                    <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle" class="unit-price">2,500.00</td>
                    <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle" class="fee-amount env-amount">2,500.00</td>
                </tr>
                <!-- ç’°ä¿è¨“ç·´è¬›ç¿’å®£å°è²» -->
                <tr>
                    <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle;text-align:center">
                        <button class="btn btn-danger btn-sm" onclick="removeSafetyItem('nightLight')" style="padding:4px 8px;font-size:12px">ğŸ—‘ï¸</button>

                    </td>
                    <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle">ç’°ä¿è¨“ç·´è¬›ç¿’å®£å°è²»</td>
                    <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle"></td>
                    <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle">å…¨</td>
                    <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle">
                        <input type="number" class="fee-qty env-qty" value="1" step="1" min="0" 
                               style="width:70px;padding:4px;border:1px solid #ddd;border-radius:4px;text-align:center">
                    </td>
                    <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle" class="unit-price">2,500.00</td>
                    <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle" class="fee-amount env-amount">2,500.00</td>
                </tr>
                <!-- å·¥åœ°æ¸…æ½”è²» -->
                <tr>
                   <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle;text-align:center">
                        <button class="btn btn-danger btn-sm" onclick="removeSafetyItem('nightLight')" style="padding:4px 8px;font-size:12px">ğŸ—‘ï¸</button>

                    </td>
                    <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle">å·¥åœ°æ¸…æ½”è²»</td>
                    <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle"></td>
                    <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle">å…¨</td>
                    <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle">
                        <input type="number" class="fee-qty env-qty" value="1" step="1" min="0" 
                               style="width:70px;padding:4px;border:1px solid #ddd;border-radius:4px;text-align:center">
                    </td>
                    <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle" class="unit-price">2,500.00</td>
                    <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle" class="fee-amount env-amount">2,500.00</td>
                </tr>
                <!-- å·¥åœ°ç‘æ°´è²» -->
                <tr>
                    <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle;text-align:center">
                        <button class="btn btn-danger btn-sm" onclick="removeSafetyItem('nightLight')" style="padding:4px 8px;font-size:12px">ğŸ—‘ï¸</button>

                    </td>
                    <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle">å·¥åœ°ç‘æ°´è²»</td>
                    <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle"></td>
                    <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle">å…¨</td>
                    <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle">
                        <input type="number" class="fee-qty env-qty" value="1" step="1" min="0" 
                               style="width:70px;padding:4px;border:1px solid #ddd;border-radius:4px;text-align:center">
                    </td>
                    <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle" class="unit-price">2,500.00</td>
                    <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle" class="fee-amount env-amount">2,500.00</td>
                </tr>
                <!-- å™ªéŸ³é˜²åˆ¶è²» -->
                <tr>
                   <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle;text-align:center">
                        <button class="btn btn-danger btn-sm" onclick="removeSafetyItem('nightLight')" style="padding:4px 8px;font-size:12px">ğŸ—‘ï¸</button>

                    </td>
                    <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle">å™ªéŸ³é˜²åˆ¶è²»</td>
                    <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle"></td>
                    <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle">å…¨</td>
                    <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle">
                        <input type="number" class="fee-qty env-qty" value="1" step="1" min="0" 
                               style="width:70px;padding:4px;border:1px solid #ddd;border-radius:4px;text-align:center">
                    </td>
                    <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle" class="unit-price">2,500.00</td>
                    <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle" class="fee-amount env-amount">2,500.00</td>
                </tr>
                <!-- æ´—è»Šè¨­å‚™æ±¡æ³¥æ¸…é™¤è²» -->
                <tr>
                   <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle;text-align:center">
                        <button class="btn btn-danger btn-sm" onclick="removeSafetyItem('nightLight')" style="padding:4px 8px;font-size:12px">ğŸ—‘ï¸</button>

                    </td>
                    <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle">æ´—è»Šè¨­å‚™æ±¡æ³¥æ¸…é™¤è²»</td>
                    <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle"></td>
                    <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle">å…¨</td>
                    <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle">
                        <input type="number" class="fee-qty env-qty" value="1" step="1" min="0" 
                               style="width:70px;padding:4px;border:1px solid #ddd;border-radius:4px;text-align:center">
                    </td>
                    <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle" class="unit-price">2,500.00</td>
                    <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle" class="fee-amount env-amount">2,500.00</td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<!-- å» å•†å“è³ªç®¡åˆ¶ä½œæ¥­è²» -->
<div class="card mt-4" style="background:#fff;padding:18px;border-radius:10px;box-shadow:0 6px 14px rgba(0,0,0,.04);margin-bottom:16px">
    <div style="background:#f8f9fa;padding:12px;border-radius:8px;margin-bottom:12px;font-weight:700">å» å•†å“è³ªç®¡åˆ¶ä½œæ¥­è²»(å°è¨ˆ:)</div>
    
    <div style="margin-bottom:15px; padding:10px; background:#f0f8ff; border-radius:8px;">
        <h4 style="color:#2c3e50; margin-bottom:8px; font-weight:600">æª¢é©—è²»</h4>
<!-- æ–°å¢æœå°‹åŠŸèƒ½ä»‹é¢ -->
    <div style="display:flex;gap:10px;margin-top:12px;align-items:center;">
        <div style="flex:1;position:relative">
            <div style="display:flex;gap:8px;">
                <div style="flex:1;position:relative">
                    <i class="fas fa-search" style="position:absolute;left:12px;top:50%;transform:translateY(-50%);color:#6c757d;z-index:1"></i>
                    <input type="text" 
                           placeholder="è¼¸å…¥å·¥æ–™åç¨±æˆ–ç·¨ç¢¼æœå°‹..." 
                           style="padding-left:40px;width:100%;border-radius:6px;border:1px solid #ddd;padding:10px 12px 10px 40px;background:#fff;font-size:14px;"
                           readonly>
                    <!-- ä¸‹æ‹‰é¸å–®ç¯„ä¾‹ -->
                    <div style="position:absolute;top:100%;left:0;right:0;background:white;border:1px solid #ddd;border-radius:6px;margin-top:4px;box-shadow:0 4px 12px rgba(0,0,0,0.1);display:none;z-index:1000;">
                        <div style="padding:10px 12px;background:#f8f9fa;border-bottom:1px solid #ddd;">
                            <strong>æœå°‹çµæœ (ç¤ºç¯„)</strong>
                        </div>
                        <div style="padding:8px 12px;border-bottom:1px solid #eee;cursor:pointer;background:#f0f8ff;">
                            <div><strong>å®‰å…¨è­¦ç¤ºç‡ˆ</strong> <span style="float:right;color:#28a745">$800.00</span></div>
                            <div style="font-size:12px;color:#666">å–®ä½ï¼šçµ„ | ç·¨ç¢¼ï¼šSAF001</div>
                        </div>
                        <div style="padding:8px 12px;border-bottom:1px solid #eee;cursor:pointer;">
                            <div><strong>äº¤é€šéŒ</strong> <span style="float:right;color:#28a745">$500.00</span></div>
                            <div style="font-size:12px;color:#666">å–®ä½ï¼šå€‹ | ç·¨ç¢¼ï¼šSAF002</div>
                        </div>
                        <div style="padding:8px 12px;border-bottom:1px solid #eee;cursor:pointer;">
                            <div><strong>å¤œé–“ç…§æ˜ç‡ˆå…·</strong> <span style="float:right;color:#28a745">$500.00</span></div>
                            <div style="font-size:12px;color:#666">å–®ä½ï¼šç› | ç·¨ç¢¼ï¼šSAF003</div>
                        </div>
                        <div style="padding:8px 12px;border-bottom:1px solid #eee;cursor:pointer;">
                            <div><strong>è­¦å‘Šæ¨™ç¤ºç‰Œ</strong> <span style="float:right;color:#28a745">$600.00</span></div>
                            <div style="font-size:12px;color:#666">å–®ä½ï¼šçµ„ | ç·¨ç¢¼ï¼šSAF004</div>
                        </div>
                        <div style="padding:10px 12px;text-align:center;background:#f8f9fa;color:#6c757d;font-size:12px;">
                            é»æ“Šé …ç›®å¯å¸¶å…¥åˆ—è¡¨
                        </div>
                    </div>
                </div>
                            </div>
            <div style="margin-top:8px;font-size:12px;color:#6c757d;display:flex;gap:12px;flex-wrap:wrap;">
                <span><i class="fas fa-info-circle"></i> å¯æœå°‹å–®åƒ¹è³‡æ–™åº«ç®¡ç†çš„å·¥æ–™é …ç›®</span>
                            </div>
        </div>
        <button class="btn btn-primary" style="white-space:nowrap;height:fit-content" disabled>
            <i class="fas fa-plus-circle"></i> æ–°å¢
        </button>
    </div>


    </div>
    
    <div style="overflow:auto; margin-top:12px">
        <table class="table" style="width:100%;border-collapse:collapse;margin-top:10px;background:#fff;border-radius:8px;overflow:hidden;box-shadow:0 4px 14px rgba(0,0,0,.06)">
            <thead>
                <tr>
                    <th style="padding:12px 14px;text-align:left;font-weight:800;color:#fff;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%)">é¸æ“‡</th>
                    <th style="padding:12px 14px;text-align:left;font-weight:800;color:#fff;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%)">å·¥ç¨‹é …ç›®</th>
                    <th style="padding:12px 14px;text-align:left;font-weight:800;color:#fff;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%)">èªªæ˜</th>
                    <th style="padding:12px 14px;text-align:left;font-weight:800;color:#fff;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%)">å–®ä½</th>
                    <th style="padding:12px 14px;text-align:left;font-weight:800;color:#fff;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%)">æ•¸é‡</th>
                    <th style="padding:12px 14px;text-align:left;font-weight:800;color:#fff;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%)">é ç®—å–®åƒ¹</th>
                    <th style="padding:12px 14px;text-align:left;font-weight:800;color:#fff;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%)">é ç®—å·¥ç¨‹è²»</th>
                </tr>
            </thead>
            <tbody>
                <!-- æ··å‡åœŸååº¦è©¦é©— -->
                <tr>
                   <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle;text-align:center">
                        <button class="btn btn-danger btn-sm" onclick="removeSafetyItem('nightLight')" style="padding:4px 8px;font-size:12px">ğŸ—‘ï¸</button>

                    </td>
                    <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle">æ··å‡åœŸååº¦è©¦é©—</td>
                    <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle">ææ–™æª¢é©—</td>
                    <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle">çµ„</td>
                    <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle">
                        <input type="number" class="fee-qty quality-qty" value="1.00" step="0.01" min="0" 
                               style="width:70px;padding:4px;border:1px solid #ddd;border-radius:4px;text-align:center">
                    </td>
                    <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle" class="unit-price">1,200.00</td>
                    <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle" class="fee-amount quality-amount">1,200.00</td>
                </tr>
                <!-- åœ“æŸ±è©¦é«”å¼·åº¦è©¦é©— -->
                <tr>
                    <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle;text-align:center">
                        <button class="btn btn-danger btn-sm" onclick="removeSafetyItem('nightLight')" style="padding:4px 8px;font-size:12px">ğŸ—‘ï¸</button>

                    </td>
                    <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle">åœ“æŸ±è©¦é«”å¼·åº¦è©¦é©—</td>
                    <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle">ææ–™æª¢é©—</td>
                    <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle">çµ„</td>
                    <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle">
                        <input type="number" class="fee-qty quality-qty" value="1.00" step="0.01" min="0" 
                               style="width:70px;padding:4px;border:1px solid #ddd;border-radius:4px;text-align:center">
                    </td>
                    <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle" class="unit-price">1,500.00</td>
                    <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle" class="fee-amount quality-amount">1,500.00</td>
                </tr>
                <!-- é‘½å¿ƒè©¦é«”å¼·åº¦è©¦é©— -->
                <tr>
                    <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle;text-align:center">
                        <button class="btn btn-danger btn-sm" onclick="removeSafetyItem('nightLight')" style="padding:4px 8px;font-size:12px">ğŸ—‘ï¸</button>

                    </td>
                    <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle">é‘½å¿ƒè©¦é«”å¼·åº¦è©¦é©—</td>
                    <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle">ææ–™æª¢é©—</td>
                    <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle">çµ„</td>
                    <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle">
                        <input type="number" class="fee-qty quality-qty" value="1.00" step="0.01" min="0" 
                               style="width:70px;padding:4px;border:1px solid #ddd;border-radius:4px;text-align:center">
                    </td>
                    <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle" class="unit-price">2,000.00</td>
                    <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle" class="fee-amount quality-amount">2,000.00</td>
                </tr>
            </tbody>
        </table>
    </div>
    
    <div style="margin:20px 0 15px 0; padding:10px; background:#f0f8ff; border-radius:8px;">
        <h4 style="color:#2c3e50; margin-bottom:8px; font-weight:600">å“ç®¡ä½œæ¥­è²»</h4>
<!-- æ–°å¢æœå°‹åŠŸèƒ½ä»‹é¢ -->
    <div style="display:flex;gap:10px;margin-top:12px;align-items:center;">
        <div style="flex:1;position:relative">
            <div style="display:flex;gap:8px;">
                <div style="flex:1;position:relative">
                    <i class="fas fa-search" style="position:absolute;left:12px;top:50%;transform:translateY(-50%);color:#6c757d;z-index:1"></i>
                    <input type="text" 
                           placeholder="è¼¸å…¥å·¥æ–™åç¨±æˆ–ç·¨ç¢¼æœå°‹..." 
                           style="padding-left:40px;width:100%;border-radius:6px;border:1px solid #ddd;padding:10px 12px 10px 40px;background:#fff;font-size:14px;"
                           readonly>
                    <!-- ä¸‹æ‹‰é¸å–®ç¯„ä¾‹ -->
                    <div style="position:absolute;top:100%;left:0;right:0;background:white;border:1px solid #ddd;border-radius:6px;margin-top:4px;box-shadow:0 4px 12px rgba(0,0,0,0.1);display:none;z-index:1000;">
                        <div style="padding:10px 12px;background:#f8f9fa;border-bottom:1px solid #ddd;">
                            <strong>æœå°‹çµæœ (ç¤ºç¯„)</strong>
                        </div>
                        <div style="padding:8px 12px;border-bottom:1px solid #eee;cursor:pointer;background:#f0f8ff;">
                            <div><strong>å®‰å…¨è­¦ç¤ºç‡ˆ</strong> <span style="float:right;color:#28a745">$800.00</span></div>
                            <div style="font-size:12px;color:#666">å–®ä½ï¼šçµ„ | ç·¨ç¢¼ï¼šSAF001</div>
                        </div>
                        <div style="padding:8px 12px;border-bottom:1px solid #eee;cursor:pointer;">
                            <div><strong>äº¤é€šéŒ</strong> <span style="float:right;color:#28a745">$500.00</span></div>
                            <div style="font-size:12px;color:#666">å–®ä½ï¼šå€‹ | ç·¨ç¢¼ï¼šSAF002</div>
                        </div>
                        <div style="padding:8px 12px;border-bottom:1px solid #eee;cursor:pointer;">
                            <div><strong>å¤œé–“ç…§æ˜ç‡ˆå…·</strong> <span style="float:right;color:#28a745">$500.00</span></div>
                            <div style="font-size:12px;color:#666">å–®ä½ï¼šç› | ç·¨ç¢¼ï¼šSAF003</div>
                        </div>
                        <div style="padding:8px 12px;border-bottom:1px solid #eee;cursor:pointer;">
                            <div><strong>è­¦å‘Šæ¨™ç¤ºç‰Œ</strong> <span style="float:right;color:#28a745">$600.00</span></div>
                            <div style="font-size:12px;color:#666">å–®ä½ï¼šçµ„ | ç·¨ç¢¼ï¼šSAF004</div>
                        </div>
                        <div style="padding:10px 12px;text-align:center;background:#f8f9fa;color:#6c757d;font-size:12px;">
                            é»æ“Šé …ç›®å¯å¸¶å…¥åˆ—è¡¨
                        </div>
                    </div>
                </div>
                            </div>
            <div style="margin-top:8px;font-size:12px;color:#6c757d;display:flex;gap:12px;flex-wrap:wrap;">
                <span><i class="fas fa-info-circle"></i> å¯æœå°‹å–®åƒ¹è³‡æ–™åº«ç®¡ç†çš„å·¥æ–™é …ç›®</span>
                            </div>
        </div>
        <button class="btn btn-primary" style="white-space:nowrap;height:fit-content" disabled>
            <i class="fas fa-plus-circle"></i> æ–°å¢
        </button>
    </div>

    </div>
    
    <div style="overflow:auto; margin-top:12px">
        <table class="table" style="width:100%;border-collapse:collapse;margin-top:10px;background:#fff;border-radius:8px;overflow:hidden;box-shadow:0 4px 14px rgba(0,0,0,.06)">
            <thead>
                <tr>
                    <th style="padding:12px 14px;text-align:left;font-weight:800;color:#fff;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%)">é¸æ“‡</th>
                    <th style="padding:12px 14px;text-align:left;font-weight:800;color:#fff;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%)">å·¥ç¨‹é …ç›®</th>
                    <th style="padding:12px 14px;text-align:left;font-weight:800;color:#fff;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%)">èªªæ˜</th>
                    <th style="padding:12px 14px;text-align:left;font-weight:800;color:#fff;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%)">å–®ä½</th>
                    <th style="padding:12px 14px;text-align:left;font-weight:800;color:#fff;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%)">æ•¸é‡</th>
                    <th style="padding:12px 14px;text-align:left;font-weight:800;color:#fff;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%)">é ç®—å–®åƒ¹</th>
                    <th style="padding:12px 14px;text-align:left;font-weight:800;color:#fff;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%)">é ç®—å·¥ç¨‹è²»</th>
                </tr>
            </thead>
            <tbody>
                <!-- å“è³ªç®¡ç† -->
                <tr>
                    <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle;text-align:center">
                        <button class="btn btn-danger btn-sm" onclick="removeSafetyItem('nightLight')" style="padding:4px 8px;font-size:12px">ğŸ—‘ï¸</button>

                    </td>
                    <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle">å“è³ªç®¡ç†</td>
                    <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle">å“ç®¡ä½œæ¥­</td>
                    <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle">å¼</td>
                    <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle">
                        <input type="number" class="fee-qty quality-qty" value="1.00" step="0.01" min="0" 
                               style="width:70px;padding:4px;border:1px solid #ddd;border-radius:4px;text-align:center">
                    </td>
                    <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle" class="unit-price">5,000.00</td>
                    <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle" class="fee-amount quality-amount">5,000.00</td>
                </tr>
                <!-- è‡ªä¸»æª¢æŸ¥ -->
                <tr>
                   <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle;text-align:center">
                        <button class="btn btn-danger btn-sm" onclick="removeSafetyItem('nightLight')" style="padding:4px 8px;font-size:12px">ğŸ—‘ï¸</button>

                    </td>
                    <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle">è‡ªä¸»æª¢æŸ¥</td>
                    <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle">å“ç®¡ä½œæ¥­</td>
                    <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle">å¼</td>
                    <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle">
                        <input type="number" class="fee-qty quality-qty" value="1.00" step="0.01" min="0" 
                               style="width:70px;padding:4px;border:1px solid #ddd;border-radius:4px;text-align:center">
                    </td>
                    <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle" class="unit-price">3,000.00</td>
                    <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle" class="fee-amount quality-amount">3,000.00</td>
                </tr>
                <!-- æ–‡ä»¶è¨˜éŒ„ç®¡ç† -->
                <tr>
                    <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle;text-align:center">
                        <button class="btn btn-danger btn-sm" onclick="removeSafetyItem('nightLight')" style="padding:4px 8px;font-size:12px">ğŸ—‘ï¸</button>

                    </td>
                    <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle">æ–‡ä»¶è¨˜éŒ„ç®¡ç†</td>
                    <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle">å“ç®¡ä½œæ¥­</td>
                    <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle">å¼</td>
                    <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle">
                        <input type="number" class="fee-qty quality-qty" value="1.00" step="0.01" min="0" 
                               style="width:70px;padding:4px;border:1px solid #ddd;border-radius:4px;text-align:center">
                    </td>
                    <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle" class="unit-price">2,000.00</td>
                    <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle" class="fee-amount quality-amount">2,000.00</td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<!-- å» å•†ç®¡ç†è²» -->
<div class="card mt-4" style="background:#fff;padding:18px;border-radius:10px;box-shadow:0 6px 14px rgba(0,0,0,.04);margin-bottom:16px">
    <div style="background:#f8f9fa;padding:12px;border-radius:8px;margin-bottom:12px;font-weight:700">å» å•†ç®¡ç†è²»(å°è¨ˆ:)</div>
    
    <div style="overflow:auto; margin-top:12px">
        <table class="table" style="width:100%;border-collapse:collapse;margin-top:10px;background:#fff;border-radius:8px;overflow:hidden;box-shadow:0 4px 14px rgba(0,0,0,.06)">
            <thead>
                <tr>
                                       <th style="padding:12px 14px;text-align:left;font-weight:800;color:#fff;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%)">å·¥ç¨‹é …ç›®</th>
                    <th style="padding:12px 14px;text-align:left;font-weight:800;color:#fff;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%)">èªªæ˜</th>
                    <th style="padding:12px 14px;text-align:left;font-weight:800;color:#fff;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%)">å–®ä½</th>
                    <th style="padding:12px 14px;text-align:left;font-weight:800;color:#fff;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%)">æ•¸é‡</th>
                    <th style="padding:12px 14px;text-align:left;font-weight:800;color:#fff;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%)">é ç®—å–®åƒ¹</th>
                    <th style="padding:12px 14px;text-align:left;font-weight:800;color:#fff;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%)">é ç®—å·¥ç¨‹è²»</th>
                </tr>
            </thead>
            <tbody>
                <!-- å» å•†ç®¡ç†è²» -->
                <tr>
                                        </td>
                    <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle">å» å•†ç®¡ç†è²»</td>
                    <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle">
        <input type="text" class="pollution-description" value="å·¥ç¨‹ç®¡ç†ä½œæ¥­è²»" 
               style="width:100%;padding:4px;border:1px solid #ddd;border-radius:4px">
    </td>

                    <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle">å¼</td>
                    <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle">
                        <input type="number" class="fee-qty management-qty" value="1.00" step="0.01" min="0" 
                               style="width:70px;padding:4px;border:1px solid #ddd;border-radius:4px;text-align:center">
                    </td>
                    <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle" class="unit-price">10,000.00</td>
                    <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle" class="fee-amount management-amount">10,000.00</td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<!-- å·¥ç¨‹ä¿éšªè²» -->
<div class="card mt-4" style="background:#fff;padding:18px;border-radius:10px;box-shadow:0 6px 14px rgba(0,0,0,.04);margin-bottom:16px">
    <div style="background:#f8f9fa;padding:12px;border-radius:8px;margin-bottom:12px;font-weight:700">å·¥ç¨‹ä¿éšªè²»(å°è¨ˆ:)</div>
    
    <div style="overflow:auto; margin-top:12px">
        <table class="table" style="width:100%;border-collapse:collapse;margin-top:10px;background:#fff;border-radius:8px;overflow:hidden;box-shadow:0 4px 14px rgba(0,0,0,.06)">
            <thead>
                <tr>
                                       <th style="padding:12px 14px;text-align:left;font-weight:800;color:#fff;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%)">å·¥ç¨‹é …ç›®</th>
                    <th style="padding:12px 14px;text-align:left;font-weight:800;color:#fff;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%)">èªªæ˜</th>
                    <th style="padding:12px 14px;text-align:left;font-weight:800;color:#fff;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%)">å–®ä½</th>
                    <th style="padding:12px 14px;text-align:left;font-weight:800;color:#fff;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%)">æ•¸é‡</th>
                    <th style="padding:12px 14px;text-align:left;font-weight:800;color:#fff;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%)">é ç®—å–®åƒ¹</th>
                    <th style="padding:12px 14px;text-align:left;font-weight:800;color:#fff;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%)">é ç®—å·¥ç¨‹è²»</th>
                </tr>
            </thead>
            <tbody>
                <!-- å·¥ç¨‹ä¿éšªè²» -->
                <tr>
                                        <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle">å·¥ç¨‹ä¿éšªè²»</td>
                  <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle">
        <input type="text" class="pollution-description" value="å·¥ç¨‹ä¿éšªè²»" 
               style="width:100%;padding:4px;border:1px solid #ddd;border-radius:4px">
    </td>

                    <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle">å¼</td>
                    <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle">
                        <input type="number" class="fee-qty insurance-qty" value="1.00" step="0.01" min="0" 
                               style="width:70px;padding:4px;border:1px solid #ddd;border-radius:4px;text-align:center">
                    </td>
                    <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle" class="unit-price">8,000.00</td>
                    <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle" class="fee-amount insurance-amount">8,000.00</td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<!-- ç‡Ÿæ¥­ç¨… -->
<div class="card mt-4" style="background:#fff;padding:18px;border-radius:10px;box-shadow:0 6px 14px rgba(0,0,0,.04);margin-bottom:16px">
    <div style="background:#f8f9fa;padding:12px;border-radius:8px;margin-bottom:12px;font-weight:700">ç‡Ÿæ¥­ç¨…(å°è¨ˆ:)</div>
    
    <div style="overflow:auto; margin-top:12px">
        <table class="table" style="width:100%;border-collapse:collapse;margin-top:10px;background:#fff;border-radius:8px;overflow:hidden;box-shadow:0 4px 14px rgba(0,0,0,.06)">
            <thead>
                <tr>
                                       <th style="padding:12px 14px;text-align:left;font-weight:800;color:#fff;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%)">å·¥ç¨‹é …ç›®</th>
                    <th style="padding:12px 14px;text-align:left;font-weight:800;color:#fff;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%)">èªªæ˜</th>
                    <th style="padding:12px 14px;text-align:left;font-weight:800;color:#fff;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%)">å–®ä½</th>
                    <th style="padding:12px 14px;text-align:left;font-weight:800;color:#fff;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%)">æ•¸é‡</th>
                    <th style="padding:12px 14px;text-align:left;font-weight:800;color:#fff;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%)">é ç®—å–®åƒ¹</th>
                    <th style="padding:12px 14px;text-align:left;font-weight:800;color:#fff;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%)">é ç®—å·¥ç¨‹è²»</th>
                </tr>
            </thead>
            <tbody>
                <!-- ç‡Ÿæ¥­ç¨… -->
                <tr>
                                        <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle">ç‡Ÿæ¥­ç¨…</td>
                     <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle">
        <input type="text" class="pollution-description" value="å·¥ç¨‹ç¸½é¡5%" 
               style="width:100%;padding:4px;border:1px solid #ddd;border-radius:4px">
    </td>

                    <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle">å¼</td>
                    <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle">
                        <input type="number" class="fee-qty tax-qty" value="1.00" step="0.01" min="0" 
                               style="width:70px;padding:4px;border:1px solid #ddd;border-radius:4px;text-align:center">
                    </td>
                    <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle" class="unit-price">0.00</td>
                    <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle" class="fee-amount tax-amount">0.00</td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<!-- å·¥ç¨‹ç®¡ç†è²» -->
<div class="card mt-4" style="background:#fff;padding:18px;border-radius:10px;box-shadow:0 6px 14px rgba(0,0,0,.04);margin-bottom:16px">
    <div style="background:#f8f9fa;padding:12px;border-radius:8px;margin-bottom:12px;font-weight:700">å·¥ç¨‹ç®¡ç†è²»(å°è¨ˆ:)</div>
    
    <div style="overflow:auto; margin-top:12px">
        <table class="table" style="width:100%;border-collapse:collapse;margin-top:10px;background:#fff;border-radius:8px;overflow:hidden;box-shadow:0 4px 14px rgba(0,0,0,.06)">
            <thead>
                <tr>
                                       <th style="padding:12px 14px;text-align:left;font-weight:800;color:#fff;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%)">å·¥ç¨‹é …ç›®</th>
                    <th style="padding:12px 14px;text-align:left;font-weight:800;color:#fff;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%)">èªªæ˜</th>
                    <th style="padding:12px 14px;text-align:left;font-weight:800;color:#fff;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%)">å–®ä½</th>
                    <th style="padding:12px 14px;text-align:left;font-weight:800;color:#fff;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%)">æ•¸é‡</th>
                    <th style="padding:12px 14px;text-align:left;font-weight:800;color:#fff;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%)">é ç®—å–®åƒ¹</th>
                    <th style="padding:12px 14px;text-align:left;font-weight:800;color:#fff;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%)">é ç®—å·¥ç¨‹è²»</th>
                </tr>
            </thead>
            <tbody>
                <!-- å·¥ç¨‹ç®¡ç†è²» -->
                <tr>
                                        <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle">å·¥ç¨‹ç®¡ç†è²»(å°è¨ˆ:)</td>
                   <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle">
        <input type="text" class="pollution-description" value="å·¥ç¨‹ç®¡ç†èˆ‡ç›£é€ " 
               style="width:100%;padding:4px;border:1px solid #ddd;border-radius:4px">
    </td>

                    <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle">å¼</td>
                    <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle">
                        <input type="number" class="fee-qty projectmgt-qty" value="1.00" step="0.01" min="0" 
                               style="width:70px;padding:4px;border:1px solid #ddd;border-radius:4px;text-align:center">
                    </td>
                    <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle" class="unit-price">15,000.00</td>
                    <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle" class="fee-amount projectmgt-amount">15,000.00</td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<!-- ç©ºæ°£æ±¡æŸ“é˜²åˆ¶è²» -->
<div class="card mt-4" style="background:#fff;padding:18px;border-radius:10px;box-shadow:0 6px 14px rgba(0,0,0,.04);margin-bottom:16px">
    <div style="background:#f8f9fa;padding:12px;border-radius:8px;margin-bottom:12px;font-weight:700">ç©ºæ°£æ±¡æŸ“é˜²åˆ¶è²»(å°è¨ˆ:)</div>
    
    <div style="overflow:auto; margin-top:12px">
        <table class="table" style="width:100%;border-collapse:collapse;margin-top:10px;background:#fff;border-radius:8px;overflow:hidden;box-shadow:0 4px 14px rgba(0,0,0,.06)">
            <thead>
                <tr>
                                       <th style="padding:12px 14px;text-align:left;font-weight:800;color:#fff;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%)">å·¥ç¨‹é …ç›®</th>
                    <th style="padding:12px 14px;text-align:left;font-weight:800;color:#fff;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%)">èªªæ˜</th>
                    <th style="padding:12px 14px;text-align:left;font-weight:800;color:#fff;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%)">å–®ä½</th>
                    <th style="padding:12px 14px;text-align:left;font-weight:800;color:#fff;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%)">æ•¸é‡</th>
                    <th style="padding:12px 14px;text-align:left;font-weight:800;color:#fff;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%)">é ç®—å–®åƒ¹</th>
                    <th style="padding:12px 14px;text-align:left;font-weight:800;color:#fff;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%)">é ç®—å·¥ç¨‹è²»</th>
                </tr>
            </thead>
            <tbody>
                <!-- ç©ºæ°£æ±¡æŸ“é˜²åˆ¶è²» -->
                <tr>
                                        <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle">ç©ºæ°£æ±¡æŸ“é˜²åˆ¶è²»</td>
                   <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle">
        <input type="text" class="pollution-description" value="ç’°ä¿ç½²è¦å®šè²»ç”¨" 
               style="width:100%;padding:4px;border:1px solid #ddd;border-radius:4px">
    </td>
                    <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle">å¼</td>
                    <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle">
                        <input type="number" class="fee-qty pollution-qty" value="1.00" step="0.01" min="0" 
                               style="width:70px;padding:4px;border:1px solid #ddd;border-radius:4px;text-align:center">
                    </td>
                    <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle" class="unit-price">3,000.00</td>
                    <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle" class="fee-amount pollution-amount">3,000.00</td>
                </tr>
            </tbody>
        </table>
    </div>
</div>
            
         <div class="budget-summary">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
        <div style="text-align:right;font-weight:700;flex:1">åˆè¨ˆï¼š</div>
        <div style="font-weight:700;font-size:18px;color:#1b5e20" id="safetyEnvSubtotal">0.00</div>
    </div>
</div>
        </div>
    </div>

    <!-- é ç®— -->
<div id="budget" class="tab-content">
    <h3 class="section-title">å·¥ç¨‹é ç®—ç¸½è¡¨</h3>
    
    <div class="card" style="background:#fff;padding:18px;border-radius:10px;box-shadow:0 6px 14px rgba(0,0,0,.04);margin-bottom:16px">
        <div style="background:#f8f9fa;padding:12px;border-radius:8px;margin-bottom:12px;font-weight:700">é ç®—è³‡æ–™å½™ç·¨</div>
        <div class="action-buttons mb-3">
            <button class="btn btn-primary" id="compileBudget">
                <i class="fas fa-database me-2"></i>è³‡æ–™å½™ç·¨
            </button>
        </div>
        
        <div style="overflow:auto">
            <table class="table" style="width:100%;border-collapse:collapse;margin-top:10px;background:#fff;border-radius:8px;overflow:hidden;box-shadow:0 4px 14px rgba(0,0,0,.06)" id="budgetTable">
                <thead>
                    <tr>
                        <th style="padding:12px 14px;text-align:left;font-weight:800;color:#fff;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%)">å·¥ç¨‹é …ç›®</th>
                        <th style="padding:12px 14px;text-align:left;font-weight:800;color:#fff;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%)">èªªæ˜</th>
                        <th style="padding:12px 14px;text-align:left;font-weight:800;color:#fff;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%)">å–®ä½</th>
                        <th style="padding:12px 14px;text-align:left;font-weight:800;color:#fff;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%)">æ•¸é‡</th>
                        <th style="padding:12px 14px;text-align:left;font-weight:800;color:#fff;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%)">å–®åƒ¹</th>
                        <th style="padding:12px 14px;text-align:left;font-weight:800;color:#fff;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%)">ç¸½åƒ¹</th>
                        <th style="padding:12px 14px;text-align:left;font-weight:800;color:#fff;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%)">å‚™è¨»</th>
                    </tr>
                </thead>
                <tbody id="budgetTableBody">
                    <!-- é€™è£¡æœƒç”±
å‹•æ…‹ç”Ÿæˆå…§å®¹ -->
                    <tr id="budgetEmptyRow">
                        <td colspan="7" style="padding:20px;text-align:center;color:#6c757d">
                            <div class="empty-state">
                                <div class="empty-state-icon">ğŸ“Š</div>
                                <h3>å°šæœªå½™ç·¨è³‡æ–™</h3>
                                <p>è«‹é»æ“Šã€Œè³‡æ–™å½™ç·¨ã€æŒ‰éˆ•ï¼Œå¾å·¥ç¨‹é ç®—æ›¸åŸºæœ¬è³‡æ–™åŒ¯å…¥è³‡æ–™</p>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <div class="budget-summary">
            <div class="budget-total" id="budgetTotalDisplay">
                æœ¬å·¥ç¨‹é ç®—ç¸½é¡æ–°å°å¹£ï¼š0 å…ƒ
            </div>
        </div>
    </div>
</div>

<!-- é å®šé€²åº¦ -->
<div id="schedule" class="tab-content">
    <div class="info-card" style="max-width: 1400px; margin: 0 auto;">
        <header style="text-align: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #e0e6ed;">
            <h1 style="color: #2c3e50; margin-bottom: 8px; font-size: 24px;">
                <i class="fas fa-hard-hat"></i> å·¥ç¨‹é€²åº¦ç®¡ç†ç³»çµ±
            </h1>
            <p class="subtitle" style="color: #7f8c8d; font-size: 14px;">è¨­å®šå„å·¥ç¨‹é …ç›®çš„é€²åº¦å€é–“ï¼Œé¡¯ç¤ºç™¾åˆ†æ¯”å’Œå°æ‡‰æœˆä»½</p>
        </header>
        
        <div class="instructions" style="background-color: #e8f4fc; border-left: 4px solid #3498db; padding: 12px; margin-bottom: 15px; border-radius: 4px; font-size: 13px;">
            <h3 style="color: #3498db; margin-bottom: 6px; font-size: 14px;">
                <i class="fas fa-info-circle"></i> ä½¿ç”¨èªªæ˜
            </h3>
            <ul style="padding-left: 18px;">
                <li>æ‹–å‹•<span style="color:#27ae60;font-weight:bold;">ç¶ è‰²</span>å’Œ<span style="color:#c0392b;font-weight:bold;">ç´…è‰²</span>æ§åˆ¶é»è¨­å®šæ¯å€‹é …ç›®çš„é€²åº¦å€é–“</li>
                <li>æ§åˆ¶é»ä¸Šæ–¹æœƒåŒæ™‚é¡¯ç¤ºç™¾åˆ†æ¯”å’Œå°æ‡‰æœˆä»½</li>
                <li>é€²åº¦æ¢ä¸Šæ¨™è¨˜äº†å„æœˆä»½çš„ç›®æ¨™ä½ç½®</li>
                <li>ç³»çµ±æœƒæ ¹æ“šè¨­å®šçš„é€²åº¦å€é–“å’Œå„é …ç›®æ‰€ä½”ç™¾åˆ†æ¯”è‡ªå‹•è¨ˆç®—ç¸½é€²åº¦</li>
            </ul>
        </div>
        
        <div class="info-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h2 style="color: #3498db; font-size: 18px;">
                <i class="fas fa-chart-line"></i> ç¸½é«”å·¥ç¨‹é€²åº¦
            </h2>
            <div class="total-progress" style="font-weight: bold; color: #2ecc71; font-size: 16px;">
                ç¸½é€²åº¦: <span id="total-progress">45.2%</span>
            </div>
        </div>
        
        <div class="progress-bar-container" style="background-color: #ecf0f1; height: 8px; border-radius: 4px; margin-bottom: 8px; overflow: hidden;">
            <div class="progress-bar" id="overall-progress-bar" style="height: 100%; background: linear-gradient(to right, #2ecc71, #3498db); border-radius: 4px; transition: width 0.5s ease; width: 45.2%"></div>
        </div>
        
        <div class="progress-labels" style="display: flex; justify-content: space-between; color: #7f8c8d; font-size: 12px; margin-bottom: 15px;">
            <div>0%</div>
            <div>25%</div>
            <div>50%</div>
            <div>75%</div>
            <div>100%</div>
        </div>
        
        <div style="overflow-x: auto;">
            <table style="width: 100%; border-collapse: collapse; margin-top: 10px;">
                <thead>
                    <tr>
                        <th style="padding: 12px; text-align: left; font-weight: 800; color: #fff; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">å·¥ç¨‹é …ç›®</th>
                        <th style="padding: 12px; text-align: center; font-weight: 800; color: #fff; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">å–®ä½</th>
                        <th style="padding: 12px; text-align: center; font-weight: 800; color: #fff; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">æ•¸é‡</th>
                        <th style="padding: 12px; text-align: center; font-weight: 800; color: #fff; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">æ‰€ä½”ç™¾åˆ†æ¯”</th>
                        <th style="padding: 12px; text-align: left; font-weight: 800; color: #fff; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">é€²åº¦å€é–“è¨­å®š (0-100%)</th>
                    </tr>
                </thead>
                <tbody id="scheduleTableBody">
                    <!-- æ•¸æ“šè¡Œå°‡ç”± JavaScript å‹•æ…‹ç”Ÿæˆ -->
                </tbody>
            </table>
        </div>
        
        <div class="controls" style="display: flex; justify-content: space-between; margin-top: 20px; padding-top: 15px; border-top: 1px solid #e0e6ed; gap: 10px;">
            <button class="btn btn-success" id="save-btn" style="flex: 1;">
                <i class="fas fa-save"></i> å„²å­˜é€²åº¦è¨­å®š
            </button>
            <button class="btn btn-warning" id="reset-btn" style="flex: 1;">
                <i class="fas fa-redo"></i> é‡è¨­ç‚ºé è¨­å€¼
            </button>
            <button class="btn btn-primary" id="export-btn" style="flex: 1;">
                <i class="fas fa-file-export"></i> åŒ¯å‡ºé€²åº¦å ±è¡¨
            </button>
        </div>
        
        <div class="footer" style="text-align: center; margin-top: 20px; color: #95a5a6; font-size: 12px;">
            <p><i class="far fa-copyright"></i> å·¥ç¨‹é€²åº¦ç®¡ç†ç³»çµ± v3.1 | æ•¸æ“šæ›´æ–°æ™‚é–“: <span id="current-date"></span></p>
        </div>
    </div>
</div>

    <!-- DATABASE TAB -->
    <div id="database" class="tab-content">
               <div class="price-database-section">
           <div class="database-tabs">
    <div class="database-tab active" data-db-tab="material">å·¥æ–™é …ç›®ç®¡ç†</div>
    <div class="database-tab" data-db-tab="project">å·¥ä½œé …ç›®ç®¡ç†</div>
</div>

            
            <!-- MATERIAL MANAGEMENT -->
            <div id="material-database" class="database-content">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
                    <h3><i class="fas fa-boxes"></i> å·¥æ–™é …ç›®ç®¡ç†</h3>
                    <div style="display:flex;gap:8px">
                        <button class="btn btn-primary" id="addMaterialBtn"><i class="fas fa-plus"></i> æ–°å¢å·¥æ–™é …ç›®</button>
                    </div>
                </div>

                <div class="material-note" style="margin-bottom:12px">
                    <i class="fas fa-info-circle"></i> è‹¥å·¥æ–™é …ç›®æ¨™è¨»<span class="new-material">*</span>ï¼Œè¡¨ç¤ºç‚ºæ–°å¢é …ç›®(è‹¥ç¶“ç®¡ç†å“¡è¨­ç‚ºå…±ç”¨å¾Œï¼Œè©²å·¥æ–™å³å¯ç´å…¥åŸºæœ¬è³‡æ–™åº«å…§)
                </div>

                <div class="database-search">
    <div style="flex:1;position:relative">
        <i class="fas fa-search" style="position:absolute;left:10px;top:50%;transform:translateY(-50%);color:#6c757d"></i>
        <input id="materialSearch" placeholder="æœå°‹å·¥æ–™é …ç›®..." style="padding-left:36px">
    </div>
    <select id="materialCategory" style="width:150px">
        <option value="">æ‰€æœ‰åˆ†é¡</option>
        <option>ç‰©æ–™(M)</option><option>æ©Ÿå…·(E)</option><option>äººå·¥(L)</option><option>é›œé …(W)</option>
    </select>
    <select id="materialSharedFilter" style="width:120px">
        <option value="">å…±ç”¨ç‹€æ…‹</option>
        <option value="shared">å·²å…±ç”¨</option>
        <option value="not-shared">æœªå…±ç”¨</option>
    </select>
</div>

                <div style="overflow:auto">
                    <table class="database-table" id="materialTable">
                        <thead>
                            <tr>
                                <th>å·¥æ–™é …ç›®</th><th style="text-align:center">å–®ä½</th><th style="text-align:right">åŒ—éƒ¨å–®åƒ¹</th><th style="text-align:right">ä¸­éƒ¨å–®åƒ¹</th><th style="text-align:right">å—éƒ¨å–®åƒ¹</th><th style="text-align:right">æ±éƒ¨å–®åƒ¹</th><th style="text-align:center">ç·¨ç¢¼(å‚™è¨»)</th><th style="text-align:center">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="materialTableBody"></tbody>
                    </table>
                </div>

                <div class="empty-database" id="emptyMaterial" style="display:none">
                    <i class="fas fa-inbox"></i><h3>æš«ç„¡å·¥æ–™åç¨±</h3><p>é»æ“Šä¸Šæ–¹æŒ‰éˆ•æ·»åŠ ç¬¬ä¸€å€‹å·¥æ–™åç¨±</p>
                </div>
            </div>

<!-- PROJECT MANAGEMENT -->
            <div id="project-database" class="database-content active">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
                    <h3><i class="fas fa-list-alt"></i> å·¥ä½œé …ç›®ç®¡ç†</h3>
                    <div style="display:flex;gap:8px">
                        <button class="btn btn-primary" id="addProjectBtn"><i class="fas fa-plus"></i> æ–°å¢å·¥ä½œé …ç›®</button>
                    </div>
                </div>

<div class="material-note" style="margin-bottom:12px">
        <i class="fas fa-info-circle"></i> è‹¥å·¥ä½œé …ç›®æ¨™è¨»<span class="new-material">*</span>ï¼Œè¡¨ç¤ºç‚ºæ–°å¢é …ç›®(è‹¥ç¶“ç®¡ç†å“¡è¨­ç‚ºå…±ç”¨å¾Œï¼Œè©²å·¥é …å³å¯ç´å…¥åŸºæœ¬è³‡æ–™åº«å…§)
    </div>

                <div class="database-search">
    <div style="flex:1;position:relative">
        <i class="fas fa-search" style="position:absolute;left:10px;top:50%;transform:translateY(-50%);color:#6c757d"></i>
        <input id="projectSearch" placeholder="æœå°‹å·¥ä½œé …ç›®..." style="padding-left:36px">
    </div>
    <select id="projectCategoryFilter" style="width:150px">
        <option value="">æ‰€æœ‰åˆ†é¡</option>
        <option>å¸¸ç”¨</option><option>ä¸€èˆ¬</option><option>é›œé …</option><option>æ°´é–€</option><option>æ°´åº«æ¸…æ·¤</option>
    </select>
    <select id="projectSharedFilter" style="width:120px">
        <option value="">å…±ç”¨ç‹€æ…‹</option>
        <option value="shared">å·²å…±ç”¨</option>
        <option value="not-shared">æœªå…±ç”¨</option>
    </select>
</div>

                <div style="overflow:auto">
                    <table class="database-table" id="projectTable">
                        <thead>
    <tr>
        <th>å·¥ä½œé …ç›®</th>
        <th style="text-align:center">å–®ä½</th>
        <th style="text-align:center">è¨ˆåƒ¹ä»£ç¢¼</th>
        <th>åƒ¹æ ¼è³‡è¨Š</th>
        <th style="text-align:center">æ“ä½œ</th>
    </tr>
</thead>
                        <tbody id="projectTableBody"></tbody>
                    </table>
                </div>

                <div class="empty-database" id="emptyProject" style="display:none">
                    <i class="fas fa-inbox"></i><h3>æš«ç„¡å·¥ä½œé …ç›®</h3><p>é»æ“Šä¸Šæ–¹æŒ‰éˆ•æ·»åŠ ç¬¬ä¸€å€‹å·¥ä½œé …ç›®</p>
                </div>
            </div>


        </div>
    </div>
</div>

<!-- Modals -->
<!-- Edit Calculation Modal -->
<div id="editCalculationModal" class="modal" aria-hidden="true">
    <div class="modal-content" role="dialog" aria-modal="true">
        <div class="modal-header">
            <h3 id="editCalculationModalTitle">ç·¨è¼¯è¨ˆç®—é …ç›®</h3>
            <button class="close" id="closeEditCalculationModal">&times;</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>è¨ˆç®—å¼</label>
                <div id="editCalcRows"></div>
                <div style="margin-top:8px;">
                    <button class="btn btn-success" onclick="addEditCalcRow()">â• æ–°å¢è¨ˆç®—å¼</button>
                </div>
            </div>
            <div style="text-align:right;font-weight:800;margin-top:12px" id="editTotalPrice">ç¸½æ•¸é‡: 0.00</div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" id="cancelEditCalculationBtn">å–æ¶ˆ</button>
            <button type="button" class="btn btn-primary" onclick="saveEditCalculation()">ğŸ’¾ å„²å­˜</button>
        </div>
    </div>
</div>

<!-- Append Calculation Modal -->
<div id="appendCalculationModal" class="modal" aria-hidden="true">
    <div class="modal-content" role="dialog" aria-modal="true">
        <div class="modal-header">
            <h3 id="appendCalculationModalTitle">è¿½åŠ è¨ˆç®—é …ç›®</h3>
            <button class="close" id="closeAppendCalculationModal">&times;</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>è¿½åŠ è¨ˆç®—å¼</label>
                <div id="appendCalcRows"></div>
                <div style="margin-top:8px;">
                    <button class="btn btn-success" onclick="addAppendCalcRow()">â• æ–°å¢è¨ˆç®—å¼</button>
                </div>
            </div>
            <div style="text-align:right;font-weight:800;margin-top:12px" id="appendTotalPrice">è¿½åŠ ç¸½æ•¸é‡: 0.00</div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" id="cancelAppendCalculationBtn">å–æ¶ˆ</button>
            <button type="button" class="btn btn-primary" onclick="saveAppendCalculation()">ğŸ’¾ å„²å­˜</button>
        </div>
    </div>
</div>

<!-- Project Modal -->
<div id="projectModal" class="modal" aria-hidden="true">
    <div class="modal-content" role="dialog" aria-modal="true">
        <div class="modal-header">
            <h3 id="projectModalTitle">æ–°å¢å·¥ä½œé …ç›®</h3>
            <button class="close" id="closeProjectModal">&times;</button>
        </div>
        <div class="modal-body">
            <form id="projectForm">
                <div class="form-group">
                    <label for="projectName">å·¥ä½œé …ç›®åç¨±</label>
                    <input id="projectName" required />
                </div>
                <div class="form-group">
                    <label for="projectUnit">å–®ä½</label>
                    <input id="projectUnit" required />
                </div>
                <div class="form-group">
                    <label for="projectCode">è¨ˆåƒ¹ä»£ç¢¼</label>
                    <input id="projectCode" required />
                </div>
                <div class="form-group">
                    <label for="projectCategory">åˆ†é¡</label>
                    <select id="projectCategory" required>
                        <option value="">è«‹é¸æ“‡åˆ†é¡</option>
                        <option>å¸¸ç”¨</option><option>ä¸€èˆ¬</option><option>é›œé …</option><option>æ°´é–€</option><option>æ°´åº«æ¸…æ·¤</option>
                    </select>
                </div>

                <div class="form-group">
    <label>åŒ…å«å·¥æ–™åç¨±ï¼ˆå¯åœ¨æ­¤å‹¾é¸åŠ å…¥ï¼‰</label>
    
    <!-- æ–°å¢ï¼šå·¥æ–™æœå°‹å’Œæ·»åŠ å€åŸŸ -->
    <div class="material-search-box">
        <i class="fas fa-search"></i>
        <input type="text" id="materialAutoComplete" 
               placeholder="è¼¸å…¥å·¥æ–™åç¨±å¿«é€Ÿæœå°‹ä¸¦æ·»åŠ ..." 
               autocomplete="off">
    </div>
    <div class="autocomplete" id="materialAutocompleteList"></div>
    
    <div class="material-list" id="materialSelectionInProject">
        <div style="display:flex;padding:10px;border-bottom:1px solid #ddd;font-weight:800;">
            <div style="flex:2;text-align:left">å·¥æ–™åç¨±</div>
            <div style="flex:1;text-align:center">å–®ä½</div>
            <div style="flex:1;text-align:center">å·¥æ–™ç·¨è™Ÿ</div>
            <div style="flex:1;text-align:right">å–®åƒ¹</div>
            <div style="flex:1;text-align:center">æ•¸é‡</div>
            <div style="flex:1;text-align:right">è¤‡åƒ¹</div>
            <div style="flex:0.5;text-align:center">æ“ä½œ</div>
        </div>
        <div id="materialSelectionRows"></div>
    </div>
</div>

               <!-- å–®ä½è¨ˆåƒ¹åŠŸèƒ½ -->
<div style="display:flex; align-items:center; gap:10px; margin:10px 0;">
    <input type="checkbox" id="enableUnitPricing" style="margin:0;">
    <label for="enableUnitPricing" style="font-weight:bold;">æ¡å–®ä½è¨ˆåƒ¹</label>
    <input type="number" id="unitQuantity" placeholder="å–®ä½æ•¸é‡" step="0.001" min="0.001" value="1" 
           style="width:100px; padding:5px; border:1px solid #ddd; border-radius:4px;">
</div>

<div style="text-align:right;font-weight:800;margin-top:12px" id="projectTotalPrice">åˆè¨ˆ: $0.00</div>
<div id="unitPriceDisplay" style="text-align:right;font-weight:600;color:#667eea;">
    è¨ˆ: $0.00
</div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" id="cancelProjectBtn">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-primary">ğŸ’¾ å„²å­˜</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Material Modal -->
<!-- Material Modal -->
<div id="materialModal" class="modal" aria-hidden="true">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="materialModalTitle">æ–°å¢å·¥æ–™é …ç›®</h3>
            <button class="close" id="closeMaterialModal">&times;</button>
        </div>
        <div class="modal-body">
            <form id="materialForm">
                <div class="form-group"><label>å·¥æ–™åç¨±</label><input id="materialName" required></div>
                <div class="form-group"><label>åˆ†é¡</label>
                    <select id="materialCategorySelect" required>
                        <option value="">è«‹é¸æ“‡åˆ†é¡</option>
                        <option>ç‰©æ–™(M)</option><option>æ©Ÿå…·(E)</option><option>äººå·¥(L)</option><option>é›œé …(W)</option>
                    </select>
                </div>
                <div class="form-group"><label>å–®ä½</label><input id="materialUnit" required></div>
                <div class="form-group">
                    <label>å€åŸŸå–®åƒ¹</label>
                    <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px">
                        <input type="number" id="northPrice" placeholder="åŒ—éƒ¨" step="0.01" required>
                        <input type="number" id="centralPrice" placeholder="ä¸­éƒ¨" step="0.01" required>
                        <input type="number" id="southPrice" placeholder="å—éƒ¨" step="0.01" required>
                        <input type="number" id="eastPrice" placeholder="æ±éƒ¨" step="0.01" required>
                    </div>
                </div>
                
                <!-- æ–°å¢ï¼šä¸æ¡ç´å€åŸŸå–®åƒ¹å‹¾é¸æ¡† -->
                <div class="form-group">
                    <div style="display:flex; align-items:center; gap:10px; margin-top:10px;">
                        <input type="checkbox" id="ignoreRegionalPrice" style="margin:0;">
                        <label for="ignoreRegionalPrice" style="font-weight:bold; color:#e74c3c;">
                            âœ‹ ä¸æ¡ç´å€åŸŸå–®åƒ¹ï¼ˆåœ¨å·¥ä½œé …ç›®ç®¡ç†æ™‚å°‡ç•™ç©ºï¼Œéœ€æ‰‹å‹•è¼¸å…¥ï¼‰
                        </label>
                    </div>
                    <div style="font-size:12px; color:#666; margin-top:5px;">
                        <i class="fas fa-info-circle"></i> è‹¥å‹¾é¸æ­¤é …ï¼Œæ­¤å·¥æ–™åœ¨å·¥ä½œé …ç›®ç®¡ç†æ™‚å°‡ä¸é¡¯ç¤ºå€åŸŸå–®åƒ¹ï¼Œéœ€ç”±ä½¿ç”¨è€…æ‰‹å‹•è¼¸å…¥
                    </div>
                </div>
                
                <div class="form-group"><label>ç·¨ç¢¼(å‚™è¨»)</label><input id="materialCode" required></div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" id="cancelMaterialBtn">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-primary">ğŸ’¾ å„²å­˜</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
/* ===========================
   åˆå§‹ç¯„ä¾‹è³‡æ–™èˆ‡è®Šæ•¸
   =========================== */
const categories = {
    'å¸¸ç”¨': ['é é‹æ£„åœŸ','æŒ–å¡«æ–¹','æŒ–æ–¹(æ©Ÿæ¢°æ–½å·¥)','140kgf/cm2é æ‹Œæ··å‡åœŸåŠæ¾†æ³¨'],
    'ä¸€èˆ¬': [],
    'é›œé …': ['é»ç„Šé‹¼çµ²ç¶²','å½©è‰²é‹¼æ¿æ³›æ°´æ”¶é‚Š','TGM-60éé‹…æ ¼æŸµæ¿åŠå®‰è£'],
    'æ°´é–€': [], 'æ°´åº«æ¸…æ·¤': ['æ©Ÿæ¢°é–‹æŒ–','ç®¡åˆ¶ç«™ç›£è¦–è¨­å‚™æŒ‰è£è²»','ç®¡åˆ¶ç«™è²»ç”¨(åœŸé ­åŠåœŸå°¾)'], 'é–‹å£å¥‘ç´„': []
};

let savedItems = {}; // å·¥ç¨‹è¨ˆç®—ç¨¿ç´™å„²å­˜
let earthworkData = [];

let projects = [
    { id:1, name:'é é‹æ£„åœŸ', unit:'m3', code:'M022554095B', category:'å¸¸ç”¨', materials:[1,4,3,5],isShared: true},
    { id:2, name:'æŒ–å¡«æ–¹', unit:'m3', code:'022554093C', category:'å¸¸ç”¨', materials:[1,2,5],isShared: false  }
];

let materials = [
    { id:1, name:'æŒ–æ–¹(1.2æ¬¡)', category:'ç‰©æ–™(M)', unit:'m3', northPrice:50, centralPrice:50, southPrice:50, eastPrice:40, code:'M022554095B', isNew:false,ignoreRegionalPrice: false,isShared: true},
    { id:2, name:'äººå·¥æ•´å¹³å¤¯å¯¦(0.009/0.027)', category:'äººå·¥(L)', unit:'m3', northPrice:1400, centralPrice:1400, southPrice:1400, eastPrice:850, code:'02255PBD404A', isNew:false,ignoreRegionalPrice: false,isShared: true },
   { id:3, name:'åˆæ³•æ”¶å®¹å ´æ‰€', category:'é›œé …(W)', unit:'å…¨', northPrice:65, centralPrice:65, southPrice:65, eastPrice:65, code:'022554093C', isNew:true,ignoreRegionalPrice: false,isShared: true},
    { id:4, name:'å¡è»Šé‹è²»(ä¸€ç´šè·¯é¢)', category:'æ©Ÿå…·(E)', unit:'å…¨', northPrice:101.23, centralPrice:101.23, southPrice:101.23, eastPrice:1.6, code:'022554093C', isNew:true,ignoreRegionalPrice: false,isShared: true },
     { id:5, name:'å·¥å…·è€—æåŠå…¶ä»–', category:'æ©Ÿå…·(E)', unit:'å…¨', northPrice:1.6, centralPrice:1.6, southPrice:1.6, eastPrice:1.6, code:'022554093C', isNew:true,ignoreRegionalPrice: false, isShared: false },

];

// æ›´æ–°priceDataçµæ§‹ä»¥åŒ…å«æ›´å¤šè³‡è¨Š
let priceData = {
    'é é‹æ£„åœŸ': { 
        code: '02300C0003', 
        unit: 'm3',
        items:[
            { material:'æŒ–æ–¹(1.2æ¬¡)', description:'å«åœŸæ–¹ä¸Šä¸‹è»Šè²»ç”¨', unit:'m3', quantity:1.2, price:50.00, note:'T000001000001' },
            { material:'å¡è»Šé‹è²»(ä¸€ç´šè·¯é¢)', description:'å¹³å‡é‹è·8å…¬é‡Œ', unit:'å…¨', quantity:1.0, price:101.23, note:'L000006000001' },
            { material:'åˆæ³•æ”¶å®¹å ´æ‰€', description:'ç„¡', unit:'å…¨', quantity:1.0, price:65.00, note:'L000006000001' },
            { material:'å·¥å…·è€—æåŠå…¶ä»–', description:'ç„¡', unit:'å…¨', quantity:1, price:1.6, note:'L000006000002_2' }
        ]
    },
    'æŒ–å¡«æ–¹': { 
        code: '02300C0004', 
        unit: 'm3',
        items:[
            { material:'æŒ–æ–¹(1.2æ¬¡)', description:'å«åœŸæ–¹ä¸Šä¸‹è»Šè²»ç”¨', unit:'m3', quantity:1.2, price:50.00, note:'E02300C0003' },
            { material:'äººå·¥æ•´å¹³å¤¯å¯¦(0.009/0.027)', description:'ç„¡', unit:'m3', quantity:0.036, price:1400, note:'E02300C0003' },
            { material:'å·¥å…·è€—æåŠå…¶ä»–', description:'ç„¡', unit:'å…¨', quantity:1, price:1.6, note:'L000006000002_2' }
        ]
    },
    'æŒ–æ–¹(æ©Ÿæ¢°æ–½å·¥)': { 
        code: '02300C0005', 
        unit: 'm3',
        items:[
            { material:'é–‹æŒ–æ©Ÿï¼Œå±¥å¸¶å¼', description:'åœŸæ–¹é–‹æŒ–', unit:'æ™‚', quantity:0.036, price:1040.00, note:'E000004410001' },
            { material:'é‹é›œè²»', description:'å»¢åœŸè™•ç†', unit:'å¼', quantity:1.000, price:5.00, note:'W0127130004' }
        ]
    }
};

let editingProjectId = null;
let editingMaterialId = null;
let currentEditIndex = null; // for savedItems editing

// å…¨å±€è®Šé‡ä¿å­˜å°è¨ˆé‡‘é¡
let priceTableTotals = {};

/* ===========================
   é ç±¤åˆ‡æ›èˆ‡åˆå§‹ç¶å®š
   =========================== */
document.querySelectorAll('.tab').forEach(el=>{
    el.addEventListener('click', ()=>{
        document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
        el.classList.add('active');
        const tab = el.getAttribute('data-tab');
        document.querySelectorAll('.tab-content').forEach(tc=>tc.classList.remove('active'));
        document.getElementById(tab).classList.add('active');
        if(tab==='price') renderPriceTables();
        if(tab==='database') { renderProjects(); renderMaterials(); }
        if (tab === 'basic') {
            setTimeout(initializeAllFeeListeners, 500);
        }
    });
});

// è³‡æ–™åº«å…§é ç±¤åˆ‡æ›
// è³‡æ–™åº«å…§é ç±¤åˆ‡æ› - ä¿®æ”¹é è¨­è¡Œç‚º
document.querySelectorAll('.database-tab').forEach(el=>{
    el.addEventListener('click', ()=>{
        document.querySelectorAll('.database-tab').forEach(t=>t.classList.remove('active'));
        el.classList.add('active');
        const tab = el.getAttribute('data-db-tab');
        document.querySelectorAll('.database-content').forEach(tc=>tc.classList.remove('active'));
        document.getElementById(tab+'-database').classList.add('active');
    });
});

// ä¿®æ”¹åˆå§‹åŒ–å‡½æ•¸ï¼Œç¢ºä¿é è¨­é¡¯ç¤ºå·¥æ–™åç¨±ç®¡ç†
function initializeDatabaseTabs() {
    // è¨­ç½®å·¥æ–™åç¨±ç®¡ç†ç‚ºé è¨­æ¿€æ´»ç‹€æ…‹
    document.querySelectorAll('.database-tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.database-content').forEach(tc => tc.classList.remove('active'));
    
    // æ¿€æ´»å·¥æ–™åç¨±ç®¡ç†
    const materialTab = document.querySelector('.database-tab[data-db-tab="material"]');
    const materialContent = document.getElementById('material-database');
    
    if (materialTab && materialContent) {
        materialTab.classList.add('active');
        materialContent.classList.add('active');
    }
}

// åœ¨é é¢è¼‰å…¥æ™‚èª¿ç”¨
document.addEventListener('DOMContentLoaded', function() {
    // å…¶ä»–åˆå§‹åŒ–ä»£ç¢¼...
    initializeDatabaseTabs();
});

// ä¿®æ”¹ tab åˆ‡æ›äº‹ä»¶ï¼Œç¢ºä¿åˆ‡æ›åˆ° database æ™‚é¡¯ç¤ºå·¥æ–™åç¨±ç®¡ç†
document.querySelectorAll('.tab').forEach(el=>{
    el.addEventListener('click', ()=>{
        document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
        el.classList.add('active');
        const tab = el.getAttribute('data-tab');
        document.querySelectorAll('.tab-content').forEach(tc=>tc.classList.remove('active'));
        document.getElementById(tab).classList.add('active');
        
        // ç‰¹åˆ¥è™•ç†ï¼šç•¶åˆ‡æ›åˆ° database é ç±¤æ™‚ï¼Œåˆå§‹åŒ–ç‚ºå·¥æ–™åç¨±ç®¡ç†
        if(tab==='database') { 
            initializeDatabaseTabs();
            renderMaterials(); 
            renderProjects();
        }
        if(tab==='price') renderPriceTables();
    });
});

/* Cascading selects */
document.getElementById('workArea').addEventListener('change', updateCategoryOptions);
document.getElementById('category').addEventListener('change', updateItemOptions);
document.getElementById('item').addEventListener('change', checkEarthwork);

function updateCategoryOptions(){
    const workArea = document.getElementById('workArea').value;
    const sel = document.getElementById('category');
    if(!workArea){ sel.disabled=true; sel.innerHTML='<option>è«‹å…ˆé¸æ“‡å·¥å€</option>'; document.getElementById('itemSelection').style.display='none'; return; }
    sel.disabled=false; sel.innerHTML='<option value="">è«‹é¸æ“‡é¡åˆ¥</option>';
    Object.keys(categories).forEach(cat => sel.innerHTML += `<option value="${cat}">${cat}</option>`);
}

/* ===========================
   å·¥ç¨‹é€²åº¦ç®¡ç†ç³»çµ±
   =========================== */

// é€²åº¦ç®¡ç†ç›¸é—œè®Šæ•¸
const projectData = [
    { name: "é é‹æ£„åœŸ", unit: "M3", quantity: 281, percentage: 0.68 },
    { name: "æŒ–å¡«æ–¹", unit: "M3", quantity: 277, percentage: 16.08 },
    { name: "210kg/cm2é æ‹Œæ··å‡åœŸåŠæ¾†æ³¨", unit: "M2", quantity: 1368, percentage: 11.85 },
    { name: "ç”²ç¨®æ¨¡å‹æè€—", unit: "kg", quantity: 3776, percentage: 2.45 },
    { name: "é‹¼ç­‹åŠ å·¥åŠçµ„ç«‹Ïˆ16mm", unit: "kg", quantity: 9896, percentage: 6.43 },
    { name: "é‹¼ç­‹åŠ å·¥åŠçµ„ç«‹Ïˆ13mm", quantity: 143, percentage: 1.24 },
    { name: "æ··å‡åœŸæ³µæµ¦å£“é€è²»", unit: "M2", quantity: 1115, percentage: 26.57 },
    { name: "æ­¢æ¼éˆ‘åŠæŒ‰è£", unit: "M", quantity: 500, percentage: 1.90 }
];

const monthTargets = [
    { month: 1, targets: [15, 30] },
    { month: 2, targets: [45, 60] },
    { month: 3, targets: [75, 90] },
    { month: 4, targets: [100] }
];

const initialRanges = [
    { start: 0, end: 20 },
    { start: 20, end: 40 },
    { start: 40, end: 60 },
    { start: 60, end: 80 },
    { start: 80, end: 100 },
    { start: 0, end: 0 },
    { start: 0, end: 0 },
    { start: 0, end: 0 }
];

let isDragging = false;
let activeHandle = null;
let dragStartX = 0;
let dragStartLeft = 0;

// å¾å·¥ç¨‹è¨ˆç®—ç¨¿ç´™è‡ªå‹•ç²å–é …ç›®æ•¸æ“š
function getScheduleDataFromProjects() {
    const scheduleData = [];
    
    Object.keys(savedItems).forEach(workArea => {
        savedItems[workArea].forEach(item => {
            // æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨
            const existing = scheduleData.find(p => p.name === item.item);
            if (!existing) {
                scheduleData.push({
                    name: item.item,
                    unit: getUnitByItemName(item.item),
                    quantity: item.total,
                    percentage: 0 // éœ€è¦è¨ˆç®—æˆ–æ‰‹å‹•è¨­ç½®
                });
            }
        });
    });
    
    return scheduleData;
}

// ç™¾åˆ†æ¯”è½‰æ›ç‚ºæœˆä»½
function getMonthFromPercentage(percentage) {
    if (percentage <= 0) return "é–‹å§‹å‰";
    if (percentage <= 30) return "ç¬¬1å€‹æœˆ";
    if (percentage <= 60) return "ç¬¬2å€‹æœˆ";
    if (percentage <= 90) return "ç¬¬3å€‹æœˆ";
    if (percentage <= 100) return "ç¬¬4å€‹æœˆ";
    return "å®Œæˆå¾Œ";
}

// æ¸²æŸ“é€²åº¦è¡¨
function renderScheduleTable() {
    const tbody = document.getElementById('scheduleTableBody');
    if (!tbody) return;
    
    // å˜—è©¦å¾æœ¬åœ°å­˜å„²è¼‰å…¥ä¿å­˜çš„ç¯„åœ
    const savedRanges = localStorage.getItem('projectRanges');
    if (savedRanges) {
        try {
            const parsedRanges = JSON.parse(savedRanges);
            if (parsedRanges.length === initialRanges.length) {
                parsedRanges.forEach((range, index) => {
                    initialRanges[index] = range;
                });
            }
        } catch (e) {
            console.log('ç„¡æ³•è¼‰å…¥ä¿å­˜çš„é€²åº¦è¨­å®š');
        }
    }
    
    // ä½¿ç”¨å·¥ç¨‹è¨ˆç®—ç¨¿ç´™çš„æ•¸æ“šæˆ–é è¨­æ•¸æ“š
    const dataToUse = Object.keys(savedItems).length > 0 ? getScheduleDataFromProjects() : projectData;
    
    tbody.innerHTML = '';
    
    let totalWeightedProgress = 0;
    let totalPercentage = 0;
    
    dataToUse.forEach((project, index) => {
        const range = initialRanges[index] || { start: 0, end: 0 };
        const duration = range.end - range.start;
        
        // è¨ˆç®—åŠ æ¬Šé€²åº¦
        const midpoint = (range.start + range.end) / 2;
        const weightedProgress = (midpoint / 100) * (project.percentage || 10);
        totalWeightedProgress += weightedProgress;
        totalPercentage += (project.percentage || 10);
        
        const startMonth = getMonthFromPercentage(range.start);
        const endMonth = getMonthFromPercentage(range.end);
        
        const row = document.createElement('tr');
        row.style.borderBottom = '1px solid #e0e6ed';
        row.style.transition = 'background-color 0.2s';
        
        row.innerHTML = `
            <td class="project-name" style="padding: 12px; font-weight: 600; color: #2c3e50; min-width: 200px;">${project.name}</td>
            <td class="unit" style="padding: 12px; text-align: center; color: #7f8c8d;">${project.unit || '-'}</td>
            <td class="quantity" style="padding: 12px; text-align: center; color: #7f8c8d;">${project.quantity.toFixed(2)}</td>
            <td class="percentage" style="padding: 12px; text-align: center; font-weight: 600; color: #e74c3c;">
                <input type="number" class="percentage-input" value="${project.percentage || 10}" min="0" max="100" step="0.01" 
                       style="width: 80px; padding: 4px; border: 1px solid #ddd; border-radius: 4px; text-align: center;"
                       data-index="${index}">
            </td>
            <td style="padding: 12px;">
                <div class="range-slider-container" style="padding: 12px 0; position: relative; min-width: 400px;">
                    <!-- æœˆä»½æ¨™è¨˜ -->
                    <div class="month-marks-container" style="position: absolute; width: 100%; top: 5px;">
                        ${monthTargets.map((monthData, monthIndex) => {
                            return monthData.targets.map(target => {
                                return `
                                    <div class="month-mark" style="position: absolute; width: 1px; height: 10px; background-color: #bdc3c7; left: ${target}%; transform: translateX(-50%);"></div>
                                    <div class="month-label" style="position: absolute; top: 12px; transform: translateX(-50%); font-size: 10px; color: #7f8c8d; white-space: nowrap; text-align: center;">${target}%<br>M${monthData.month}</div>
                                `;
                            }).join('');
                        }).join('')}
                    </div>
                    
                    <!-- é€²åº¦å€é–“æ‹‰æ¡¿ -->
                    <div class="range-track" id="track-${index}" style="position: relative; width: 100%; height: 6px; background-color: #dfe6e9; border-radius: 3px; margin: 25px 0 20px 0;">
                        <div class="range-bar" id="bar-${index}" style="position: absolute; height: 100%; background-color: #3498db; border-radius: 3px; top: 0; opacity: 0.7; left: ${range.start}%; width: ${duration}%"></div>
                        <div class="range-handle start" id="handle-start-${index}" style="position: absolute; width: 16px; height: 16px; border-radius: 50%; background-color: #2ecc71; border: 2px solid #27ae60; cursor: pointer; top: 50%; transform: translateY(-50%); z-index: 2; box-shadow: 0 2px 5px rgba(0,0,0,0.2); left: ${range.start}%" 
                            data-index="${index}" data-type="start">
                            <div class="progress-indicator" style="position: absolute; top: -35px; transform: translateX(-50%); font-size: 10px; font-weight: 600; color: #2c3e50; background-color: rgba(255, 255, 255, 0.95); padding: 2px 6px; border-radius: 3px; border: 1px solid #e0e6ed; z-index: 3; white-space: nowrap; min-width: 50px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); left: 50%;">
                                <div class="percentage-value" style="font-size: 11px; color: #3498db;">${range.start}%</div>
                                <div class="month-value" style="font-size: 9px; color: #e74c3c; margin-top: 1px;">${startMonth}</div>
                            </div>
                        </div>
                        <div class="range-handle end" id="handle-end-${index}" style="position: absolute; width: 16px; height: 16px; border-radius: 50%; background-color: #e74c3c; border: 2px solid #c0392b; cursor: pointer; top: 50%; transform: translateY(-50%); z-index: 2; box-shadow: 0 2px 5px rgba(0,0,0,0.2); left: ${range.end}%"
                            data-index="${index}" data-type="end">
                            <div class="progress-indicator" style="position: absolute; top: -35px; transform: translateX(-50%); font-size: 10px; font-weight: 600; color: #2c3e50; background-color: rgba(255, 255, 255, 0.95); padding: 2px 6px; border-radius: 3px; border: 1px solid #e0e6ed; z-index: 3; white-space: nowrap; min-width: 50px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); left: 50%;">
                                <div class="percentage-value" style="font-size: 11px; color: #3498db;">${range.end}%</div>
                                <div class="month-value" style="font-size: 9px; color: #e74c3c; margin-top: 1px;">${endMonth}</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- æ•¸å€¼é¡¯ç¤º -->
                    <div class="range-values" style="display: flex; justify-content: space-between; margin-top: 5px; font-size: 12px;">
                        <div class="range-start-value" style="color: #27ae60; font-weight: 600;">é–‹å§‹: ${range.start}% (${startMonth})</div>
                        <div class="range-duration" style="text-align: center; color: #3498db; font-weight: 600;">é€²åº¦å·®ç•°: ${duration}%</div>
                        <div class="range-end-value" style="color: #c0392b; font-weight: 600;">çµæŸ: ${range.end}% (${endMonth})</div>
                    </div>
                </div>
            </td>
        `;
        
        tbody.appendChild(row);
    });
    
    // è¨ˆç®—ç¸½é€²åº¦
    const totalProgress = totalPercentage > 0 ? (totalWeightedProgress / totalPercentage * 100).toFixed(1) : 0;
    const progressElement = document.getElementById('total-progress');
    const progressBar = document.getElementById('overall-progress-bar');
    
    if (progressElement) progressElement.textContent = `${totalProgress}%`;
    if (progressBar) progressBar.style.width = `${totalProgress}%`;
    
    // ç¶å®šäº‹ä»¶
    bindScheduleEvents();
    bindPercentageInputEvents();
    
    // è¨­ç½®æ—¥æœŸ
    setCurrentDate();
}

// è¨­ç½®ç•¶å‰æ—¥æœŸ
function setCurrentDate() {
    const now = new Date();
    const options = { year: 'numeric', month: 'long', day: 'numeric' };
    const dateElement = document.getElementById('current-date');
    if (dateElement) {
        dateElement.textContent = now.toLocaleDateString('zh-TW', options);
    }
}

// ç¶å®šé€²åº¦æ§åˆ¶é»äº‹ä»¶
function bindScheduleEvents() {
    const handles = document.querySelectorAll('.range-handle');
    
    handles.forEach(handle => {
        handle.removeEventListener('mousedown', startDrag);
        handle.addEventListener('mousedown', startDrag);
    });
    
    document.removeEventListener('mousemove', onDrag);
    document.removeEventListener('mouseup', stopDrag);
    document.addEventListener('mousemove', onDrag);
    document.addEventListener('mouseup', stopDrag);
}

// ç¶å®šç™¾åˆ†æ¯”è¼¸å…¥æ¡†äº‹ä»¶
function bindPercentageInputEvents() {
    document.querySelectorAll('.percentage-input').forEach(input => {
        input.removeEventListener('input', handlePercentageChange);
        input.addEventListener('input', handlePercentageChange);
    });
}

// è™•ç†ç™¾åˆ†æ¯”è®Šæ›´
function handlePercentageChange(e) {
    const index = parseInt(e.target.dataset.index);
    if (projectData[index]) {
        projectData[index].percentage = parseFloat(e.target.value) || 0;
        calculateTotalProgress();
    }
}

// é–‹å§‹æ‹–æ‹½
function startDrag(e) {
    e.preventDefault();
    isDragging = true;
    activeHandle = this;
    const index = parseInt(activeHandle.dataset.index);
    const type = activeHandle.dataset.type;
    
    dragStartX = e.clientX;
    dragStartLeft = initialRanges[index][type];
}

// æ‹–æ‹½ä¸­
function onDrag(e) {
    if (!isDragging || !activeHandle) return;
    
    const index = parseInt(activeHandle.dataset.index);
    const type = activeHandle.dataset.type;
    const track = document.getElementById(`track-${index}`);
    
    if (!track) return;
    
    const trackRect = track.getBoundingClientRect();
    const trackWidth = trackRect.width;
    
    const deltaX = e.clientX - dragStartX;
    const deltaPercent = (deltaX / trackWidth) * 100;
    
    updateHandlePosition(index, type, dragStartLeft + deltaPercent);
}

// åœæ­¢æ‹–æ‹½
function stopDrag() {
    isDragging = false;
    activeHandle = null;
}

// æ›´æ–°æ§åˆ¶é»ä½ç½®
function updateHandlePosition(index, type, newValue) {
    newValue = Math.max(0, Math.min(100, newValue));
    
    if (type === 'start') {
        newValue = Math.min(newValue, initialRanges[index].end - 1);
    } else {
        newValue = Math.max(newValue, initialRanges[index].start + 1);
    }
    
    initialRanges[index][type] = Math.round(newValue);
    updateScheduleUI(index);
    calculateTotalProgress();
}

// æ›´æ–°é€²åº¦UI
function updateScheduleUI(index) {
    const range = initialRanges[index];
    const startValue = range.start;
    const endValue = range.end;
    const duration = endValue - startValue;
    
    const startMonth = getMonthFromPercentage(startValue);
    const endMonth = getMonthFromPercentage(endValue);
    
    // æ›´æ–°æ§åˆ¶é»
    const startHandle = document.getElementById(`handle-start-${index}`);
    const endHandle = document.getElementById(`handle-end-${index}`);
    const bar = document.getElementById(`bar-${index}`);
    
    if (startHandle) {
        startHandle.style.left = `${startValue}%`;
        const indicator = startHandle.querySelector('.progress-indicator');
        if (indicator) {
            indicator.querySelector('.percentage-value').textContent = `${startValue}%`;
            indicator.querySelector('.month-value').textContent = startMonth;
        }
    }
    
    if (endHandle) {
        endHandle.style.left = `${endValue}%`;
        const indicator = endHandle.querySelector('.progress-indicator');
        if (indicator) {
            indicator.querySelector('.percentage-value').textContent = `${endValue}%`;
            indicator.querySelector('.month-value').textContent = endMonth;
        }
    }
    
    if (bar) {
        bar.style.left = `${startValue}%`;
        bar.style.width = `${duration}%`;
    }
    
    // æ›´æ–°é¡¯ç¤ºæ•¸å€¼
    const row = document.querySelectorAll('#scheduleTableBody tr')[index];
    if (row) {
        const startValueElement = row.querySelector('.range-start-value');
        const endValueElement = row.querySelector('.range-end-value');
        const durationElement = row.querySelector('.range-duration');
        
        if (startValueElement) startValueElement.textContent = `é–‹å§‹: ${startValue}% (${startMonth})`;
        if (endValueElement) endValueElement.textContent = `çµæŸ: ${endValue}% (${endMonth})`;
        if (durationElement) durationElement.textContent = `é€²åº¦å·®ç•°: ${duration}%`;
    }
}

// è¨ˆç®—ç¸½é€²åº¦
function calculateTotalProgress() {
    const rows = document.querySelectorAll('#scheduleTableBody tr');
    let totalWeightedProgress = 0;
    let totalPercentage = 0;
    
    rows.forEach((row, index) => {
        const percentageInput = row.querySelector('.percentage-input');
        const percentage = percentageInput ? parseFloat(percentageInput.value) || 0 : 0;
        const range = initialRanges[index] || { start: 0, end: 0 };
        
        const midpoint = (range.start + range.end) / 2;
        const weightedProgress = (midpoint / 100) * percentage;
        
        totalWeightedProgress += weightedProgress;
        totalPercentage += percentage;
    });
    
    const totalProgress = totalPercentage > 0 ? (totalWeightedProgress / totalPercentage * 100).toFixed(1) : 0;
    const progressElement = document.getElementById('total-progress');
    const progressBar = document.getElementById('overall-progress-bar');
    
    if (progressElement) progressElement.textContent = `${totalProgress}%`;
    if (progressBar) progressBar.style.width = `${totalProgress}%`;
}

// ä¿å­˜é€²åº¦è¨­å®š
function saveSchedule() {
    localStorage.setItem('projectRanges', JSON.stringify(initialRanges));
    
    const saveBtn = document.getElementById('save-btn');
    if (saveBtn) {
        const originalHTML = saveBtn.innerHTML;
        saveBtn.innerHTML = '<i class="fas fa-check"></i> å·²ä¿å­˜';
        saveBtn.style.backgroundColor = '#27ae60';
        
        setTimeout(() => {
            saveBtn.innerHTML = originalHTML;
            saveBtn.style.backgroundColor = '';
        }, 1500);
    }
}

// é‡è¨­é€²åº¦è¨­å®š
function resetSchedule() {
    if (confirm('ç¢ºå®šè¦é‡è¨­æ‰€æœ‰é€²åº¦å€é–“ç‚ºé è¨­å€¼å—ï¼Ÿ')) {
        initialRanges.forEach((range, index) => {
            if (index < 5) {
                range.start = index * 20;
                range.end = (index + 1) * 20;
            } else {
                range.start = 0;
                range.end = 0;
            }
        });
        
        renderScheduleTable();
        
        const resetBtn = document.getElementById('reset-btn');
        if (resetBtn) {
            const originalHTML = resetBtn.innerHTML;
            resetBtn.innerHTML = '<i class="fas fa-check"></i> å·²é‡è¨­';
            
            setTimeout(() => {
                resetBtn.innerHTML = originalHTML;
            }, 1500);
        }
    }
}

// åŒ¯å‡ºé€²åº¦å ±è¡¨
function exportSchedule() {
    const dataToUse = Object.keys(savedItems).length > 0 ? getScheduleDataFromProjects() : projectData;
    
    const exportData = {
        timestamp: new Date().toISOString(),
        totalProgress: document.getElementById('total-progress')?.textContent || '0%',
        monthTargets: monthTargets,
        projects: dataToUse.map((project, index) => ({
            name: project.name,
            unit: project.unit,
            quantity: project.quantity,
            percentage: project.percentage || 0,
            start: initialRanges[index]?.start || 0,
            end: initialRanges[index]?.end || 0,
            duration: (initialRanges[index]?.end || 0) - (initialRanges[index]?.start || 0),
            startMonth: getMonthFromPercentage(initialRanges[index]?.start || 0),
            endMonth: getMonthFromPercentage(initialRanges[index]?.end || 0)
        }))
    };
    
    const dataStr = JSON.stringify(exportData, null, 2);
    const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);
    
    const exportFileDefaultName = `å·¥ç¨‹é€²åº¦å ±è¡¨_${new Date().toISOString().split('T')[0]}.json`;
    
    const linkElement = document.createElement('a');
    linkElement.setAttribute('href', dataUri);
    linkElement.setAttribute('download', exportFileDefaultName);
    linkElement.click();
    
    const exportBtn = document.getElementById('export-btn');
    if (exportBtn) {
        const originalHTML = exportBtn.innerHTML;
        exportBtn.innerHTML = '<i class="fas fa-check"></i> å·²åŒ¯å‡º';
        
        setTimeout(() => {
            exportBtn.innerHTML = originalHTML;
        }, 1500);
    }
}

// åˆå§‹åŒ–é€²åº¦ç®¡ç†äº‹ä»¶
function initScheduleEvents() {
    const saveBtn = document.getElementById('save-btn');
    const resetBtn = document.getElementById('reset-btn');
    const exportBtn = document.getElementById('export-btn');
    
    if (saveBtn) {
        saveBtn.removeEventListener('click', saveSchedule);
        saveBtn.addEventListener('click', saveSchedule);
    }
    
    if (resetBtn) {
        resetBtn.removeEventListener('click', resetSchedule);
        resetBtn.addEventListener('click', resetSchedule);
    }
    
    if (exportBtn) {
        exportBtn.removeEventListener('click', exportSchedule);
        exportBtn.addEventListener('click', exportSchedule);
    }
}

// åœ¨ tab åˆ‡æ›äº‹ä»¶ä¸­æ–°å¢é€²åº¦é ç±¤çš„è™•ç†
document.querySelectorAll('.tab').forEach(el => {
    el.addEventListener('click', () => {
        const tab = el.getAttribute('data-tab');
        if (tab === 'schedule') {
            renderScheduleTable();
            initScheduleEvents();
        }
    });
});

// é é¢è¼‰å…¥æ™‚å¼·åˆ¶æ›´æ–°ä¸€æ¬¡
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(() => {
        console.log('ğŸš€ é é¢è¼‰å…¥å®Œæˆï¼Œåˆå§‹åŒ–è²»ç”¨ç³»çµ±...');
        initializeAllFeeListeners();
        // å¦‚æœå·²ç¶“åœ¨åŸºæœ¬è³‡æ–™é ç±¤ï¼Œå¼·åˆ¶æ›´æ–°
        if (document.getElementById('basic').classList.contains('active')) {
            updateBasicDataTable();
        }
    }, 1500);
});

function updateItemOptions(){
    const cat = document.getElementById('category').value;
    const sel = document.getElementById('item');
    if(!cat){ document.getElementById('itemSelection').style.display='none'; return; }
    document.getElementById('itemSelection').style.display='block';
    sel.innerHTML='<option value="">è«‹é¸æ“‡é …ç›®</option>';
    categories[cat].forEach(it => sel.innerHTML += `<option value="${it}">${it}</option>`);
}

// æ–°å¢ï¼šè¨ˆç®—ä¸¦æ›´æ–°ç¸½è¨ˆçš„å‡½æ•¸
function updateCalculationTotal() {
    let total = 0;
    const rows = document.querySelectorAll('#calcRows .calc-row');
    
    rows.forEach(row => {
        const resultSpan = row.querySelector('.calc-result');
        const resultText = resultSpan.textContent;
        
        if (resultText !== 'ç­‰å¾…è¨ˆç®—' && resultText !== 'è¨ˆç®—éŒ¯èª¤') {
            const value = parseFloat(resultText) || 0;
            total += value;
        }
    });
    
    // æ›´æ–°ç¸½è¨ˆé¡¯ç¤º
    const totalElement = document.getElementById('currentTotal');
    if (totalElement) {
        totalElement.textContent = total.toFixed(2);
    }
    
    return total;
}

// ä¿®æ”¹ï¼šaddCalcRow å‡½æ•¸ï¼Œåœ¨æ–°å¢æ™‚ç¶å®šäº‹ä»¶ä¸¦æ›´æ–°ç¸½è¨ˆ
function addCalcRow(){
    const container = document.getElementById('calcRows');
    const id = 'r' + Date.now() + Math.floor(Math.random() * 1000);
    const row = document.createElement('div'); 
    row.className = 'calc-row'; 
    row.id = id;
    
    row.innerHTML = `
        <div class="form-group"><input type="text" placeholder="å‚™è¨»æˆ–èªªæ˜" class="calc-description"></div>
        <div class="form-group"><input type="text" placeholder="è¼¸å…¥è¨ˆç®—å¼ï¼Œä¾‹å¦‚ï¼š90+100*1.2" class="calc-input"></div>
        <div class="result"><span class="calc-result">ç­‰å¾…è¨ˆç®—</span></div>
        <div><button class="btn btn-danger" type="button" onclick="removeCalcRow('${id}')">âœ•</button></div>
    `;
    
    container.appendChild(row);
    
    const input = row.querySelector('.calc-input');
    const resultSpan = row.querySelector('.calc-result');
    
    // ä¿®æ”¹äº‹ä»¶ç›£è½å™¨ï¼Œåœ¨è¨ˆç®—å¾Œæ›´æ–°ç¸½è¨ˆ
    input.addEventListener('input', () => {
        calculateResult(input, resultSpan);
        updateCalculationTotal(); // æ–°å¢ï¼šæ¯æ¬¡è¨ˆç®—å¾Œæ›´æ–°ç¸½è¨ˆ
    });
    
    // åˆå§‹æ›´æ–°ç¸½è¨ˆ
    updateCalculationTotal();
}

// ä¿®æ”¹ï¼šremoveCalcRow å‡½æ•¸ï¼Œåœ¨åˆªé™¤å¾Œæ›´æ–°ç¸½è¨ˆ
function removeCalcRow(id){ 
    const el = document.getElementById(id); 
    if (el) {
        el.remove(); 
        updateCalculationTotal(); // æ–°å¢ï¼šåˆªé™¤å¾Œæ›´æ–°ç¸½è¨ˆ
    }
}

// ä¿®æ”¹ï¼šclearCalcRows å‡½æ•¸ï¼Œåœ¨æ¸…ç©ºå¾Œæ›´æ–°ç¸½è¨ˆ
function clearCalcRows(){ 
    document.getElementById('calcRows').innerHTML = ''; 
    updateCalculationTotal(); // æ–°å¢ï¼šæ¸…ç©ºå¾Œæ›´æ–°ç¸½è¨ˆ
    initCalcRows();
}

// ä¿®æ”¹ï¼šcalculateResult å‡½æ•¸ï¼Œç¢ºä¿è¨ˆç®—æ­£ç¢º
function calculateResult(input, resultSpan){
    try{
        const expr = input.value.trim();
        if(!expr){ 
            resultSpan.textContent = 'ç­‰å¾…è¨ˆç®—'; 
            return; 
        }
        if(/[^0-9+\-*/().\s]/.test(expr)){ 
            resultSpan.textContent = 'è¨ˆç®—éŒ¯èª¤'; 
            return; 
        }
        const v = Function('"use strict"; return (' + expr + ')')();
        if(typeof v === 'number' && isFinite(v)) {
            resultSpan.textContent = v.toFixed(2);
        } else {
            resultSpan.textContent = 'è¨ˆç®—éŒ¯èª¤';
        }
    } catch(e){ 
        resultSpan.textContent = 'è¨ˆç®—éŒ¯èª¤'; 
    }
}

// ä¿®æ”¹ï¼šinitCalcRows å‡½æ•¸ï¼Œç¢ºä¿åˆå§‹åŒ–æ™‚é¡¯ç¤ºç¸½è¨ˆ
function initCalcRows(){ 
    const c = document.getElementById('calcRows'); 
    c.innerHTML = ''; 
    addCalcRow(); 
    updateCalculationTotal(); // æ–°å¢ï¼šåˆå§‹åŒ–æ™‚æ›´æ–°ç¸½è¨ˆ
}

// åˆå§‹åŒ–é€²åº¦ç®¡ç†ï¼ˆå»¶é²åŸ·è¡Œç¢ºä¿ DOM å·²è¼‰å…¥ï¼‰
setTimeout(() => {
    initScheduleEvents();
}, 500);

function checkEarthwork(){
    const item = document.getElementById('item').value;
    if(!item){ document.getElementById('calculationSection').style.display='none'; return; }
    if(item==='æŒ–å¡«æ–¹'){
        if(confirm('æ˜¯å¦è¦è·³è½‰åˆ°åœŸçŸ³æ–¹è¨ˆç®—é ç±¤ï¼Ÿ')){ document.querySelector('.tab[data-tab="earthwork"]').click(); return; }
    }
    document.getElementById('calculationSection').style.display='block';
    initCalcRows();
}

/* ===========================
   è²»ç”¨è¨ˆç®—åŠŸèƒ½
   =========================== */

// è¨ˆç®—è²»ç”¨é‡‘é¡ä¸¦æ›´æ–°å°è¨ˆ
function calculateFeeAmount(qtyInput) {
    const row = qtyInput.closest('tr');
    const unitPriceCell = row.querySelector('.unit-price');
    const amountCell = row.querySelector('.fee-amount');
    
    if (unitPriceCell && amountCell) {
        const qty = parseFloat(qtyInput.value) || 0;
        const unitPrice = parseFloat(unitPriceCell.textContent.replace(/,/g, '')) || 0;
        const amount = qty * unitPrice;
        
        amountCell.textContent = amount.toFixed(2);
        
        // ç«‹å³æ›´æ–°åŸºæœ¬è³‡æ–™è¡¨çš„å°è¨ˆ
        updateBasicDataTable();
        
        return amount;
    }
    return 0;
}

// é¡¯ç¤º/éš±è—è²»ç”¨é …ç›®
function toggleFeeItem(type, itemName, show) {
    const selector = type === 'safety' 
        ? '#basic .card:nth-child(2) table tbody'
        : '#basic .card:nth-child(3) table tbody';
    
    const table = document.querySelector(selector);
    if (table) {
        const rows = table.querySelectorAll('tr');
        rows.forEach(row => {
            const firstCell = row.cells[0];
            if (firstCell && firstCell.textContent.includes(itemName)) {
                row.style.display = show ? '' : 'none';
                // å¦‚æœéš±è—ï¼Œå°‡æ•¸é‡è¨­ç‚º0
                if (!show) {
                    const qtyInput = row.querySelector('.fee-qty');
                    if (qtyInput) qtyInput.value = '0';
                } else {
                    // å¦‚æœé¡¯ç¤ºï¼Œæ¢å¾©é è¨­æ•¸é‡
                    const qtyInput = row.querySelector('.fee-qty');
                    if (qtyInput) qtyInput.value = '1.00';
                }
                // é‡æ–°è¨ˆç®—é‡‘é¡
                const qtyInput = row.querySelector('.fee-qty');
                if (qtyInput) {
                    calculateFeeAmount(qtyInput);
                }
                
                // ç«‹å³æ›´æ–°åŸºæœ¬è³‡æ–™è¡¨çš„å°è¨ˆ
                setTimeout(() => {
                    updateBasicDataTable();
                }, 100);
            }
        });
    }
}

function calculateSafetyTotal() {
    let total = 0;
    const safetyTable = document.querySelector('#basic .card:nth-child(2) table tbody');
    if (safetyTable) {
        const rows = safetyTable.querySelectorAll('tr');
        rows.forEach(row => {
            if (row.style.display !== 'none') {
                const cells = row.querySelectorAll('td');
                if (cells.length >= 6) {
                    const amountText = cells[5].textContent.trim();
                    const amount = parseFloat(amountText.replace(/,/g, '')) || 0;
                    total += amount;
                }
            }
        });
    }
    return total;
}

function calculateEnvironmentTotal() {
    let total = 0;
    const envTable = document.querySelector('#basic .card:nth-child(3) table tbody');
    if (envTable) {
        const rows = envTable.querySelectorAll('tr');
        rows.forEach(row => {
            if (row.style.display !== 'none') {
                const cells = row.querySelectorAll('td');
                if (cells.length >= 6) {
                    const amountText = cells[5].textContent.trim();
                    const amount = parseFloat(amountText.replace(/,/g, '')) || 0;
                    total += amount;
                }
            }
        });
    }
    return total;
}

// ä¿®æ”¹ setupFeeQuantityListeners å‡½æ•¸
function setupFeeQuantityListeners() {
    console.log('ğŸ”„ è¨­ç½®è²»ç”¨æ•¸é‡ç›£è½å™¨...');
    
    document.querySelectorAll('.fee-qty').forEach(input => {
        // ç§»é™¤èˆŠçš„äº‹ä»¶ç›£è½å™¨
        const newInput = input.cloneNode(true);
        input.parentNode.replaceChild(newInput, input);
        
        // æ·»åŠ æ–°çš„äº‹ä»¶ç›£è½å™¨
        newInput.addEventListener('input', function() {
            console.log('ğŸ“ è²»ç”¨æ•¸é‡è®ŠåŒ–:', this.value);
            const row = this.closest('tr');
            const unitPriceCell = row.querySelector('.unit-price');
            const amountCell = row.querySelector('.fee-amount');
            
            if (unitPriceCell && amountCell) {
                const qty = parseFloat(this.value) || 0;
                const unitPrice = parseFloat(unitPriceCell.textContent.replace(/,/g, '')) || 0;
                const amount = qty * unitPrice;
                
                amountCell.textContent = amount.toFixed(2);
                console.log(`ğŸ’° æ›´æ–°é‡‘é¡: ${qty} Ã— ${unitPrice} = ${amount}`);
                
                // ç«‹å³æ›´æ–°åŸºæœ¬è³‡æ–™è¡¨çš„å°è¨ˆ
                updateBasicDataTable();
                
                // æ›´æ–°å®‰å…¨è¡›ç”Ÿå’Œç’°ä¿è²»ç”¨å°è¨ˆ
                calculateSafetyEnvSubtotal();
            }
        });
        
        // åˆå§‹è¨ˆç®—ä¸€æ¬¡
        const row = newInput.closest('tr');
        const unitPriceCell = row.querySelector('.unit-price');
        const amountCell = row.querySelector('.fee-amount');
        if (unitPriceCell && amountCell) {
            const qty = parseFloat(newInput.value) || 0;
            const unitPrice = parseFloat(unitPriceCell.textContent.replace(/,/g, '')) || 0;
            const amount = qty * unitPrice;
            amountCell.textContent = amount.toFixed(2);
        }
    });
}

// è¨­ç½®å‹¾é¸æ¡†äº‹ä»¶ç›£è½å™¨
function setupFeeCheckboxListeners() {
    console.log('è¨­ç½®è²»ç”¨å‹¾é¸æ¡†ç›£è½å™¨...');
    
    const safetyCheckboxes = ['nightLight', 'trafficCone', 'safetyLight', 'warningSign'];
    const envCheckboxes = ['envPersonnel', 'siteCleaning', 'siteSprinkling'];
    
    // è·æ¥­å®‰å…¨è¡›ç”Ÿè²»å‹¾é¸æ¡†
    safetyCheckboxes.forEach(id => {
        const checkbox = document.getElementById(id);
        if (checkbox) {
            // ç§»é™¤èˆŠçš„ç›£è½å™¨
            const newCheckbox = checkbox.cloneNode(true);
            checkbox.parentNode.replaceChild(newCheckbox, checkbox);
            
           // ä¿®æ”¹ setupFeeCheckboxListeners å‡½æ•¸ä¸­çš„äº‹ä»¶è™•ç†
newCheckbox.addEventListener('change', function() {
    const itemName = this.nextElementSibling.textContent.trim();
    console.log('å®‰å…¨è¡›ç”Ÿè²»å‹¾é¸è®ŠåŒ–:', itemName, this.checked);
    toggleFeeItem('safety', itemName, this.checked);
    
    // ç«‹å³æ›´æ–°åŸºæœ¬è³‡æ–™è¡¨
    setTimeout(() => {
        updateBasicDataTable();
    }, 100);
});
        }
    });
    
    // ç’°å¢ƒä¿è­·æªæ–½è²»å‹¾é¸æ¡†
    envCheckboxes.forEach(id => {
        const checkbox = document.getElementById(id);
        if (checkbox) {
            // ç§»é™¤èˆŠçš„ç›£è½å™¨
            const newCheckbox = checkbox.cloneNode(true);
            checkbox.parentNode.replaceChild(newCheckbox, checkbox);
            
            newCheckbox.addEventListener('change', function() {
                const itemName = this.nextElementSibling.textContent.trim();
                console.log('ç’°å¢ƒä¿è­·è²»å‹¾é¸è®ŠåŒ–:', itemName, this.checked);
                toggleFeeItem('env', itemName, this.checked);
                
                // ç«‹å³æ›´æ–°åŸºæœ¬è³‡æ–™è¡¨çš„å°è¨ˆ
                setTimeout(() => {
                    updateBasicDataTable();
                }, 100);
            });
        }
    });
}

// è‡ªå‹•è¨ˆç®—å®‰å…¨è¡›ç”Ÿå’Œç’°ä¿è²»ç”¨å°è¨ˆ
function calculateSafetyEnvSubtotal() {
    let total = 0;
    
    // è¨ˆç®—è·æ¥­å®‰å…¨è¡›ç”Ÿè²»
    document.querySelectorAll('.safety-amount').forEach(element => {
        const amount = parseFloat(element.textContent) || 0;
        total += amount;
    });
    
    // è¨ˆç®—ç’°å¢ƒä¿è­·æªæ–½è²»
    document.querySelectorAll('.env-amount').forEach(element => {
        const amount = parseFloat(element.textContent) || 0;
        total += amount;
    });
    
    // æ›´æ–°é¡¯ç¤º
    const subtotalElement = document.getElementById('safetyEnvSubtotal');
    if (subtotalElement) {
        subtotalElement.textContent = total.toFixed(2);
    }
    
    console.log('ğŸ’° å®‰å…¨è¡›ç”Ÿ+ç’°ä¿å°è¨ˆæ›´æ–°:', total);
    return total;
}

// å¼·åˆ¶åˆ·æ–°é ç®—è¡¨ï¼ˆç¢ºä¿è³‡æ–™æ­£ç¢ºï¼‰
function forceRefreshBudgetTable() {
    console.log('ğŸ”„ å¼·åˆ¶åˆ·æ–°é ç®—è¡¨...');
    
    // å…ˆç¢ºä¿è²»ç”¨è¨ˆç®—æ˜¯æœ€æ–°çš„
    document.querySelectorAll('.fee-qty').forEach(input => {
        const event = new Event('input', { bubbles: true });
        input.dispatchEvent(event);
    });
    
    // ç­‰å¾…è¨ˆç®—å®Œæˆå¾Œæ›´æ–°é ç®—è¡¨
    setTimeout(() => {
        updateBudgetTable();
    }, 500);
}

// é ç®—è³‡æ–™å½™ç·¨åŠŸèƒ½
function compileBudgetData() {
    console.log('ğŸš€ é–‹å§‹å¿«é€Ÿè³‡æ–™å½™ç·¨...');
    
    const tbody = document.getElementById('budgetTableBody');
    tbody.innerHTML = '';
    
    let totalBudget = 0;
    let rowCounter = 1;
    
    // 1. ç›´æ¥å¾å·¥ç¨‹è¨ˆç®—ç¨¿ç´™å¸¶å…¥è³‡æ–™
    console.log('ğŸ“‹ å¾å·¥ç¨‹è¨ˆç®—ç¨¿ç´™å¸¶å…¥è³‡æ–™...');
    Object.keys(savedItems).forEach(workArea => {
        savedItems[workArea].forEach(item => {
            const unitPrice = getPriceTableTotal(item.item) || 100;
            const totalPrice = item.total * unitPrice;
            
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle">${rowCounter++}. ${item.item}</td>
                <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle">${workArea}</td>
                <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle">${getUnitByItemName(item.item)}</td>
                <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle">${item.total.toFixed(2)}</td>
                <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle">${unitPrice.toFixed(2)}</td>
                <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle">${totalPrice.toFixed(2)}</td>
                <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle"></td>
            `;
            tbody.appendChild(tr);
            totalBudget += totalPrice;
        });
    });
    
    // 2. å¼·åˆ¶å¸¶å…¥å®‰å…¨è¡›ç”Ÿè²»ï¼ˆä¸ç®¡å‹¾é¸ç‹€æ…‹ï¼‰
    console.log('ğŸ”§ å¸¶å…¥å®‰å…¨è¡›ç”Ÿè²»...');
    const safetyItems = [
        { name: 'å¤œé–“ç…§æ˜ç‡ˆå…·', price: 500 },
        { name: 'äº¤é€šéŒ', price: 500 },
        { name: 'å®‰å…¨è­¦ç¤ºç‡ˆ', price: 800 },
        { name: 'è­¦å‘Šæ¨™ç¤ºç‰Œ', price: 600 }
    ];
    
    safetyItems.forEach(item => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle">${rowCounter++}. ${item.name}</td>
            <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle">å®‰å…¨è¡›ç”Ÿè¨­æ–½</td>
            <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle">${item.name.includes('ç‡ˆå…·') ? 'ç›' : item.name.includes('äº¤é€šéŒ') ? 'å€‹' : 'çµ„'}</td>
            <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle">1.00</td>
            <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle">${item.price.toFixed(2)}</td>
            <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle">${item.price.toFixed(2)}</td>
            <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle"></td>
        `;
        tbody.appendChild(tr);
        totalBudget += item.price;
    });
    
    // 3. å¼·åˆ¶å¸¶å…¥ç’°ä¿æªæ–½è²»ï¼ˆä¸ç®¡å‹¾é¸ç‹€æ…‹ï¼‰
    console.log('ğŸŒ¿ å¸¶å…¥ç’°ä¿æªæ–½è²»...');
    const envItems = [
        { name: 'ç’°ä¿ç®¡ç†äººå“¡äººäº‹è²»', price: 2500 },
        { name: 'å·¥åœ°æ¸…æ½”è²»', price: 2500 },
        { name: 'å·¥åœ°ç‘æ°´è²»', price: 2500 }
    ];
    
    envItems.forEach(item => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle">${rowCounter++}. ${item.name}</td>
            <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle">ç’°ä¿æªæ–½</td>
            <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle">å…¨</td>
            <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle">1.00</td>
            <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle">${item.price.toFixed(2)}</td>
            <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle">${item.price.toFixed(2)}</td>
            <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle"></td>
        `;
        tbody.appendChild(tr);
        totalBudget += item.price;
    });
    
    // æ›´æ–°ç¸½é‡‘é¡é¡¯ç¤º
    updateBudgetTotalDisplay(totalBudget);
    
    // éš±è—ç©ºç‹€æ…‹
    const emptyRow = document.getElementById('budgetEmptyRow');
    if (emptyRow) emptyRow.style.display = 'none';
    
    console.log(`âœ… è³‡æ–™å½™ç·¨å®Œæˆï¼å…± ${rowCounter-1} å€‹é …ç›®ï¼Œç¸½é‡‘é¡: ${totalBudget}`);
    alert(`è³‡æ–™å½™ç·¨å®Œæˆï¼å…± ${rowCounter-1} å€‹é …ç›®ï¼Œç¸½é ç®—é‡‘é¡: ${totalBudget.toFixed(2)} å…ƒ`);
}

// ç¶å®šäº‹ä»¶ç›£è½å™¨
document.getElementById('compileBudget').addEventListener('click', compileBudgetData);


// è¼”åŠ©å‡½æ•¸ï¼šæ ¹æ“šé …ç›®åç¨±ç²å–å°æ‡‰çš„checkbox ID
function getCheckboxId(itemName) {
    const checkboxMap = {
        'å¤œé–“ç…§æ˜ç‡ˆå…·': 'nightLight',
        'äº¤é€šéŒ': 'trafficCone', 
        'å®‰å…¨è­¦ç¤ºç‡ˆ': 'safetyLight',
        'è­¦å‘Šæ¨™ç¤ºç‰Œ': 'warningSign',
        'ç’°ä¿ç®¡ç†äººå“¡äººäº‹è²»': 'envPersonnel',
        'å·¥åœ°æ¸…æ½”è²»': 'siteCleaning',
        'å·¥åœ°ç‘æ°´è²»': 'siteSprinkling'
    };
    return checkboxMap[itemName] || '';
}

// æ›´æ–°é ç®—è¡¨ - å®Œæ•´ç‰ˆæœ¬ï¼ˆåŒ…å«æ‰€æœ‰å·¥ç¨‹é …ç›®å’Œè²»ç”¨é …ç›®ï¼‰
function updateBudgetTable() {
    console.log('ğŸ”„ é–‹å§‹æ›´æ–°é ç®—è¡¨...');
    const tbody = document.getElementById('budgetTableBody');
    tbody.innerHTML = '';
    
    let totalBudget = 0;
    let rowCounter = 1;
    
    // 1. å¸¶å…¥æ‰€æœ‰å·¥ç¨‹é …ç›®ï¼ˆå¾åŸºæœ¬è³‡æ–™è¡¨ï¼‰
    console.log('ğŸ“‹ å¸¶å…¥å·¥ç¨‹é …ç›®...');
    const basicDataRows = document.querySelectorAll('#basicDataTableBody tr');
    console.log('æ‰¾åˆ°å·¥ç¨‹é …ç›®è¡Œæ•¸:', basicDataRows.length);
    
    basicDataRows.forEach((row, index) => {
        const cells = row.querySelectorAll('td');
        if (cells.length >= 6) {
            const projectName = cells[0].textContent.trim();
            const description = cells[1].textContent.trim();
            const unit = cells[2].textContent.trim();
            const quantity = cells[3].textContent.trim();
            const unitPrice = cells[4].textContent.trim();
            const totalPrice = cells[5].textContent.trim();
            
            console.log(`å·¥ç¨‹é …ç›® ${rowCounter}: ${projectName}, é‡‘é¡: ${totalPrice}`);
            
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle">${rowCounter++}. ${projectName}</td>
                <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle">${description}</td>
                <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle">${unit}</td>
                <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle">${quantity}</td>
                <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle">${unitPrice}</td>
                <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle">${totalPrice}</td>
                <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle"></td>
            `;
            tbody.appendChild(tr);
            
            // ç´¯åŠ ç¸½åƒ¹
            totalBudget += parseFloat(totalPrice.replace(/,/g, '')) || 0;
        }
    });
    
    // 2. å¸¶å…¥è·æ¥­å®‰å…¨è¡›ç”Ÿè²»çš„æ‰€æœ‰ç´°é …
    console.log('ğŸ”§ å¸¶å…¥è·æ¥­å®‰å…¨è¡›ç”Ÿè²»...');
    const safetyItems = [
        { name: 'å¤œé–“ç…§æ˜ç‡ˆå…·', description: 'æŠ˜èˆŠèˆ‡æè€—', unit: 'ç›' },
        { name: 'äº¤é€šéŒ', description: 'æŠ˜èˆŠèˆ‡æè€—', unit: 'å€‹' },
        { name: 'å®‰å…¨è­¦ç¤ºç‡ˆ', description: 'æŠ˜èˆŠèˆ‡æè€—', unit: 'çµ„' },
        { name: 'è­¦å‘Šæ¨™ç¤ºç‰Œ', description: 'æŠ˜èˆŠèˆ‡æè€—', unit: 'çµ„' }
    ];
    
    safetyItems.forEach(item => {
        console.log(`æª¢æŸ¥ ${item.name}...`);
        const checkbox = document.getElementById(getCheckboxId(item.name));
        console.log(`${item.name} å‹¾é¸ç‹€æ…‹:`, checkbox ? checkbox.checked : 'æ‰¾ä¸åˆ°checkbox');
        
        if (checkbox && checkbox.checked) {
            // ç›´æ¥å¾è·æ¥­å®‰å…¨è¡›ç”Ÿè²»è¡¨æ ¼ä¸­è®€å–è³‡æ–™
            const safetyTable = document.querySelector('#basic .card:nth-child(2) table tbody');
            if (safetyTable) {
                const rows = safetyTable.querySelectorAll('tr');
                console.log(`åœ¨å®‰å…¨è¡›ç”Ÿè¡¨æ ¼ä¸­æ‰¾åˆ° ${rows.length} è¡Œ`);
                
                rows.forEach((row, index) => {
                    const firstCell = row.querySelector('td:first-child');
                    if (firstCell && firstCell.textContent.includes(item.name)) {
                        console.log(`æ‰¾åˆ° ${item.name} çš„è¡Œ`);
                        const cells = row.querySelectorAll('td');
                        if (cells.length >= 6) {
                            const quantityInput = cells[3].querySelector('input');
                            const quantity = quantityInput ? quantityInput.value : '1.00';
                            const unitPrice = cells[4].textContent.trim();
                            const totalPrice = cells[5].textContent.trim();
                            
                            console.log(`${item.name} - æ•¸é‡: ${quantity}, å–®åƒ¹: ${unitPrice}, ç¸½åƒ¹: ${totalPrice}`);
                            
                            const amount = parseFloat(totalPrice) || 0;
                            const tr = document.createElement('tr');
                            tr.innerHTML = `
                                <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle">${rowCounter++}. ${item.name}</td>
                                <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle">${item.description}</td>
                                <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle">${item.unit}</td>
                                <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle">${quantity}</td>
                                <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle">${unitPrice}</td>
                                <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle">${totalPrice}</td>
                                <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle"></td>
                            `;
                            tbody.appendChild(tr);
                            totalBudget += amount;
                            console.log(`âœ… å·²æ·»åŠ  ${item.name} åˆ°é ç®—è¡¨`);
                        }
                    }
                });
            } else {
                console.log('âŒ æ‰¾ä¸åˆ°å®‰å…¨è¡›ç”Ÿè¡¨æ ¼');
            }
        }
    });
    
    // 3. å¸¶å…¥ç’°å¢ƒä¿è­·æªæ–½è²»çš„æ‰€æœ‰ç´°é …
    console.log('ğŸŒ¿ å¸¶å…¥ç’°å¢ƒä¿è­·æªæ–½è²»...');
    const envItems = [
        { name: 'ç’°ä¿ç®¡ç†äººå“¡äººäº‹è²»', description: 'ç’°ä¿ç®¡ç†', unit: 'å…¨' },
        { name: 'å·¥åœ°æ¸…æ½”è²»', description: 'ç’°å¢ƒæ¸…æ½”ç¶­è­·', unit: 'å…¨' },
        { name: 'å·¥åœ°ç‘æ°´è²»', description: 'ç‘æ°´é˜²å¡µ', unit: 'å…¨' }
    ];
    
    envItems.forEach(item => {
        console.log(`æª¢æŸ¥ ${item.name}...`);
        const checkbox = document.getElementById(getCheckboxId(item.name));
        console.log(`${item.name} å‹¾é¸ç‹€æ…‹:`, checkbox ? checkbox.checked : 'æ‰¾ä¸åˆ°checkbox');
        
        if (checkbox && checkbox.checked) {
            // ç›´æ¥å¾ç’°å¢ƒä¿è­·æªæ–½è²»è¡¨æ ¼ä¸­è®€å–è³‡æ–™
            const envTable = document.querySelector('#basic .card:nth-child(3) table tbody');
            if (envTable) {
                const rows = envTable.querySelectorAll('tr');
                console.log(`åœ¨ç’°ä¿æªæ–½è¡¨æ ¼ä¸­æ‰¾åˆ° ${rows.length} è¡Œ`);
                
                rows.forEach((row, index) => {
                    const firstCell = row.querySelector('td:first-child');
                    if (firstCell && firstCell.textContent.includes(item.name)) {
                        console.log(`æ‰¾åˆ° ${item.name} çš„è¡Œ`);
                        const cells = row.querySelectorAll('td');
                        if (cells.length >= 6) {
                            const quantityInput = cells[3].querySelector('input');
                            const quantity = quantityInput ? quantityInput.value : '1.00';
                            const unitPrice = cells[4].textContent.trim();
                            const totalPrice = cells[5].textContent.trim();
                            
                            console.log(`${item.name} - æ•¸é‡: ${quantity}, å–®åƒ¹: ${unitPrice}, ç¸½åƒ¹: ${totalPrice}`);
                            
                            const amount = parseFloat(totalPrice) || 0;
                            const tr = document.createElement('tr');
                            tr.innerHTML = `
                                <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle">${rowCounter++}. ${item.name}</td>
                                <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle">${item.description}</td>
                                <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle">${item.unit}</td>
                                <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle">${quantity}</td>
                                <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle">${unitPrice}</td>
                                <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle">${totalPrice}</td>
                                <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle"></td>
                            `;
                            tbody.appendChild(tr);
                            totalBudget += amount;
                            console.log(`âœ… å·²æ·»åŠ  ${item.name} åˆ°é ç®—è¡¨`);
                        }
                    }
                });
            } else {
                console.log('âŒ æ‰¾ä¸åˆ°ç’°ä¿æªæ–½è¡¨æ ¼');
            }
        }
    });
    
    console.log('ğŸ’° ç¸½é ç®—é‡‘é¡:', totalBudget);
    
    // 4. æ›´æ–°é ç®—ç¸½é¡é¡¯ç¤º
    updateBudgetTotalDisplay(totalBudget);
    
    // å¦‚æœæ²’æœ‰ä»»ä½•è³‡æ–™ï¼Œé¡¯ç¤ºç©ºç‹€æ…‹
    if (tbody.children.length === 0) {
        console.log('âŒ é ç®—è¡¨ç‚ºç©ºï¼Œé¡¯ç¤ºç©ºç‹€æ…‹');
        tbody.innerHTML = `
            <tr id="budgetEmptyRow">
                <td colspan="7" style="padding:20px;text-align:center;color:#6c757d">
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ“Š</div>
                        <h3>å°šæœªå½™ç·¨è³‡æ–™</h3>
                        <p>è«‹é»æ“Šã€Œè³‡æ–™å½™ç·¨ã€æŒ‰éˆ•ï¼Œå¾å·¥ç¨‹é ç®—æ›¸åŸºæœ¬è³‡æ–™åŒ¯å…¥è³‡æ–™</p>
                    </div>
                </td>
            </tr>
        `;
    } else {
        // éš±è—ç©ºç‹€æ…‹è¡Œ
        const emptyRow = document.getElementById('budgetEmptyRow');
        if (emptyRow) emptyRow.style.display = 'none';
        console.log(`âœ… é ç®—è¡¨æ›´æ–°å®Œæˆï¼Œå…± ${tbody.children.length} è¡Œè³‡æ–™`);
    }
}

// è¼”åŠ©å‡½æ•¸ï¼šæ ¹æ“šè¡¨æ ¼å…§å®¹æŸ¥æ‰¾è¡Œ
function findTableRowByContent(selector, content) {
    const table = document.querySelector(selector);
    if (!table) return null;
    
    const rows = table.querySelectorAll('tr');
    for (let row of rows) {
        const firstCell = row.cells[0];
        if (firstCell && firstCell.textContent.includes(content)) {
            return row;
        }
    }
    return null;
}

// è¼”åŠ©å‡½æ•¸ï¼šæ ¹æ“šé …ç›®åç¨±ç²å–å°æ‡‰çš„checkbox ID
function getCheckboxId(itemName) {
    const checkboxMap = {
        'å¤œé–“ç…§æ˜ç‡ˆå…·': 'nightLight',
        'äº¤é€šéŒ': 'trafficCone', 
        'å®‰å…¨è­¦ç¤ºç‡ˆ': 'safetyLight',
        'è­¦å‘Šæ¨™ç¤ºç‰Œ': 'warningSign',
        'ç’°ä¿ç®¡ç†äººå“¡äººäº‹è²»': 'envPersonnel',
        'å·¥åœ°æ¸…æ½”è²»': 'siteCleaning',
        'å·¥åœ°ç‘æ°´è²»': 'siteSprinkling'
    };
    return checkboxMap[itemName] || '';
}

// æ›´æ–°é ç®—ç¸½é¡é¡¯ç¤º
function updateBudgetTotalDisplay(totalAmount) {
    const budgetTotalElement = document.getElementById('budgetTotalDisplay');
    if (budgetTotalElement) {
        // æ ¼å¼åŒ–ç‚ºä¸­æ–‡æ•¸å­—æ ¼å¼
        const formattedAmount = totalAmount.toLocaleString('zh-TW', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        });
        budgetTotalElement.textContent = `æœ¬å·¥ç¨‹é ç®—ç¸½é¡æ–°å°å¹£ï¼š${formattedAmount} å…ƒ`;
    }
}

function initializeAllFeeListeners() {
    console.log('ğŸš€ åˆå§‹åŒ–æ‰€æœ‰è²»ç”¨ç›£è½å™¨...');
    
    // å…ˆç§»é™¤æ‰€æœ‰ç¾æœ‰ç›£è½å™¨
    document.querySelectorAll('.fee-qty').forEach(input => {
        const newInput = input.cloneNode(true);
        input.parentNode.replaceChild(newInput, input);
    });
    
    // é‡æ–°è¨­ç½®ç›£è½å™¨
    setupFeeQuantityListeners();
    setupFeeCheckboxListeners();
    
    // åˆå§‹è¨ˆç®—ä¸€æ¬¡
    setTimeout(() => {
        updateBasicDataTable();
        // ğŸ†• æ–°å¢é€™è¡Œï¼šåˆå§‹è¨ˆç®—å®‰å…¨è¡›ç”Ÿå’Œç’°ä¿è²»ç”¨å°è¨ˆ
        calculateSafetyEnvSubtotal();
    }, 500);
    
    console.log('âœ… è²»ç”¨ç›£è½å™¨åˆå§‹åŒ–å®Œæˆ');
}

/* ===========================
   è¨ˆç®—åˆ—åŠŸèƒ½
   =========================== */
function initCalcRows(){ const c=document.getElementById('calcRows'); c.innerHTML=''; addCalcRow(); }
function clearCalcRows(){ document.getElementById('calcRows').innerHTML=''; initCalcRows(); }
function addCalcRow(){
    const container=document.getElementById('calcRows');
    const id='r'+Date.now()+Math.floor(Math.random()*1000);
    const row=document.createElement('div'); row.className='calc-row'; row.id=id;
    row.innerHTML = `
        <div class="form-group"><input type="text" placeholder="å‚™è¨»æˆ–èªªæ˜" class="calc-description"></div>
        <div class="form-group"><input type="text" placeholder="è¼¸å…¥è¨ˆç®—å¼ï¼Œä¾‹å¦‚ï¼š90+100*1.2" class="calc-input"></div>
        <div class="result"><span class="calc-result">ç­‰å¾…è¨ˆç®—</span></div>
        <div><button class="btn btn-danger" type="button" onclick="removeCalcRow('${id}')">âœ•</button></div>
    `;
    container.appendChild(row);
    const input=row.querySelector('.calc-input');
    const resultSpan=row.querySelector('.calc-result');
    input.addEventListener('input', ()=> calculateResult(input,resultSpan));
}
function removeCalcRow(id){ const el=document.getElementById(id); if(el) el.remove(); }
function calculateResult(input,resultSpan){
    try{
        const expr=input.value.trim();
        if(!expr){ resultSpan.textContent='ç­‰å¾…è¨ˆç®—'; return; }
        if(/[^0-9+\-*/().\s]/.test(expr)){ resultSpan.textContent='è¨ˆç®—éŒ¯èª¤'; return; }
        const v=Function('"use strict"; return ('+expr+')')();
        if(typeof v==='number' && isFinite(v)) resultSpan.textContent = v.toFixed(2);
        else resultSpan.textContent='è¨ˆç®—éŒ¯èª¤';
    }catch(e){ resultSpan.textContent='è¨ˆç®—éŒ¯èª¤'; }
}
function saveCalculation(){
    const workArea=document.getElementById('workArea').value;
    const category=document.getElementById('category').value;
    const item=document.getElementById('item').value;
    if(!workArea||!category||!item){ alert('è«‹é¸æ“‡å®Œæ•´çš„å·¥å€ã€é¡åˆ¥å’Œé …ç›®'); return; }
    const rows=document.querySelectorAll('.calc-row');
    const calculations=[]; let total=0;
    rows.forEach(r=>{
        const desc=r.querySelector('.calc-description').value.trim();
        const formula=r.querySelector('.calc-input').value.trim();
        const resText=r.querySelector('.calc-result').textContent;
        if(formula && resText!=='ç­‰å¾…è¨ˆç®—' && resText!=='è¨ˆç®—éŒ¯èª¤'){
            const res=parseFloat(resText);
            calculations.push({ description:desc, formula, result:res });
            total += res;
        }
    });
    if(calculations.length===0){ alert('è«‹è‡³å°‘è¼¸å…¥ä¸€å€‹æœ‰æ•ˆçš„è¨ˆç®—å¼'); return; }
    if(!savedItems[workArea]) savedItems[workArea]=[];
    savedItems[workArea].push({ category, item, calculations, total, timestamp: new Date().toLocaleString('zh-TW') });
    renderSavedItems();
    alert('è¨ˆç®—å·²å„²å­˜ï¼');
    clearCalcRows();
}

/* ===========================
   å·²å„²å­˜é …ç›®ç®¡ç†ï¼ˆrender / edit / delete / appendï¼‰
   =========================== */
function renderSavedItems(){
    const container=document.getElementById('itemsList');
    if(Object.keys(savedItems).length===0){
        container.innerHTML=`<div class="empty-state"><div class="empty-state-icon">ğŸ“‹</div><h3>å°šæœªæ–°å¢ä»»ä½•é …ç›®</h3><p>è«‹é¸æ“‡å·¥å€ã€é¡åˆ¥å’Œé …ç›®å¾Œé–‹å§‹è¨ˆç®—</p></div>`;
        return;
    }
    container.innerHTML='';
    Object.keys(savedItems).forEach(workArea=>{
        const section=document.createElement('div'); section.className='work-area-section';
        section.innerHTML=`<div class="work-area-title">ğŸ—ï¸ ${workArea}</div>`;
        savedItems[workArea].forEach((it,idx)=>{
            const card=document.createElement('div'); card.className='item-card';
            const calculationsHTML = it.calculations.map(c=>`<div>â€¢ ${c.description?c.description+': ':''}${c.formula} = ${c.result.toFixed(2)}</div>`).join('');
           
card.innerHTML = `
    <div class="item-header">
        <div>
            <div class="item-name">${it.category} - ${it.item}</div>
            <div class="item-details">æ–°å¢æ™‚é–“ï¼š${it.timestamp}</div>
        </div>
        <div class="item-actions">
            <button class="btn btn-primary" onclick="openEditModal('${workArea}',${idx})">âœï¸ ç·¨è¼¯</button>
            <button class="btn btn-danger" onclick="deleteItem('${workArea}',${idx})">ğŸ—‘ï¸ åˆªé™¤</button>
        </div>
    </div>
    <div class="item-details" style="margin-top:12px;">
        <strong>è¨ˆç®—å¼ï¼š</strong>${calculationsHTML}
        <div style="margin-top:8px;padding-top:8px;border-top:1px solid #eee;"><strong>åˆè¨ˆï¼š${it.total.toFixed(2)}</strong></div>
    </div>
`;

            section.appendChild(card);
        });
        container.appendChild(section);
    });
}

function deleteItem(workArea, idx){
    if(!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤é …ç›®å—ï¼Ÿ')) return;
    savedItems[workArea].splice(idx,1);
    if(savedItems[workArea].length===0) delete savedItems[workArea];
    renderSavedItems();
}

/* Edit modal for saved items */
function openEditModal(workArea, idx){
    currentEditIndex = { workArea, idx };
    const item = savedItems[workArea][idx];
    
    // æ¸…ç©ºä¸¦å¡«å……ç·¨è¼¯è¨ˆç®—å¼å€åŸŸ
    const container = document.getElementById('editCalcRows');
    container.innerHTML = '';
    
    item.calculations.forEach(calc => {
        addEditCalcRow(calc.description, calc.formula, calc.result);
    });
    
    document.getElementById('editTotalPrice').textContent = 'ç¸½æ•¸é‡: ' + item.total.toFixed(2);
    document.getElementById('editCalculationModalTitle').textContent = 'ç·¨è¼¯è¨ˆç®—é …ç›®: ' + item.category + ' - ' + item.item;
    showModal('editCalculationModal');
}

function addEditCalcRow(description = '', formula = '', result = 0){
    const container=document.getElementById('editCalcRows');
    const id='edit_r'+Date.now()+Math.floor(Math.random()*1000);
    const row=document.createElement('div'); row.className='calc-row'; row.id=id;
    row.innerHTML = `
        <div class="form-group"><input type="text" placeholder="å‚™è¨»æˆ–èªªæ˜" class="calc-description" value="${description}"></div>
        <div class="form-group"><input type="text" placeholder="è¼¸å…¥è¨ˆç®—å¼ï¼Œä¾‹å¦‚ï¼š90+100*1.2" class="calc-input" value="${formula}"></div>
        <div class="result"><span class="calc-result">${result ? result.toFixed(2) : 'ç­‰å¾…è¨ˆç®—'}</span></div>
        <div><button class="btn btn-danger" type="button" onclick="removeCalcRow('${id}')">âœ•</button></div>
    `;
    container.appendChild(row);
    const input=row.querySelector('.calc-input');
    const resultSpan=row.querySelector('.calc-result');
    input.addEventListener('input', ()=> calculateResult(input,resultSpan));
}

function saveEditCalculation(){
    if(!currentEditIndex) return;
    
    const workArea = currentEditIndex.workArea;
    const idx = currentEditIndex.idx;
    const rows = document.querySelectorAll('#editCalcRows .calc-row');
    const calculations = []; 
    let total = 0;
    
    rows.forEach(r=>{
        const desc = r.querySelector('.calc-description').value.trim();
        const formula = r.querySelector('.calc-input').value.trim();
        const resText = r.querySelector('.calc-result').textContent;
        if(formula && resText!=='ç­‰å¾…è¨ˆç®—' && resText!=='è¨ˆç®—éŒ¯èª¤'){
            const res = parseFloat(resText);
            calculations.push({ description:desc, formula, result:res });
            total += res;
        }
    });
    
    if(calculations.length===0){ 
        alert('è«‹è‡³å°‘è¼¸å…¥ä¸€å€‹æœ‰æ•ˆçš„è¨ˆç®—å¼'); 
        return; 
    }
    
    savedItems[workArea][idx].calculations = calculations;
    savedItems[workArea][idx].total = total;
    savedItems[workArea][idx].timestamp = new Date().toLocaleString('zh-TW') + ' (å·²ä¿®æ”¹)';
    
    renderSavedItems();
    hideModal('editCalculationModal');
    alert('è¨ˆç®—å·²æ›´æ–°ï¼');
}

/* Append modal for saved items */
function openAppendModal(workArea, idx){
    currentEditIndex = { workArea, idx };
    
    // æ¸…ç©ºä¸¦å¡«å……è¿½åŠ è¨ˆç®—å¼å€åŸŸ
    const container = document.getElementById('appendCalcRows');
    container.innerHTML = '';
    addAppendCalcRow();
    
    document.getElementById('appendTotalPrice').textContent = 'è¿½åŠ ç¸½æ•¸é‡: 0.00';
    document.getElementById('appendCalculationModalTitle').textContent = 'è¿½åŠ è¨ˆç®—é …ç›®: ' + savedItems[workArea][idx].category + ' - ' + savedItems[workArea][idx].item;
    showModal('appendCalculationModal');
}

function addAppendCalcRow(){
    const container=document.getElementById('appendCalcRows');
    const id='append_r'+Date.now()+Math.floor(Math.random()*1000);
    const row=document.createElement('div'); row.className='calc-row'; row.id=id;
    row.innerHTML = `
        <div class="form-group"><input type="text" placeholder="å‚™è¨»æˆ–èªªæ˜" class="calc-description"></div>
        <div class="form-group"><input type="text" placeholder="è¼¸å…¥è¨ˆç®—å¼ï¼Œä¾‹å¦‚ï¼š90+100*1.2" class="calc-input"></div>
        <div class="result"><span class="calc-result">ç­‰å¾…è¨ˆç®—</span></div>
        <div><button class="btn btn-danger" type="button" onclick="removeCalcRow('${id}')">âœ•</button></div>
    `;
    container.appendChild(row);
    const input=row.querySelector('.calc-input');
    const resultSpan=row.querySelector('.calc-result');
    input.addEventListener('input', ()=> {
        calculateResult(input,resultSpan);
        updateAppendTotal();
    });
}

function updateAppendTotal(){
    let total = 0;
    document.querySelectorAll('#appendCalcRows .calc-row').forEach(r=>{
        const resText = r.querySelector('.calc-result').textContent;
        if(resText!=='ç­‰å¾…è¨ˆç®—' && resText!=='è¨ˆç®—éŒ¯èª¤'){
            total += parseFloat(resText);
        }
    });
    document.getElementById('appendTotalPrice').textContent = 'è¿½åŠ ç¸½æ•¸é‡: ' + total.toFixed(2);
}

function saveAppendCalculation(){
    if(!currentEditIndex) return;
    
    const workArea = currentEditIndex.workArea;
    const idx = currentEditIndex.idx;
    const rows = document.querySelectorAll('#appendCalcRows .calc-row');
    const newCalculations = []; 
    let additionalTotal = 0;
    
    rows.forEach(r=>{
        const desc = r.querySelector('.calc-description').value.trim();
        const formula = r.querySelector('.calc-input').value.trim();
        const resText = r.querySelector('.calc-result').textContent;
        if(formula && resText!=='ç­‰å¾…è¨ˆç®—' && resText!=='è¨ˆç®—éŒ¯èª¤'){
            const res = parseFloat(resText);
            newCalculations.push({ description:desc, formula, result:res });
            additionalTotal += res;
        }
    });
    
    if(newCalculations.length===0){ 
        alert('è«‹è‡³å°‘è¼¸å…¥ä¸€å€‹æœ‰æ•ˆçš„è¨ˆç®—å¼'); 
        return; 
    }
    
    savedItems[workArea][idx].calculations.push(...newCalculations);
    savedItems[workArea][idx].total += additionalTotal;
    savedItems[workArea][idx].timestamp = new Date().toLocaleString('zh-TW') + ' (å·²è¿½åŠ )';
    
    renderSavedItems();
    hideModal('appendCalculationModal');
    alert('è¨ˆç®—å¼å·²è¿½åŠ ï¼');
}

/* ===========================
   Project DB render / edit / delete
   =========================== */
// è¨ˆç®—å·¥ä½œé …ç›®çš„ç¸½åƒ¹é‡‘é¡
function calculateProjectTotalPrice(project) {
    if (!project.materials || project.materials.length === 0) {
        return 0;
    }
    
    let total = 0;
    project.materials.forEach(materialId => {
        const material = materials.find(m => m.id === materialId);
        if (material) {
            // ä½¿ç”¨åŒ—éƒ¨å–®åƒ¹ä½œç‚ºåŸºæº–ï¼Œæ•¸é‡é è¨­ç‚º1
            total += material.northPrice * 1; // æ•¸é‡é è¨­ç‚º1
        }
    });
    
    return total;
}

function renderProjects() {
    const tbody = document.getElementById('projectTableBody');
    tbody.innerHTML = '';
    
    // ç²å–ç¯©é¸æ¢ä»¶
    const keyword = document.getElementById('projectSearch').value.trim().toLowerCase();
    const catFilter = document.getElementById('projectCategoryFilter').value;
    const sharedFilter = document.getElementById('projectSharedFilter').value; // æ–°å¢
    
    // è‡ªå‹•åŒ…å«å·¥ç¨‹è¨ˆç®—ç¨¿ç´™ä¸­çš„é …ç›®
    const itemsFromCalc = getAllItemsFromCalculations();
    const allProjects = [...projects];
    
    itemsFromCalc.forEach(item => {
        if (!projects.find(p => p.name === item.name)) {
            allProjects.push({
                id: 'temp_' + Date.now() + Math.random(),
                name: item.name,
                unit: getDefaultUnit(item.name),
                code: generateProjectCode(item.name),
                category: item.category || 'ä¸€èˆ¬',
                materials: [],
                isTemporary: true,
                isShared: false // è‡¨æ™‚é …ç›®é è¨­ä¸å…±ç”¨
            });
        }
    });
    
    // ç¯©é¸é‚è¼¯
    const filteredProjects = allProjects.filter(p => {
        // 1. åˆ†é¡ç¯©é¸
        if (catFilter && p.category !== catFilter) return false;
        
        // 2. é—œéµå­—æœå°‹
        if (keyword && !(p.name.toLowerCase().includes(keyword) || (p.code || '').toLowerCase().includes(keyword))) return false;
        
        // 3. å…±ç”¨ç‹€æ…‹ç¯©é¸ï¼ˆæ–°å¢ï¼‰
        if (sharedFilter) {
            // æ³¨æ„ï¼šè‡¨æ™‚é …ç›®æ²’æœ‰å…±ç”¨ç‹€æ…‹ï¼Œé™¤éå·²è½‰ç‚ºæ­£å¼é …ç›®
            if (sharedFilter === 'shared' && !p.isShared) return false;
            if (sharedFilter === 'not-shared' && p.isShared) return false;
            if (sharedFilter === 'new' && !p.isTemporary) return false;
        }
        
        return true;
    });
    
    if (filteredProjects.length === 0) { 
        document.getElementById('emptyProject').style.display = 'block'; 
        return; 
    }
    
    document.getElementById('emptyProject').style.display = 'none';
    
    filteredProjects.forEach(p => {
        const tr = document.createElement('tr');
        
        // è¨ˆç®—ç¸½åƒ¹é‡‘é¡å’Œæ¯å–®ä½é‡‘é¡
        const totalPrice = calculateProjectTotalPrice(p);
        const unitPrice = totalPrice.toFixed(2);
        
        // å…±ç”¨ç‹€æ…‹æ¨™ç¤º
        const sharedBadge = p.isShared ? 
            '<span style="color:#28a745; font-size:11px; background:#d4edda; padding:2px 6px; border-radius:3px; margin-left:5px">âœ“ å…±ç”¨</span>' : 
            '<span style="color:#6c757d; font-size:11px; background:#f8f9fa; padding:2px 6px; border-radius:3px; margin-left:5px">âœ— ä¸å…±ç”¨</span>';
        
        tr.innerHTML = `
            <td>
                ${p.name} 
                ${p.isTemporary ? '<span style="color:#856404;font-size:12px">(å¾…å®Œå–„)</span>' : ''}
                ${sharedBadge}
            </td>
            <td style="text-align:center">${p.unit}</td>
            <td style="text-align:center">${p.code}</td>
            <td>
                <div style="font-weight:bold;color:#2c3e50">åˆè¨ˆ: $${totalPrice.toFixed(2)}</div>
                <div style="font-size:12px;color:#667eea">è¨ˆ: $${unitPrice}</div>
                ${!p.materials || p.materials.length === 0 ? 
                    '<div style="font-size:11px;color:#e74c3c">å°šæœªè¨­å®šå·¥æ–™</div>' : 
                    ''
                }
            </td>
            <td style="text-align:center">
                <button class="btn ${p.isShared ? 'btn-success' : 'btn-secondary'}" 
                        onclick="toggleProjectShare(${p.id})" 
                        style="margin-right:5px; padding:4px 8px; font-size:12px">
                    ${p.isShared ? 'å–æ¶ˆå…±ç”¨' : 'è¨­ç‚ºå…±ç”¨'}
                </button>
                <button class="btn btn-primary" onclick="openProjectEdit(${p.id})" style="margin-right:5px; padding:4px 8px; font-size:12px">âœï¸ ç·¨è¼¯</button>
                ${!p.isTemporary ? `<button class="btn btn-danger" onclick="deleteProject(${p.id})" style="padding:4px 8px; font-size:12px">ğŸ—‘ï¸</button>` : ''}
            </td>
        `;
        
        // æ¨™è¨˜è‡¨æ™‚é …ç›®
        if (p.isTemporary) {
            tr.style.backgroundColor = '#fff3cd';
        }
        
        tbody.appendChild(tr);
    });
}

// åˆ‡æ›å·¥æ–™é …ç›®å…±ç”¨ç‹€æ…‹
function toggleMaterialShare(materialId) {
    const material = materials.find(m => m.id === materialId);
    if (!material) return;
    
    material.isShared = !material.isShared;
    
    // é¡¯ç¤ºç‹€æ…‹è®Šæ›´è¨Šæ¯
    const status = material.isShared ? 'è¨­ç‚ºå…±ç”¨' : 'å–æ¶ˆå…±ç”¨';
    alert(`å·¥æ–™é …ç›®ã€Œ${material.name}ã€å·²${status}`);
    
    // é‡æ–°æ¸²æŸ“
    renderMaterials();
    
    // åŒæ­¥æ›´æ–°ç›¸é—œå·¥ä½œé …ç›®
    updateRelatedProjectsStatus();
}

// åˆ‡æ›å·¥ä½œé …ç›®å…±ç”¨ç‹€æ…‹
function toggleProjectShare(projectId) {
    const project = projects.find(p => p.id === projectId);
    if (!project) return;
    
    project.isShared = !project.isShared;
    
    // é¡¯ç¤ºç‹€æ…‹è®Šæ›´è¨Šæ¯
    const status = project.isShared ? 'è¨­ç‚ºå…±ç”¨' : 'å–æ¶ˆå…±ç”¨';
    alert(`å·¥ä½œé …ç›®ã€Œ${project.name}ã€å·²${status}`);
    
    // é‡æ–°æ¸²æŸ“
    renderProjects();
}

// æ›´æ–°ç›¸é—œå·¥ä½œé …ç›®ç‹€æ…‹ï¼ˆç•¶å·¥æ–™å…±ç”¨ç‹€æ…‹è®Šæ›´æ™‚ï¼‰
function updateRelatedProjectsStatus() {
    projects.forEach(project => {
        if (project.materials && project.materials.length > 0) {
            // æª¢æŸ¥å·¥ä½œé …ç›®æ˜¯å¦åŒ…å«éå…±ç”¨å·¥æ–™
            const hasNonSharedMaterials = project.materials.some(materialId => {
                const material = materials.find(m => m.id === materialId);
                return material && !material.isShared;
            });
            
            // å¦‚æœåŒ…å«éå…±ç”¨å·¥æ–™ï¼Œå·¥ä½œé …ç›®ä¹Ÿä¸èƒ½è¨­ç‚ºå…±ç”¨
            if (hasNonSharedMaterials) {
                project.isShared = false;
            }
        }
    });
}

function openProjectEdit(id){
    const p = projects.find(x=>x.id===id);
    if(!p) return;
    
    // æ”¯æ´è‡¨æ™‚é …ç›®
    editingProjectId = id;
    document.getElementById('projectModalTitle').textContent = 'âœï¸ ç·¨è¼¯å·¥ä½œé …ç›®';
    document.getElementById('projectName').value = p.name;
    document.getElementById('projectUnit').value = p.unit;
    document.getElementById('projectCode').value = p.code;
    document.getElementById('projectCategory').value = p.category;
    
    // æª¢æŸ¥æ˜¯å¦ç‚ºè‡¨æ™‚é …ç›®
    const isTemporary = p.isTemporary || (typeof id === 'string' && id.startsWith('temp_'));
    
    // load materials selection (show checked those in p.materials)
    populateMaterialSelection(); // å…ˆæ¸…ç©ºä¸¦é‡æ–°åˆå§‹åŒ–
    
    // åˆå§‹åŒ– autocomplete
    setTimeout(() => {
        initMaterialAutocomplete();
    }, 100);
    
    // check the ones included in project
    setTimeout(()=> {
        if(p.materials) {
            // æ”¹ç”¨æ–°çš„ addMaterialToSelection å‡½æ•¸ä¾†æ·»åŠ å·¥æ–™
            p.materials.forEach(mid=>{
                addMaterialToSelection(mid);
            });
        }
        calculateProjectTotalPreview();
        
        // å¦‚æœæ˜¯è‡¨æ™‚é …ç›®ï¼Œæç¤ºç”¨æˆ¶
        if (isTemporary) {
            setTimeout(() => {
                alert('é€™æ˜¯å¾å–®åƒ¹è¡¨è‡ªå‹•å»ºç«‹çš„é …ç›®ï¼Œè«‹å®Œå–„å·¥æ–™è³‡è¨Šå¾Œå„²å­˜');
            }, 500);
        }
    }, 200);
    
    showModal('projectModal');
}

/* ===========================
   Material DB render / edit / delete
   =========================== */
function renderMaterials(){
    const tbody=document.getElementById('materialTableBody');
    tbody.innerHTML='';
    if(materials.length===0){ 
        document.getElementById('emptyMaterial').style.display='block'; 
        return; 
    }
    document.getElementById('emptyMaterial').style.display='none';
    
    // ç²å–ç¯©é¸æ¢ä»¶
    const keyword=document.getElementById('materialSearch').value.trim().toLowerCase();
    const catFilter=document.getElementById('materialCategory').value;
    const sharedFilter = document.getElementById('materialSharedFilter').value; // æ–°å¢
    
    // ç¯©é¸é‚è¼¯
    const filteredMaterials = materials.filter(m=>{
        // 1. åˆ†é¡ç¯©é¸
        if(catFilter && m.category !== catFilter) return false;
        
        // 2. é—œéµå­—æœå°‹
        if(keyword && !(m.name.toLowerCase().includes(keyword) || (m.code||'').toLowerCase().includes(keyword))) return false;
        
        // 3. å…±ç”¨ç‹€æ…‹ç¯©é¸ï¼ˆæ–°å¢ï¼‰
        if (sharedFilter) {
            if (sharedFilter === 'shared' && !m.isShared) return false;
            if (sharedFilter === 'not-shared' && m.isShared) return false;
            if (sharedFilter === 'new' && !m.isNew) return false;
        }
        
        return true;
    });
    
    // å¦‚æœæ²’æœ‰ç¬¦åˆæ¢ä»¶çš„é …ç›®ï¼Œé¡¯ç¤ºç©ºç‹€æ…‹
    if (filteredMaterials.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="8" style="text-align:center;padding:40px;color:#6c757d">
                    <i class="fas fa-search" style="font-size:48px;opacity:0.3;margin-bottom:16px"></i>
                    <div>æ²’æœ‰ç¬¦åˆç¯©é¸æ¢ä»¶çš„å·¥æ–™é …ç›®</div>
                </td>
            </tr>
        `;
        return;
    }
    
    // æ¸²æŸ“ç¬¦åˆæ¢ä»¶çš„é …ç›®
    filteredMaterials.forEach(m=>{
        const tr=document.createElement('tr');
        
        // é¡¯ç¤ºæ¨™è¨˜ï¼šå¦‚æœä¸æ¡ç´å€åŸŸå–®åƒ¹
        const priceNote = m.ignoreRegionalPrice ? 
            '<span style="color:#e74c3c; font-size:11px; display:block;">âœ‹ ä¸æ¡å€åŸŸå–®åƒ¹</span>' : '';
        
        // å…±ç”¨ç‹€æ…‹æ¨™ç¤º
        const sharedBadge = m.isShared ? 
            '<span style="color:#28a745; font-size:11px; background:#d4edda; padding:2px 6px; border-radius:3px; margin-left:5px">âœ“ å…±ç”¨</span>' : 
            '<span style="color:#6c757d; font-size:11px; background:#f8f9fa; padding:2px 6px; border-radius:3px; margin-left:5px">âœ— ä¸å…±ç”¨</span>';
        
        tr.innerHTML = `
            <td>
                ${m.name}${m.isNew? ' <span style="color:#e74c3c">*</span>':''}
                ${priceNote}
                ${sharedBadge}
            </td>
            <td style="text-align:center">${m.unit}</td>
            <td style="text-align:right">${(m.northPrice||0).toFixed(2)}</td>
            <td style="text-align:right">${(m.centralPrice||0).toFixed(2)}</td>
            <td style="text-align:right">${(m.southPrice||0).toFixed(2)}</td>
            <td style="text-align:right">${(m.eastPrice||0).toFixed(2)}</td>
            <td style="text-align:center">${m.code}</td>
            <td style="text-align:center">
                <button class="btn ${m.isShared ? 'btn-success' : 'btn-secondary'}" 
                        onclick="toggleMaterialShare(${m.id})" 
                        style="margin-right:5px; padding:4px 8px; font-size:12px">
                    ${m.isShared ? 'å–æ¶ˆå…±ç”¨' : 'è¨­ç‚ºå…±ç”¨'}
                </button>
                <button class="btn btn-primary" onclick="openMaterialEdit(${m.id})" style="margin-right:5px; padding:4px 8px; font-size:12px">âœï¸</button>
                <button class="btn btn-danger" onclick="deleteMaterial(${m.id})" style="padding:4px 8px; font-size:12px">ğŸ—‘ï¸</button>
            </td>
        `;
        tbody.appendChild(tr);
    });
}

document.getElementById('materialSearch').addEventListener('input', renderMaterials);
document.getElementById('materialCategory').addEventListener('change', renderMaterials);

function openMaterialEdit(id){
    const m = materials.find(x=>x.id===id);
    if(!m) return;
    editingMaterialId = id;
    document.getElementById('materialModalTitle').textContent = 'âœï¸ ç·¨è¼¯å·¥æ–™åç¨±';
    document.getElementById('materialName').value = m.name;
    document.getElementById('materialCategorySelect').value = m.category;
    document.getElementById('materialUnit').value = m.unit;
    document.getElementById('northPrice').value = m.northPrice;
    document.getElementById('centralPrice').value = m.centralPrice;
    document.getElementById('southPrice').value = m.southPrice;
    document.getElementById('eastPrice').value = m.eastPrice;
    document.getElementById('materialCode').value = m.code;

const ignorePriceCheckbox = document.getElementById('ignoreRegionalPrice');
    if (ignorePriceCheckbox) {
        ignorePriceCheckbox.checked = m.ignoreRegionalPrice || false;
    }

    showModal('materialModal');
}

function deleteMaterial(id){
    if(!confirm('ç¢ºå®šåˆªé™¤å·¥æ–™åç¨±ï¼Ÿ')) return;
    materials = materials.filter(m=>m.id!==id);
    // also remove from projects materials lists
    projects.forEach(p=>{
        p.materials = (p.materials||[]).filter(mid=>mid!==id);
    });
    renderMaterials();
    renderProjects();
    
    // åŒæ­¥æ›´æ–°
    syncUnitPriceToBudget();
}

/* material modal submit */
document.getElementById('materialForm').addEventListener('submit', function(e){
    e.preventDefault();
    
    // ç²å– checkbox ç‹€æ…‹
    const ignoreRegionalPrice = document.getElementById('ignoreRegionalPrice').checked;
    
    if(editingMaterialId){
        const m = materials.find(x=>x.id===editingMaterialId);
        if(m){
            m.name = document.getElementById('materialName').value.trim();
            m.category = document.getElementById('materialCategorySelect').value;
            m.unit = document.getElementById('materialUnit').value;
            m.northPrice = parseFloat(document.getElementById('northPrice').value)||0;
            m.centralPrice = parseFloat(document.getElementById('centralPrice').value)||0;
            m.southPrice = parseFloat(document.getElementById('southPrice').value)||0;
            m.eastPrice = parseFloat(document.getElementById('eastPrice').value)||0;
            m.code = document.getElementById('materialCode').value;
            m.ignoreRegionalPrice = ignoreRegionalPrice;  // æ–°å¢ï¼šå„²å­˜ checkbox ç‹€æ…‹
            
            editingMaterialId = null;
            renderMaterials();
            hideModal('materialModal');
            alert('å·²å„²å­˜ä¿®æ”¹ï¼');
            return;
        }
    }
    
    // æ–°å¢å·¥æ–™
    const newM = {
        id: Date.now(),
        name: document.getElementById('materialName').value.trim(),
        category: document.getElementById('materialCategorySelect').value,
        unit: document.getElementById('materialUnit').value,
        northPrice: parseFloat(document.getElementById('northPrice').value)||0,
        centralPrice: parseFloat(document.getElementById('centralPrice').value)||0,
        southPrice: parseFloat(document.getElementById('southPrice').value)||0,
        eastPrice: parseFloat(document.getElementById('eastPrice').value)||0,
        code: document.getElementById('materialCode').value||'',
        isNew: true,
        ignoreRegionalPrice: ignoreRegionalPrice  // æ–°å¢ï¼šå„²å­˜ checkbox ç‹€æ…‹
    };
    
    materials.push(newM);
    renderMaterials();
    hideModal('materialModal');
    alert('å·¥æ–™åç¨±å·²æ–°å¢ï¼');
});

/* material modal buttons */
document.getElementById('closeMaterialModal').addEventListener('click', ()=>{ editingMaterialId=null; hideModal('materialModal'); });
document.getElementById('cancelMaterialBtn').addEventListener('click', ()=>{ editingMaterialId=null; hideModal('materialModal'); });

/* add buttons */
document.getElementById('addProjectBtn').addEventListener('click', ()=>{
    editingProjectId = null;
    currentEditIndex = null;
    document.getElementById('projectModalTitle').textContent = 'æ–°å¢å·¥ä½œé …ç›®';
    document.getElementById('projectName').value=''; 
    document.getElementById('projectUnit').value=''; 
    document.getElementById('projectCode').value=''; 
    document.getElementById('projectCategory').value='';
    populateMaterialSelection();
    showModal('projectModal');
});
document.getElementById('addMaterialBtn').addEventListener('click', ()=>{
    editingMaterialId = null;
    document.getElementById('materialModalTitle').textContent = 'æ–°å¢å·¥æ–™é …ç›®';
    document.getElementById('materialName').value=''; 
    document.getElementById('materialCategorySelect').value=''; 
    document.getElementById('materialUnit').value='';
    document.getElementById('northPrice').value=''; 
    document.getElementById('centralPrice').value=''; 
    document.getElementById('southPrice').value=''; 
    document.getElementById('eastPrice').value='';
    document.getElementById('materialCode').value='';
    showModal('materialModal');
});

// ç‚ºproject modalæ·»åŠ äº‹ä»¶è™•ç†å™¨
document.getElementById('projectForm').addEventListener('submit', function(e){
    e.preventDefault();
    
    // 1) editing project in projects DB?
    if(editingProjectId){
        // è™•ç†è‡¨æ™‚é …ç›®è½‰æ­£å¼é …ç›®
        if (typeof editingProjectId === 'string' && editingProjectId.startsWith('temp_')) {
            // å»ºç«‹æ–°å°ˆæ¡ˆ
            const newP = {
                id: Date.now(),
                name: document.getElementById('projectName').value.trim(),
                unit: document.getElementById('projectUnit').value.trim(),
                code: document.getElementById('projectCode').value.trim(),
                category: document.getElementById('projectCategory').value,
                materials: []
            };

           
            // æ·»åŠ é¸ä¸­çš„å·¥æ–™
           const selectedMaterials = [];
            document.querySelectorAll('#materialSelectionRows .material-select-row').forEach(row => {
                const checkbox = row.querySelector('.material-checkbox');
                if(checkbox && checkbox.checked) {
                    const materialId = parseInt(checkbox.value);
                    selectedMaterials.push(materialId);
                }
            });
            newP.materials = selectedMaterials;
            
            projects.push(newP);
            editingProjectId = null;
            renderProjects();
            hideModal('projectModal');
            alert('å·¥ä½œé …ç›®å·²æ­£å¼å»ºç«‹ï¼');
            
            // åŒæ­¥æ›´æ–°
            syncUnitPriceToBudget();
            
            return;
        }
        
        // ç¾æœ‰å°ˆæ¡ˆçš„ç·¨è¼¯é‚è¼¯
        const p = projects.find(x=>x.id===editingProjectId);
        if(p){
            p.name = document.getElementById('projectName').value.trim();
            p.unit = document.getElementById('projectUnit').value.trim();
            p.code = document.getElementById('projectCode').value.trim();
            p.category = document.getElementById('projectCategory').value;
            
            // æ›´æ–°å·¥æ–™æ¸…å–®
             const selectedMaterials = [];
            document.querySelectorAll('#materialSelectionRows .material-select-row').forEach(row => {
                const checkbox = row.querySelector('.material-checkbox');
                if(checkbox && checkbox.checked) {
                    const materialId = parseInt(checkbox.value);
                    selectedMaterials.push(materialId);
                }
            });
            p.materials = selectedMaterials;
            
            editingProjectId = null;
            renderProjects();
            hideModal('projectModal');
            alert('å·¥ä½œé …ç›®å·²æ›´æ–°');
            
            // åŒæ­¥æ›´æ–°
            syncUnitPriceToBudget();
            
            return;
        }
    }
    
    // 2) default: create new project in projects DB
    const newP = {
        id: Date.now(),
        name: document.getElementById('projectName').value.trim(),
        unit: document.getElementById('projectUnit').value.trim(),
        code: document.getElementById('projectCode').value.trim(),
        category: document.getElementById('projectCategory').value,
        materials: []
    };
    
    // æ·»åŠ é¸ä¸­çš„å·¥æ–™
    const selectedMaterials = [];
    document.querySelectorAll('#materialSelectionRows .material-select-row').forEach(row => {
        const checkbox = row.querySelector('.material-checkbox');
        if(checkbox && checkbox.checked) {
            const materialId = parseInt(checkbox.value);
            selectedMaterials.push(materialId);
        }
    });
    newP.materials = selectedMaterials;
    
    projects.push(newP);
    renderProjects();
    hideModal('projectModal');
    alert('å·¥ä½œé …ç›®å·²æ–°å¢ï¼');
    
    // åŒæ­¥æ›´æ–°
    syncUnitPriceToBudget();
});

// å·¥æ–™é¸æ“‡åŠŸèƒ½
function populateMaterialSelection(){
    const container=document.getElementById('materialSelectionRows');
    container.innerHTML='';
    materials.forEach(m=>{
        const div=document.createElement('div'); 
        div.className='material-select-row'; 
        div.style.display='flex'; 
        div.style.alignItems='center'; 
        div.style.padding='10px'; 
        div.style.borderBottom='1px solid #eee';
        
        // æª¢æŸ¥æ˜¯å¦éœ€è¦é¡¯ç¤ºå€åŸŸå–®åƒ¹
        const shouldShowPrice = !m.ignoreRegionalPrice;
        const priceValue = shouldShowPrice ? m.northPrice : '';
        
        div.innerHTML = `
            <div style="flex:2; text-align:left;">
                <label style="cursor:pointer">
                    <input type="checkbox" class="material-checkbox" value="${m.id}" style="margin-right:8px"> 
                    ${m.name}
                    ${m.ignoreRegionalPrice ? '<span style="color:#e74c3c; font-size:11px; margin-left:5px;">(éœ€æ‰‹å‹•è¼¸å…¥å–®åƒ¹)</span>' : ''}
                </label>
            </div>
            <div style="flex:1; text-align:center;">${m.unit}</div>
            <div style="flex:1; text-align:center;">${m.code}</div>
            <div style="flex:1; text-align:center;">
                <input type="number" class="material-price" value="${priceValue}" step="0.01" 
                       style="width:80px;padding:6px;border:1px solid #ddd;border-radius:6px"
                       ${shouldShowPrice ? 'readonly' : ''}>
            </div>
            <div style="flex:1; text-align:center;">
                <input type="number" class="material-qty" value="1" step="0.001" 
                       style="width:80px;padding:6px;border:1px solid #ddd;border-radius:6px">
            </div>
            <div style="flex:1; text-align:center;">
                <input type="number" class="material-subtotal" value="${shouldShowPrice ? m.northPrice : ''}" step="0.01" 
                       style="width:80px;padding:6px;border:1px solid #ddd;border-radius:6px" readonly>
            </div>
        `;
        
        // ç²å–è¼¸å…¥å…ƒç´ 
        const priceInput = div.querySelector('.material-price');
        const qtyInput = div.querySelector('.material-qty');
        const subtotalInput = div.querySelector('.material-subtotal');
        const checkbox = div.querySelector('.material-checkbox');

        // æ ¹æ“š ignoreRegionalPrice è¨­å®šå–®åƒ¹è¼¸å…¥æ¡†
        if (m.ignoreRegionalPrice) {
            // ä¸æ¡ç´å€åŸŸå–®åƒ¹ï¼šå¯ç·¨è¼¯
            priceInput.style.backgroundColor = '#fff';
            priceInput.style.cursor = 'text';
            priceInput.readOnly = false;
            priceInput.placeholder = 'è«‹è¼¸å…¥å–®åƒ¹';
        } else {
            // æ¡ç´å€åŸŸå–®åƒ¹ï¼šå”¯è®€
            priceInput.style.backgroundColor = '#f8f9fa';
            priceInput.style.cursor = 'not-allowed';
            priceInput.readOnly = true;
        }
        
        // è¤‡åƒ¹å§‹çµ‚ç‚ºå”¯è®€
        subtotalInput.style.backgroundColor = '#f8f9fa';
        subtotalInput.style.cursor = 'not-allowed';
        subtotalInput.readOnly = true;

        // è¨ˆç®—è¤‡åƒ¹çš„å‡½æ•¸
        const calculateSubtotal = () => {
            const price = parseFloat(priceInput.value) || 0;
            const qty = parseFloat(qtyInput.value) || 0;
            const subtotal = price * qty;
            subtotalInput.value = subtotal.toFixed(2);
            calculateProjectTotalPreview();
        };

        // ç¶å®šäº‹ä»¶
        qtyInput.addEventListener('input', calculateSubtotal);
        priceInput.addEventListener('input', calculateSubtotal); // æ–°å¢ï¼šå–®åƒ¹è®ŠåŒ–ä¹Ÿé‡æ–°è¨ˆç®—
        checkbox.addEventListener('change', calculateProjectTotalPreview);

        // åˆå§‹è¨ˆç®—ä¸€æ¬¡
        calculateSubtotal();
        
        container.appendChild(div);
    });
    calculateProjectTotalPreview();
}

function calculateProjectTotalPreview(){
    let total = 0;
    document.querySelectorAll('#materialSelectionRows .material-select-row').forEach(r => {
        const cb = r.querySelector('.material-checkbox');
        if(cb && cb.checked){
            const subtotal = parseFloat(r.querySelector('.material-subtotal').value) || 0;
            total += subtotal;
        }
    });
    
    document.getElementById('projectTotalPrice').textContent = 'åˆè¨ˆ: $' + total.toFixed(2);
    
    // è¨ˆç®—æ¯å–®ä½é‡‘é¡
    const unitQuantity = parseFloat(document.getElementById('unitQuantity').value) || 1;
    const unitPrice = total / unitQuantity;
    document.getElementById('unitPriceDisplay').textContent = 'è¨ˆ: $' + unitPrice.toFixed(2);
}


/* ===========================
   Earthwork åœŸçŸ³æ–¹è®¡ç®—åŠŸèƒ½æ›´æ–°
   =========================== */

function initEarthwork(){ 
    const tbody=document.getElementById('earthworkBody'); 
    tbody.innerHTML=''; 
    for(let i=0;i<6;i++) addEarthworkRow(); 
}

function addEarthworkRow(){
    const tbody=document.getElementById('earthworkBody');
    const row=document.createElement('tr');
    row.innerHTML = `
        <td><input type="number" step="0.1" placeholder="ä¾‹å¦‚ï¼š23.5" class="distance-input"></td>
        <!-- æŒ–æ–¹æ ä½ -->
        <td><input type="number" step="0.01" placeholder="0.00" class="cut-area-input"></td>
        <td><input type="number" step="0.01" placeholder="0.00" class="cut-avg-area-input"></td>
        <td><input type="number" step="0.01" placeholder="0.00" class="cut-volume-input" readonly></td>
        <!-- å¡«æ–¹æ ä½ -->
        <td><input type="number" step="0.01" placeholder="0.00" class="fill-area-input"></td>
        <td><input type="number" step="0.01" placeholder="0.00" class="fill-avg-area-input"></td>
        <td><input type="number" step="0.01" placeholder="0.00" class="fill-volume-input" readonly></td>
        <td style="text-align:center">
            <button class="btn btn-danger" onclick="deleteEarthworkRow(this)">åˆªé™¤</button>
        </td>
    `;
    tbody.appendChild(row);
    
    // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨ - åªç›‘å¬è·ç¦»å’Œå¹³å‡æ–­é¢ç§¯çš„å˜åŒ–
    const distanceInput = row.querySelector('.distance-input');
    const cutAvgAreaInput = row.querySelector('.cut-avg-area-input');
    const fillAvgAreaInput = row.querySelector('.fill-avg-area-input');
    
    [distanceInput, cutAvgAreaInput, fillAvgAreaInput].forEach(input => {
        input.addEventListener('input', updateEarthworkTotal);
    });
}

function deleteEarthworkRow(btn){ 
    const tr=btn.closest('tr'); 
    if(tr) tr.remove(); 
    updateEarthworkTotal(); 
}

function updateEarthworkTotal(){ 
    let totalDistance = 0;
    let totalCutVolume = 0;
    let totalFillVolume = 0;
    
    // è®¡ç®—è·ç¦»å°è®¡å’ŒåœŸæ–¹é‡
    document.querySelectorAll('#earthworkBody tr').forEach(row => {
        const distanceInput = row.querySelector('.distance-input');
        const cutAvgAreaInput = row.querySelector('.cut-avg-area-input');
        const fillAvgAreaInput = row.querySelector('.fill-avg-area-input');
        const cutVolumeInput = row.querySelector('.cut-volume-input');
        const fillVolumeInput = row.querySelector('.fill-volume-input');
        
        const distance = parseFloat(distanceInput.value) || 0;
        const cutAvgArea = parseFloat(cutAvgAreaInput.value) || 0;
        const fillAvgArea = parseFloat(fillAvgAreaInput.value) || 0;
        
        // è‡ªåŠ¨è®¡ç®—åœŸç§¯ = è·ç¦» Ã— å¹³å‡æ–­é¢ç§¯
        const cutVolume = distance * cutAvgArea;
        const fillVolume = distance * fillAvgArea;
        
        // æ›´æ–°åœŸç§¯è¾“å…¥æ¡†
        if (cutVolumeInput) cutVolumeInput.value = cutVolume.toFixed(2);
        if (fillVolumeInput) fillVolumeInput.value = fillVolume.toFixed(2);
        
        totalDistance += distance;
        totalCutVolume += cutVolume;
        totalFillVolume += fillVolume;
    });
    
    // è®¡ç®—è¿œè¿å¼ƒåœŸ = æŒ–æ–¹åœŸç§¯ - å¡«æ–¹åœŸç§¯
    const totalExcess = totalCutVolume - totalFillVolume;
    
    document.getElementById('totalDistance').textContent = totalDistance.toFixed(2) + ' m';
    document.getElementById('totalExcess').textContent = totalExcess.toFixed(2) + ' mÂ³';
}

function saveEarthworkData(){ 
    const workArea = document.getElementById('earthworkWorkArea').value;
    if(!workArea) {
        alert('è«‹å…ˆé¸æ“‡å·¥å€ï¼');
        return;
    }
    
    const rows=document.querySelectorAll('#earthworkBody tr');
    const data=[]; 
    rows.forEach(r=>{ 
        const distance = parseFloat(r.cells[0].querySelector('input').value) || 0;
        const cutArea = parseFloat(r.cells[1].querySelector('input').value) || 0;
        const cutAvgArea = parseFloat(r.cells[2].querySelector('input').value) || 0;
        const cutVolume = parseFloat(r.cells[3].querySelector('input').value) || 0;
        const fillArea = parseFloat(r.cells[4].querySelector('input').value) || 0;
        const fillAvgArea = parseFloat(r.cells[5].querySelector('input').value) || 0;
        const fillVolume = parseFloat(r.cells[6].querySelector('input').value) || 0;
        
        if(distance || cutArea || cutAvgArea || fillArea || fillAvgArea) {
            data.push({
                distance,
                cutArea, cutAvgArea, cutVolume,
                fillArea, fillAvgArea, fillVolume
            });
        }
    }); 
    
    earthworkData = data;
    alert('åœŸçŸ³æ–¹è³‡æ–™å·²å„²å­˜ï¼'); 
}

function exportEarthwork(){ 
    if(earthworkData.length===0){ 
        alert('è«‹å…ˆå„²å­˜åœŸçŸ³æ–¹è³‡æ–™ï¼'); 
        return; 
    } 
    
    let csv = 'è·é›¢(m),æŒ–æ–¹æ–·é¢ç©(mÂ²),æŒ–æ–¹å¹³å‡æ–·é¢ç©(mÂ²),æŒ–æ–¹åœŸç©(mÂ³),å¡«æ–¹æ–·é¢ç©(mÂ²),å¡«æ–¹å¹³å‡æ–·é¢ç©(mÂ²),å¡«æ–¹åœŸç©(mÂ³)\n'; 
    earthworkData.forEach(d => {
        csv += `${d.distance.toFixed(2)},${d.cutArea.toFixed(2)},${d.cutAvgArea.toFixed(2)},${d.cutVolume.toFixed(2)},${d.fillArea.toFixed(2)},${d.fillAvgArea.toFixed(2)},${d.fillVolume.toFixed(2)}\n`;
    }); 
    
    const blob = new Blob(['\ufeff'+csv], {type:'text/csv;charset=utf-8;'}); 
    const link = document.createElement('a'); 
    link.href = URL.createObjectURL(blob); 
    link.download = 'åœŸçŸ³æ–¹è¨ˆç®—è¡¨_' + new Date().toISOString().slice(0,10) + '.csv'; 
    link.click(); 
}

// æ›´æ–°å¯¼å…¥åˆ°å·¥ç¨‹è®¡ç®—ç¨¿çº¸çš„å‡½æ•°
function importToMainCalculation(){
    if(earthworkData.length === 0){ 
        alert('è«‹å…ˆå„²å­˜åœŸçŸ³æ–¹è³‡æ–™ï¼'); 
        return; 
    }
    
    const workArea = document.getElementById('earthworkWorkArea').value;
    if(!workArea) {
        alert('è«‹å…ˆåœ¨åœŸçŸ³æ–¹è¨ˆç®—é ç±¤é¸æ“‡å·¥å€ï¼');
        return;
    }
    
    // é‡æ–°è¨ˆç®—ç¸½åœŸç©ï¼ˆä½¿ç”¨å…¬å¼ï¼šè·é›¢ Ã— å¹³å‡æ–·é¢ç©ï¼‰
    const totalCutVolume = earthworkData.reduce((sum, item) => {
        return sum + (item.distance * item.cutAvgArea || 0);
    }, 0);
    
    const totalFillVolume = earthworkData.reduce((sum, item) => {
        return sum + (item.distance * item.fillAvgArea || 0);
    }, 0);
    
    if(totalCutVolume === 0 && totalFillVolume === 0){ 
        alert('æ²’æœ‰æœ‰æ•ˆçš„æŒ–æ–¹æˆ–å¡«æ–¹è³‡æ–™ï¼'); 
        return; 
    }
    
    const category = 'å¸¸ç”¨', item = 'æŒ–å¡«æ–¹';
    if(!savedItems[workArea]) savedItems[workArea] = [];
    
    const calculations = []; 
    
    // æŒ–æ–¹è¨ˆç®—å¼
    if(totalCutVolume > 0){ 
        calculations.push({ 
            description: 'æŒ–æ–¹åœŸç©è¨ˆç®—', 
            formula: earthworkData.map(d => `${d.distance.toFixed(2)}Ã—${d.cutAvgArea.toFixed(2)}`).join('+'), 
            result: totalCutVolume 
        }); 
    }
    
    // å¡«æ–¹è¨ˆç®—å¼
    if(totalFillVolume > 0){ 
        calculations.push({ 
            description: 'å¡«æ–¹åœŸç©è¨ˆç®—', 
            formula: earthworkData.map(d => `${d.distance.toFixed(2)}Ã—${d.fillAvgArea.toFixed(2)}`).join('+'), 
            result: totalFillVolume 
        }); 
    }
    
    // ç¸½æ•¸é‡ = æŒ–æ–¹åœŸç© - å¡«æ–¹åœŸç©
    const total = totalCutVolume - totalFillVolume;
    
    // å¦‚æœç¸½æ•¸é‡ç‚ºè² å€¼ï¼Œé¡¯ç¤ºç‚º0ï¼ˆé¿å…è² æ•¸ï¼‰
    const finalTotal = Math.max(0, total);
    
    savedItems[workArea].push({ 
        category, 
        item, 
        calculations, 
        total: finalTotal, 
        timestamp: new Date().toLocaleString('zh-TW') + ' (å¾åœŸçŸ³æ–¹è¨ˆç®—å¸¶å…¥)' 
    });
    
    renderSavedItems();
    document.querySelector('.tab[data-tab="main"]').click();
    alert('åœŸçŸ³æ–¹è³‡æ–™å·²è‡ªå‹•å¸¶å…¥å·¥ç¨‹è¨ˆç®—ç¨¿ç´™çš„ ' + workArea + ' å·¥å€ï¼ç¸½æ•¸é‡ï¼š' + finalTotal.toFixed(2));
}

/* ===========================
   Price table render (æ ¹æ“š savedItems & priceData)
   =========================== */

function renderPriceTables() {
    const container = document.getElementById('priceTablesContainer');
    if (Object.keys(savedItems).length === 0) { 
        container.innerHTML = `<div class="empty-state"><div class="empty-state-icon">ğŸ’°</div><h3>å°šæœªç”¢ç”Ÿå–®åƒ¹åˆ†æè¡¨</h3><p>è«‹å…ˆåœ¨ã€Œå·¥ç¨‹è¨ˆç®—ç¨¿ç´™ã€é ç±¤ä¸­æ–°å¢é …ç›®</p></div>`; 
        priceTableTotals = {};
        return; 
    }
    
    container.innerHTML = '';
    let tableCounter = 1;
    priceTableTotals = {}; // é‡ç½®
    
    Object.keys(savedItems).forEach(workArea => {
        const section = document.createElement('div'); 
        section.className = 'price-table-section';
        section.innerHTML = `<h3>ğŸ—ï¸ ${workArea} - å–®åƒ¹åˆ†æè¡¨</h3>`;
        
        savedItems[workArea].forEach((it, idx) => {
            const wrapper = document.createElement('div'); 
            wrapper.className = 'price-table-wrapper';
            wrapper.id = `price-table-${workArea}-${idx}`;
            
            const projectInDB = projects.find(p => p.name === it.item);
            const priceInfo = projectInDB ? getPriceInfoFromProject(projectInDB) : priceData[it.item];
            
            // è¡¨é ­
            const header = document.createElement('div');
            header.className = 'price-table-header';
            header.innerHTML = `
                <div>è™Ÿæ•¸: ${tableCounter}</div>
                <div>å·¥ç¨‹é …ç›®: ${it.item}</div>
                <div>è¨ˆåƒ¹ç·¨è™Ÿ: ${priceInfo ? priceInfo.code : 'N/A'}</div>
                <div>å–®ä½: ${priceInfo ? priceInfo.unit : 'N/A'}</div>
            `;
            wrapper.appendChild(header);
            
            const table = document.createElement('table'); 
            table.className = 'price-table';
            table.innerHTML = `
                <thead>
                    <tr>
                        <th style="text-align:left">å·¥æ–™é …ç›®</th>
                        <th style="text-align:center">èªªæ˜</th>
                        <th style="text-align:center">å–®ä½</th>
                        <th style="text-align:center">æ•¸é‡</th>
                        <th style="text-align:right">å–®åƒ¹</th>
                        <th style="text-align:right">è¤‡åƒ¹</th>
                        <th style="text-align:center">é™„è¨»</th>
                    </tr>
                </thead>
            `;
            
            const tbody = document.createElement('tbody');
            let tableTotal = 0;
            
            if (priceInfo && priceInfo.items && priceInfo.items.length > 0) {
                priceInfo.items.forEach(mat => {
                    const qty = mat.quantity || 1;
                    const unitPrice = mat.price || 0;
                    const subtotal = qty * unitPrice;
                    tableTotal += subtotal;
                    
                    const tr = document.createElement('tr'); 
                    tr.className = 'material-row';
                    tr.innerHTML = `
                        <td style="text-align:left">${mat.material}</td>
                        <td style="text-align:center">${mat.description || ''}</td>
                        <td style="text-align:center">${mat.unit || ''}</td>
                        <td style="text-align:center">${qty.toFixed(3)}</td>
                        <td style="text-align:right">${unitPrice.toFixed(2)}</td>
                        <td style="text-align:right">${subtotal.toFixed(2)}</td>
                        <td style="text-align:center">${mat.note || ''}</td>
                    `;
                    tbody.appendChild(tr);
                });
                
                // ä¿å­˜å°è¨ˆé‡‘é¡åˆ°å…¨å±€è®Šé‡
                priceTableTotals[it.item] = tableTotal;
                console.log(`ğŸ’¾ ä¿å­˜ ${it.item} å°è¨ˆ: ${tableTotal}`);
                
                // å°è¨ˆè¡Œ
                const trTotal = document.createElement('tr'); 
                trTotal.className = 'total-row';
                trTotal.setAttribute('data-item', it.item);
                trTotal.setAttribute('data-total', tableTotal);
                trTotal.innerHTML = `
                    <td style="text-align:left;font-weight:900" colspan="4">å°è¨ˆ (${it.item})</td>
                    <td style="text-align:right;font-weight:900">&nbsp;</td>
                    <td style="text-align:right;font-weight:900">${tableTotal.toFixed(2)}</td>
                    <td style="text-align:center">&nbsp;</td>
                `;
                tbody.appendChild(trTotal);
                
            } else {
                // æ²’æœ‰å–®åƒ¹è³‡æ–™çš„æƒ…æ³
                const defaultPrice = getDefaultPrice(it.item);
                priceTableTotals[it.item] = defaultPrice;
                
                const tr = document.createElement('tr'); 
                tr.innerHTML = `
                    <td style="text-align:left;padding:20px;color:#e74c3c" colspan="7">
                        <div style="display:flex;justify-content:space-between;align-items:center">
                            <span>âš ï¸ æ­¤é …ç›®ã€Œ${it.item}ã€å°šç„¡å–®åƒ¹è³‡æ–™</span>
                            <button class="btn btn-primary" onclick="createProjectFromPriceTable('${it.item}', '${it.category}')">
                                ğŸ“ ç«‹å³å»ºç«‹å–®åƒ¹åˆ†æ
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            }
            
            table.appendChild(tbody);
            wrapper.appendChild(table);
            section.appendChild(wrapper);
            tableCounter++;
        });
        container.appendChild(section);
    });
    
    console.log('ğŸ’° æ‰€æœ‰å–®åƒ¹è¡¨å°è¨ˆ:', priceTableTotals);
}

/* ===========================
   å–®åƒ¹è¡¨èˆ‡è³‡æ–™åº«é€£å‹•è¼”åŠ©å‡½æ•¸
   =========================== */

// å¾å°ˆæ¡ˆè³‡æ–™ç”Ÿæˆå–®åƒ¹è³‡è¨Š
function getPriceInfoFromProject(project) {
    if (!project || !project.materials || project.materials.length === 0) {
        return null;
    }
    
    const items = [];
    project.materials.forEach(materialId => {
        const material = materials.find(m => m.id === materialId);
        if (material) {
            items.push({
                material: material.name,
                description: material.ignoreRegionalPrice ? 'ï¼ˆå–®åƒ¹éœ€å¦è©¢ï¼‰' : '',
                unit: material.unit,
                quantity: 1,
                price: material.ignoreRegionalPrice ? 0 : material.northPrice, // ä¸æ¡ç´å€åŸŸå–®åƒ¹å‰‡è¨­ç‚º0
                note: material.code + (material.ignoreRegionalPrice ? ' (å–®åƒ¹å¦è¨ˆ)' : '')
            });
        }
    });
    
    return {
        code: project.code,
        unit: project.unit,
        items: items
    };
}

// å¾å–®åƒ¹è¡¨å»ºç«‹æ–°å°ˆæ¡ˆ
function createProjectFromPriceTable(itemName, category) {
    // æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨
    const existingProject = projects.find(p => p.name === itemName);
    if (existingProject) {
        alert(`å·¥ä½œé …ç›®ã€Œ${itemName}ã€å·²å­˜åœ¨æ–¼è³‡æ–™åº«ä¸­ï¼`);
        document.querySelector('.tab[data-tab="database"]').click();
        setTimeout(() => {
            openProjectEdit(existingProject.id);
        }, 500);
        return;
    }
    
    // å»ºç«‹æ–°å°ˆæ¡ˆ
    const newProject = {
        id: Date.now(),
        name: itemName,
        unit: getDefaultUnit(itemName),
        code: generateProjectCode(itemName),
        category: category || 'ä¸€èˆ¬',
        materials: []
    };
    
    projects.push(newProject);
    
    alert(`å·²å»ºç«‹å·¥ä½œé …ç›®ã€Œ${itemName}ã€ï¼Œè«‹åœ¨å–®åƒ¹è³‡æ–™åº«ä¸­å®Œå–„å·¥æ–™è³‡è¨Š`);
    
    // åˆ‡æ›åˆ°è³‡æ–™åº«é ç±¤ä¸¦é‡æ–°æ•´ç†
    document.querySelector('.tab[data-tab="database"]').click();
    setTimeout(() => {
        renderProjects();
        renderPriceTables();
    }, 1000);
}

// æ ¹æ“šé …ç›®åç¨±ç”Ÿæˆé è¨­å–®ä½
function getDefaultUnit(itemName) {
    if (itemName.includes('mÂ³') || itemName.includes('æ··å‡åœŸ') || itemName.includes('åœŸæ–¹') || itemName.includes('æ£„åœŸ')) {
        return 'mÂ³';
    } else if (itemName.includes('æ”¯') || itemName.includes('æ’æ°´å™¨')) {
        return 'æ”¯';
    } else if (itemName.includes('å­”') || itemName.includes('æ¤ç­‹')) {
        return 'å­”';
    } else if (itemName.includes('mÂ²') || itemName.includes('ç¶²')) {
        return 'mÂ²';
    }
    return 'å¼';
}

// ç”Ÿæˆå°ˆæ¡ˆç·¨ç¢¼
function generateProjectCode(itemName) {
    const prefix = 'PRJ';
    const timestamp = Date.now().toString().slice(-6);
    const nameCode = itemName.slice(0, 3).toUpperCase().replace(/[^A-Z]/g, '');
    return `${prefix}${timestamp}${nameCode}`;
}

// å¾å·¥ç¨‹è¨ˆç®—ç¨¿ç´™ç²å–æ‰€æœ‰é …ç›®ï¼ˆç”¨æ–¼è‡ªå‹•åŒ…å«ï¼‰
function getAllItemsFromCalculations() {
    const allItems = [];
    Object.keys(savedItems).forEach(workArea => {
        savedItems[workArea].forEach(item => {
            if (!allItems.find(i => i.name === item.item)) {
                allItems.push({
                    name: item.item,
                    category: item.category,
                    workArea: workArea
                });
            }
        });
    });
    return allItems;
}

// å¾å…¨å±€è®Šé‡ç›´æ¥ç²å–å°è¨ˆé‡‘é¡
function getPriceFromGlobal(itemName) {
    if (priceTableTotals[itemName]) {
        console.log(`ğŸ“Š å¾å…¨å±€è®Šé‡ç²å– ${itemName}: ${priceTableTotals[itemName]}`);
        return priceTableTotals[itemName];
    }
    return null;
}

// ç²å–å–®åƒ¹è¡¨ç¸½é‡‘é¡
function getPriceTableTotal(itemName) {
    console.log('ğŸ” é–‹å§‹æŸ¥æ‰¾é …ç›®å–®åƒ¹:', itemName);
    
    // æ–¹æ³•1ï¼šå¾å…¨å±€è®Šé‡ç²å–ï¼ˆæœ€å¿«ï¼‰
    const priceFromGlobal = getPriceFromGlobal(itemName);
    if (priceFromGlobal !== null) {
        return priceFromGlobal;
    }
    
    // æ–¹æ³•2ï¼šå¾DOMæŸ¥æ‰¾
    const priceFromDOM = getExactPriceFromTable(itemName);
    if (priceFromDOM !== null) {
        return priceFromDOM;
    }
    
    // æ–¹æ³•3ï¼šå¾priceDataè¨ˆç®—
    if (priceData[itemName] && priceData[itemName].items) {
        const total = priceData[itemName].items.reduce((sum, item) => {
            const quantity = parseFloat(item.quantity) || 1;
            const price = parseFloat(item.price) || 0;
            return sum + (quantity * price);
        }, 0);
        return total;
    }
    
    // æ–¹æ³•4ï¼šé è¨­å–®åƒ¹
    return getDefaultPrice(itemName);
}

// ç²¾ç¢ºå¾å–®åƒ¹è¡¨DOMè®€å–å°è¨ˆé‡‘é¡
function getExactPriceFromTable(itemName) {
    try {
        console.log(`ğŸ” åœ¨å–®åƒ¹è¡¨DOMä¸­æŸ¥æ‰¾: "${itemName}"`);
        
        // æŸ¥æ‰¾æ‰€æœ‰å–®åƒ¹è¡¨
        const priceTables = document.querySelectorAll('.price-table');
        
        for (let table of priceTables) {
            // æŸ¥æ‰¾åŒ…å«é …ç›®åç¨±çš„è¡¨é ­
            const header = table.previousElementSibling;
            if (header && header.classList.contains('price-table-header')) {
                const headerText = header.textContent || '';
                if (headerText.includes(itemName)) {
                    console.log(`âœ… æ‰¾åˆ°å°æ‡‰çš„å–®åƒ¹è¡¨: ${itemName}`);
                    
                    // åœ¨è¡¨æ ¼ä¸­æŸ¥æ‰¾å°è¨ˆè¡Œ
                    const totalRows = table.querySelectorAll('tr.total-row');
                    for (let row of totalRows) {
                        const cells = row.querySelectorAll('td');
                        if (cells.length >= 6) {
                            // ç¬¬6å€‹tdæ‡‰è©²æ˜¯å°è¨ˆé‡‘é¡
                            const totalCell = cells[5];
                            const totalText = totalCell.textContent.trim();
                            console.log('å°è¨ˆå–®å…ƒæ ¼å…§å®¹:', totalText);
                            
                            // è§£ææ•¸å­—
                            const totalValue = parseFloat(totalText.replace(/[^\d.]/g, ''));
                            if (!isNaN(totalValue) && totalValue > 0) {
                                console.log(`ğŸ’° æˆåŠŸè§£æå°è¨ˆé‡‘é¡: ${totalValue}`);
                                return totalValue;
                            }
                        }
                    }
                }
            }
        }
        
        console.log(`âŒ åœ¨DOMä¸­æ‰¾ä¸åˆ° ${itemName} çš„å°è¨ˆ`);
        return null;
        
    } catch (error) {
        console.error('è®€å–å–®åƒ¹è¡¨DOMéŒ¯èª¤:', error);
        return null;
    }
}

// é è¨­å–®åƒ¹å°ç…§è¡¨
function getDefaultPrice(itemName) {
    const defaultPrices = {
        'æŒ–å¡«æ–¹': 112.00,
        'é é‹æ£„åœŸ': 350.00,
        'æŒ–æ–¹(æ©Ÿæ¢°æ–½å·¥)': 85.00,
        '140kgf/cm2é æ‹Œæ··å‡åœŸåŠæ¾†æ³¨': 2800.00,
        'é»ç„Šé‹¼çµ²ç¶²': 180.00,
        'é‘½å­”æ¤ç­‹è²»': 450.00
    };
    return defaultPrices[itemName] || 100.00;
}

// ç¢ºä¿æ‰€æœ‰é …ç›®éƒ½æœ‰å–®åƒ¹è³‡æ–™
function ensurePriceDataForAllItems() {
    Object.keys(savedItems).forEach(workArea => {
        savedItems[workArea].forEach(item => {
            const itemName = item.item;
            // å¦‚æœé€™å€‹é …ç›®é‚„æ²’æœ‰å–®åƒ¹è³‡æ–™ï¼Œå»ºç«‹åŸºæœ¬è³‡æ–™
            if (!priceData[itemName] && !projects.find(p => p.name === itemName)) {
                priceData[itemName] = {
                    code: generateProjectCode(itemName),
                    unit: getDefaultUnit(itemName),
                    items: [
                        {
                            material: 'åŸºæœ¬å·¥æ–™',
                            description: 'å¾…å®Œå–„å·¥æ–™åˆ†æ',
                            unit: getDefaultUnit(itemName),
                            quantity: 1,
                            price: getPriceTableTotal(itemName), // ä½¿ç”¨é è¨­å–®åƒ¹
                            note: 'è«‹åœ¨å–®åƒ¹è³‡æ–™åº«ä¸­å®Œå–„å·¥æ–™åˆ†æ'
                        }
                    ]
                };
                console.log(`âœ… ç‚ºé …ç›® ${itemName} å»ºç«‹åŸºæœ¬å–®åƒ¹è³‡æ–™`);
            }
        });
    });
}

/* ===========================
   Modal ç®¡ç†ï¼ˆç¢ºä¿åªé¡¯ç¤ºä¸€å€‹ï¼‰
   =========================== */
function showModal(id){
    // hide others
    document.querySelectorAll('.modal').forEach(m=>{ if(m.id!==id) m.classList.remove('show'); });
    const target = document.getElementById(id);
    target.classList.add('show'); target.setAttribute('aria-hidden','false');
    ensureSingleModal();
}
function hideModal(id){
    const m=document.getElementById(id);
    if(m){ m.classList.remove('show'); m.setAttribute('aria-hidden','true'); }
}
function ensureSingleModal(){
    const shown = Array.from(document.querySelectorAll('.modal.show'));
    if(shown.length>1) shown.slice(1).forEach(m=>m.classList.remove('show'));
}

// ç‚ºç·¨è¼¯å’Œè¿½åŠ æ¨¡æ…‹æ¡†æ·»åŠ é—œé–‰æŒ‰éˆ•äº‹ä»¶
document.getElementById('closeEditCalculationModal').addEventListener('click', ()=>{ 
    currentEditIndex = null; 
    hideModal('editCalculationModal'); 
});
document.getElementById('cancelEditCalculationBtn').addEventListener('click', ()=>{ 
    currentEditIndex = null; 
    hideModal('editCalculationModal'); 
});
document.getElementById('closeAppendCalculationModal').addEventListener('click', ()=>{ 
    currentEditIndex = null; 
    hideModal('appendCalculationModal'); 
});
document.getElementById('cancelAppendCalculationBtn').addEventListener('click', ()=>{ 
    currentEditIndex = null; 
    hideModal('appendCalculationModal'); 
});

// ç‚ºproject modalæ·»åŠ é—œé–‰äº‹ä»¶
document.getElementById('closeProjectModal').addEventListener('click', ()=>{ 
    editingProjectId=null; 
    currentEditIndex=null; 
    hideModal('projectModal'); 
});
document.getElementById('cancelProjectBtn').addEventListener('click', ()=>{ 
    editingProjectId=null; 
    currentEditIndex=null; 
    hideModal('projectModal'); 
});

/* ===========================
   æ–°å¢åŠŸèƒ½ï¼šæ•¸é‡è¡¨é€£å‹•
   =========================== */

// è³‡æ–™å½™é›†åŠŸèƒ½ - å°‡å·¥ç¨‹è¨ˆç®—ç¨¿ç´™çš„è³‡æ–™å¸¶å…¥æ•¸é‡è¡¨
function collectQuantityData() {
    // æª¢æŸ¥æ˜¯å¦æœ‰è³‡æ–™å¯åŒ¯å…¥
    if (Object.keys(savedItems).length === 0) {
        alert('å·¥ç¨‹è¨ˆç®—ç¨¿ç´™ä¸­å°šç„¡è³‡æ–™ï¼Œè«‹å…ˆæ–°å¢è¨ˆç®—é …ç›®ï¼');
        return;
    }
    
    // æ›´æ–°æ•¸é‡è¡¨
    updateQuantityTable();
    
    // æ›´æ–°æ•¸é‡è¡¨(ç›´å¼)
    updateVerticalTable();
    
    // é¡¯ç¤ºè¡¨æ ¼ï¼Œéš±è—ç©ºç‹€æ…‹æç¤º
    document.getElementById('quantityTableContainer').style.display = 'block';
    document.getElementById('quantityEmptyState').style.display = 'none';
    
    // é¡¯ç¤ºæˆåŠŸè¨Šæ¯
    const alert = document.getElementById('dataCollectionAlert');
    alert.style.display = 'block';
    setTimeout(() => {
        alert.style.display = 'none';
    }, 3000);
}

// æ›´æ–°æ•¸é‡è¡¨ - å‹•æ…‹æ ¹æ“šå·¥ç¨‹è¨ˆç®—ç¨¿ç´™çš„é …ç›®ç”Ÿæˆè¡¨é ­
function updateQuantityTable() {
    const table = document.getElementById('quantityTable');
    const thead = table.querySelector('thead');
    const tbody = document.getElementById('quantityTableBody');
    
    // æ¸…ç©ºç¾æœ‰å…§å®¹
    tbody.innerHTML = '';
    
    // æ”¶é›†æ‰€æœ‰å·¥ç¨‹è¨ˆç®—ç¨¿ç´™ä¸­çš„é …ç›®ï¼ˆä¸é‡è¤‡ï¼‰
    const allItems = new Set();
    Object.keys(savedItems).forEach(workArea => {
        savedItems[workArea].forEach(item => {
            allItems.add(item.item);
        });
    });
    
    const itemsArray = Array.from(allItems);
    
    // å¦‚æœæ²’æœ‰è³‡æ–™ï¼Œé¡¯ç¤ºç©ºè¡¨
    if (itemsArray.length === 0) {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td class="project-name">ç„¡è³‡æ–™</td>
            <td></td><td></td><td></td><td></td><td></td>
            <td></td><td></td><td></td><td></td><td></td><td></td>
        `;
        tbody.appendChild(tr);
        return;
    }
    
    // é‡æ–°ç”Ÿæˆè¡¨é ­ï¼ˆä¿æŒä¸‰åˆ—çµæ§‹ï¼‰
    thead.innerHTML = '';
    
    // ç¬¬ä¸€åˆ—è¡¨é ­
    const headerRow1 = document.createElement('tr');
    let header1HTML = `
        <th rowspan="4" style="width: 250px; height: 120px; position: relative; padding: 0;">
            <div class="diagonal-line">
                <svg>
                    <line x1="0" y1="0" x2="100%" y2="50%" stroke="black" stroke-width="1"/>
                    <line x1="0" y1="0" x2="100%" y2="75%" stroke="black" stroke-width="1"/>
                    <line x1="0" y1="0" x2="100%" y2="100%" stroke="black" stroke-width="1"/>
                </svg>
            </div>
            <span class="label-top" style="top: 3px; right: 15px;">é …ç›®</span>
            <span class="label-bottom" style="top: 22px; left: 80px;">èªªæ˜</span>
            <span class="label-bottom" style="top: 50px; left: 100px;">å–®ä½</span>
            <span class="label-bottom" style="bottom: 8px; left: 10px;">å·¥ç¨‹åç¨±</span>
        </th>
    `;
    
    // å‹•æ…‹æ·»åŠ é …ç›®åç¨±
    itemsArray.forEach(itemName => {
        header1HTML += `<th>${itemName}</th>`;
    });
    
    // è£œé½Šå‰©é¤˜æ¬„ä½ï¼ˆä¿æŒ12æ¬„ï¼‰
    const remainingCols = 12 - itemsArray.length;
    for (let i = 0; i < remainingCols; i++) {
        header1HTML += '<th></th>';
    }
    
    headerRow1.innerHTML = header1HTML;
    thead.appendChild(headerRow1);
    
    // ç¬¬äºŒåˆ—è¡¨é ­ï¼ˆç©ºè¡Œï¼‰
    const headerRow2 = document.createElement('tr');
    let header2HTML = '';
    for (let i = 0; i < 12; i++) {
        header2HTML += '<th></th>';
    }
    headerRow2.innerHTML = header2HTML;
    thead.appendChild(headerRow2);
    
    // ç¬¬ä¸‰åˆ—è¡¨é ­ï¼ˆå–®ä½ï¼‰
    const headerRow3 = document.createElement('tr');
    let header3HTML = '';
    
    // ç‚ºæ¯å€‹é …ç›®æ·»åŠ å–®ä½
    itemsArray.forEach(itemName => {
        // æ ¹æ“šé …ç›®åç¨±åˆ¤æ–·å–®ä½
        let unit = 'å¼'; // é è¨­å–®ä½
        if (itemName.includes('mÂ³') || itemName.includes('æ··å‡åœŸ') || itemName.includes('åœŸæ–¹') || itemName.includes('æ£„åœŸ')) {
            unit = 'mÂ³';
        } else if (itemName.includes('æ”¯') || itemName.includes('æ’æ°´å™¨')) {
            unit = 'æ”¯';
        } else if (itemName.includes('å­”') || itemName.includes('æ¤ç­‹')) {
            unit = 'å­”';
        } else if (itemName.includes('mÂ²') || itemName.includes('ç¶²')) {
            unit = 'mÂ²';
        }
        header3HTML += `<th>${unit}</th>`;
    });
    
    // è£œé½Šå‰©é¤˜æ¬„ä½
    for (let i = 0; i < remainingCols; i++) {
        header3HTML += '<th></th>';
    }
    
    headerRow3.innerHTML = header3HTML;
    thead.appendChild(headerRow3);
    
    // ç”Ÿæˆè³‡æ–™è¡Œ
    Object.keys(savedItems).forEach(workArea => {
        const tr = document.createElement('tr');
        
        // å·¥ç¨‹åç¨±æ¬„ä½
        tr.innerHTML = `<td class="project-name">${workArea}</td>`;
        
        // ç‚ºæ¯å€‹é …ç›®æ·»åŠ æ•¸é‡è³‡æ–™
        itemsArray.forEach(itemName => {
            const itemData = savedItems[workArea].find(item => item.item === itemName);
            const quantity = itemData ? itemData.total.toFixed(2) : '';
            tr.innerHTML += `<td>${quantity}</td>`;
        });
        
        // è£œé½Šå‰©é¤˜çš„ç©ºæ¬„ä½
        for (let i = 0; i < remainingCols; i++) {
            tr.innerHTML += '<td></td>';
        }
        
        tbody.appendChild(tr);
    });
}

// æ›´æ–°æ•¸é‡è¡¨(ç›´å¼) - å®Œå…¨æŒ‰ç…§å·¥ç¨‹è¨ˆç®—ç¨¿ç´™é †åº
function updateVerticalTable() {
    console.log('é–‹å§‹æ›´æ–°ç›´å¼æ•¸é‡è¡¨');
    
    const tbody = document.getElementById('verticalTableBody');
    if (!tbody) {
        console.error('æ‰¾ä¸åˆ° verticalTableBody å…ƒç´ ');
        return;
    }
    
    tbody.innerHTML = '';
    
    let itemCounter = 1;
    
    // ç›´æ¥æŒ‰ç…§å·¥ç¨‹è¨ˆç®—ç¨¿ç´™çš„åŸå§‹é †åºéæ­·
    Object.keys(savedItems).forEach(workArea => {
        console.log('è™•ç†å·¥å€:', workArea, 'é …ç›®æ•¸é‡:', savedItems[workArea].length);
        
        savedItems[workArea].forEach((item, index) => {
            console.log('æ·»åŠ é …ç›®:', item.item, 'æ•¸é‡:', item.total);
            
            const tr = document.createElement('tr');
            
            // ç·¨è™Ÿ
            const td1 = document.createElement('td');
            td1.textContent = itemCounter++;
            td1.style.padding = '12px 14px';
            td1.style.borderBottom = '1px solid #eee';
            td1.style.verticalAlign = 'middle';
            tr.appendChild(td1);
            
            // å·¥ç¨‹é …ç›®
            const td2 = document.createElement('td');
            td2.textContent = item.item;
            td2.style.padding = '12px 14px';
            td2.style.borderBottom = '1px solid #eee';
            td2.style.verticalAlign = 'middle';
            tr.appendChild(td2);
            
            // èªªæ˜ï¼ˆé¡¯ç¤ºå·¥å€ï¼‰
            const td3 = document.createElement('td');
            td3.textContent = workArea;
            td3.style.padding = '12px 14px';
            td3.style.borderBottom = '1px solid #eee';
            td3.style.verticalAlign = 'middle';
            tr.appendChild(td3);
            
            // å–®ä½
            const td4 = document.createElement('td');
            let unit = 'å¼';
            if (item.item.includes('mÂ³') || item.item.includes('æŒ–å¡«æ–¹') || item.item.includes('æ£„åœŸ') || item.item.includes('æ··å‡åœŸ')) {
                unit = 'mÂ³';
            } else if (item.item.includes('æ”¯')) {
                unit = 'æ”¯';
            } else if (item.item.includes('å­”') || item.item.includes('æ¤ç­‹')) {
                unit = 'å­”';
            } else if (item.item.includes('mÂ²') || item.item.includes('ç¶²')) {
                unit = 'mÂ²';
            }
            td4.textContent = unit;
            td4.style.padding = '12px 14px';
            td4.style.borderBottom = '1px solid #eee';
            td4.style.verticalAlign = 'middle';
            tr.appendChild(td4);
            
            // æ•¸é‡
            const td5 = document.createElement('td');
            td5.textContent = item.total.toFixed(2);
            td5.style.padding = '12px 14px';
            td5.style.borderBottom = '1px solid #eee';
            td5.style.verticalAlign = 'middle';
            tr.appendChild(td5);
            
            tbody.appendChild(tr);
        });
    });
    
    // å¦‚æœæ²’æœ‰è³‡æ–™ï¼Œé¡¯ç¤ºç¯„ä¾‹
    if (itemCounter === 1) {
        console.log('æ²’æœ‰è³‡æ–™ï¼Œé¡¯ç¤ºç¯„ä¾‹');
        tbody.innerHTML = `
            <tr>
                <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle">1</td>
                <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle">æŒ–å¡«æ–¹</td>
                <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle">é¾œå±±å¤§é™‚åœ³æ°´é–€æ›´æ–°æ”¹å–„</td>
                <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle">mÂ³</td>
                <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle">709.00</td>
            </tr>
        `;
    }
    
    console.log('ç›´å¼æ•¸é‡è¡¨æ›´æ–°å®Œæˆï¼Œå…±', itemCounter - 1, 'å€‹é …ç›®');
}

// ä¿®æ”¹å·¥ç¨‹è³‡æ–™å½™é›†åŠŸèƒ½
function collectProjectData() {
    if (Object.keys(savedItems).length === 0) {
        alert('å·¥ç¨‹è¨ˆç®—ç¨¿ç´™ä¸­å°šç„¡è³‡æ–™ï¼Œè«‹å…ˆæ–°å¢è¨ˆç®—é …ç›®ï¼');
        return;
    }
    
    console.log('ğŸ”„ é–‹å§‹å·¥ç¨‹è³‡æ–™å½™é›†...');
    
    renderPriceTables();
    
    setTimeout(() => {
        updateBasicDataTable();
        
        // åˆå§‹åŒ–è²»ç”¨ç›£è½å™¨
        initializeAllFeeListeners();
        
        document.getElementById('basicDataTableContainer').style.display = 'block';
        document.getElementById('basicDataEmptyState').style.display = 'none';
        
        alert('å·¥ç¨‹è³‡æ–™å½™é›†å®Œæˆï¼ç¾åœ¨åŸºæœ¬è³‡æ–™è¡¨åŒ…å«æ‰€æœ‰å·¥ç¨‹é …ç›®å’Œè²»ç”¨é …ç›®ã€‚');
    }, 800);
}

function updateBasicDataTable() {
    console.log('ğŸ”„ é–‹å§‹æ›´æ–°åŸºæœ¬è³‡æ–™è¡¨...');
    
    const tbody = document.getElementById('basicDataTableBody');
    if (!tbody) {
        console.error('æ‰¾ä¸åˆ° basicDataTableBody å…ƒç´ ');
        return;
    }
    
    tbody.innerHTML = '';
    
    const allItems = [];
    
    // 1. æ·»åŠ å·¥ç¨‹è¨ˆç®—ç¨¿ç´™çš„é …ç›®
    Object.keys(savedItems).forEach(workArea => {
        savedItems[workArea].forEach(item => {
            allItems.push({
                workArea: workArea,
                name: item.item,
                quantity: item.total,
                category: item.category,
                type: 'å·¥ç¨‹é …ç›®'
            });
        });
    });
    
    // 2. æ·»åŠ è·æ¥­å®‰å…¨è¡›ç”Ÿè²»é …ç›®
    console.log('ğŸ”§ æ·»åŠ è·æ¥­å®‰å…¨è¡›ç”Ÿè²»é …ç›®...');
    const safetyItems = [
        { name: 'å¤œé–“ç…§æ˜ç‡ˆå…·', description: 'æŠ˜èˆŠèˆ‡æè€—', unit: 'ç›' },
        { name: 'äº¤é€šéŒ', description: 'æŠ˜èˆŠèˆ‡æè€—', unit: 'å€‹' },
        { name: 'å®‰å…¨è­¦ç¤ºç‡ˆ', description: 'æŠ˜èˆŠèˆ‡æè€—', unit: 'çµ„' },
        { name: 'è­¦å‘Šæ¨™ç¤ºç‰Œ', description: 'æŠ˜èˆŠèˆ‡æè€—', unit: 'çµ„' }
    ];
    
    safetyItems.forEach(item => {
        const checkbox = document.getElementById(getCheckboxId(item.name));
        if (checkbox && checkbox.checked) {
            // å¾è·æ¥­å®‰å…¨è¡›ç”Ÿè²»è¡¨æ ¼ä¸­è®€å–è³‡æ–™
            const safetyTable = document.querySelector('#basic .card:nth-child(2) table tbody');
            if (safetyTable) {
                const rows = safetyTable.querySelectorAll('tr');
                rows.forEach(row => {
                    const firstCell = row.querySelector('td:first-child');
                    if (firstCell && firstCell.textContent.includes(item.name)) {
                        const cells = row.querySelectorAll('td');
                        if (cells.length >= 6) {
                            const quantityInput = cells[3].querySelector('input');
                            const quantity = quantityInput ? parseFloat(quantityInput.value) || 0 : 0;
                            const unitPrice = parseFloat(cells[4].textContent.replace(/,/g, '')) || 0;
                            const totalPrice = quantity * unitPrice;
                            
                            allItems.push({
                                workArea: 'å®‰å…¨è¡›ç”Ÿè¨­æ–½',
                                name: item.name,
                                description: item.description,
                                unit: item.unit,
                                quantity: quantity,
                                unitPrice: unitPrice,
                                totalPrice: totalPrice,
                                type: 'å®‰å…¨è¡›ç”Ÿè²»'
                            });
                        }
                    }
                });
            }
        }
    });
    
    // 3. æ·»åŠ ç’°å¢ƒä¿è­·æªæ–½è²»é …ç›®
    console.log('ğŸŒ¿ æ·»åŠ ç’°å¢ƒä¿è­·æªæ–½è²»é …ç›®...');
    const envItems = [
        { name: 'ç’°ä¿ç®¡ç†äººå“¡äººäº‹è²»', description: 'ç’°ä¿ç®¡ç†', unit: 'å…¨' },
        { name: 'å·¥åœ°æ¸…æ½”è²»', description: 'ç’°å¢ƒæ¸…æ½”ç¶­è­·', unit: 'å…¨' },
        { name: 'å·¥åœ°ç‘æ°´è²»', description: 'ç‘æ°´é˜²å¡µ', unit: 'å…¨' }
    ];
    
    envItems.forEach(item => {
        const checkbox = document.getElementById(getCheckboxId(item.name));
        if (checkbox && checkbox.checked) {
            // å¾ç’°å¢ƒä¿è­·æªæ–½è²»è¡¨æ ¼ä¸­è®€å–è³‡æ–™
            const envTable = document.querySelector('#basic .card:nth-child(3) table tbody');
            if (envTable) {
                const rows = envTable.querySelectorAll('tr');
                rows.forEach(row => {
                    const firstCell = row.querySelector('td:first-child');
                    if (firstCell && firstCell.textContent.includes(item.name)) {
                        const cells = row.querySelectorAll('td');
                        if (cells.length >= 6) {
                            const quantityInput = cells[3].querySelector('input');
                            const quantity = quantityInput ? parseFloat(quantityInput.value) || 0 : 0;
                            const unitPrice = parseFloat(cells[4].textContent.replace(/,/g, '')) || 0;
                            const totalPrice = quantity * unitPrice;
                            
                            allItems.push({
                                workArea: 'ç’°ä¿æªæ–½',
                                name: item.name,
                                description: item.description,
                                unit: item.unit,
                                quantity: quantity,
                                unitPrice: unitPrice,
                                totalPrice: totalPrice,
                                type: 'ç’°ä¿æªæ–½è²»'
                            });
                        }
                    }
                });
            }
        }
    });
    
    console.log('ğŸ“Š æ‰€æœ‰é …ç›®æ•¸é‡:', allItems.length);
    
    // ç”Ÿæˆè¡¨æ ¼è¡Œ - é¡¯ç¤ºæ‰€æœ‰é …ç›®
    allItems.forEach((item, index) => {
        const tr = document.createElement('tr');
        
        // å°æ–¼å·¥ç¨‹é …ç›®ï¼Œéœ€è¦è¨ˆç®—å–®åƒ¹å’Œç¸½åƒ¹
        let unitPrice = item.unitPrice;
        let totalPrice = item.totalPrice;
        
        if (item.type === 'å·¥ç¨‹é …ç›®') {
            unitPrice = getPriceTableTotal(item.name);
            totalPrice = item.quantity * unitPrice;
        }
        
        tr.innerHTML = `
            <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle">${item.name}</td>
            <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle">${item.workArea}</td>
            <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle">${getUnitByItemName(item.name)}</td>
            <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle">${item.quantity.toFixed(2)}</td>
            <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle">${unitPrice.toFixed(2)}</td>
            <td style="padding:12px 14px;border-bottom:1px solid #eee;vertical-align:middle">${totalPrice.toFixed(2)}</td>
        `;
        
        tbody.appendChild(tr);
    });
    
    // è¨ˆç®—è·æ¥­å®‰å…¨è¡›ç”Ÿè²»å’Œç’°å¢ƒä¿è­·æªæ–½è²»çš„ç¸½å’Œ
    let safetyEnvironmentTotal = 0;
    
    // è¨ˆç®—è·æ¥­å®‰å…¨è¡›ç”Ÿè²»
    const safetyTable = document.querySelector('#basic .card:nth-child(2) table tbody');
    if (safetyTable) {
        const safetyRows = safetyTable.querySelectorAll('tr');
        safetyRows.forEach(row => {
            if (row.style.display !== 'none') {
                const cells = row.querySelectorAll('td');
                if (cells.length >= 6) {
                    const amountText = cells[5].textContent.trim();
                    const amount = parseFloat(amountText.replace(/,/g, '')) || 0;
                    safetyEnvironmentTotal += amount;
                }
            }
        });
    }
    
    // è¨ˆç®—ç’°å¢ƒä¿è­·æªæ–½è²»
    const envTable = document.querySelector('#basic .card:nth-child(3) table tbody');
    if (envTable) {
        const envRows = envTable.querySelectorAll('tr');
        envRows.forEach(row => {
            if (row.style.display !== 'none') {
                const cells = row.querySelectorAll('td');
                if (cells.length >= 6) {
                    const amountText = cells[5].textContent.trim();
                    const amount = parseFloat(amountText.replace(/,/g, '')) || 0;
                    safetyEnvironmentTotal += amount;
                }
            }
        });
    }
    
    console.log('ğŸ’° è·æ¥­å®‰å…¨è¡›ç”Ÿè²» + ç’°å¢ƒä¿è­·æªæ–½è²»ç¸½å’Œ:', safetyEnvironmentTotal);
    
    // æ›´æ–°å°è¨ˆé¡¯ç¤º
    const subtotalElement = document.getElementById('safetyEnvSubtotal');
    if (subtotalElement) {
        subtotalElement.textContent = safetyEnvironmentTotal.toFixed(2);
    }
}

// è¼”åŠ©å‡½æ•¸ï¼šæ ¹æ“šé …ç›®åç¨±ç²å–å–®ä½
function getUnitByItemName(itemName) {
    const unitMap = {
        'æŒ–å¡«æ–¹': 'mÂ³',
        'é é‹æ£„åœŸ': 'mÂ³',
        'é é‹æ£„åœŸ': 'mÂ³', 
        'æŒ–æ–¹(æ©Ÿæ¢°æ–½å·¥)': 'mÂ³',
        '140kgf/cm2é æ‹Œæ··å‡åœŸåŠæ¾†æ³¨': 'mÂ³',
        'é»ç„Šé‹¼çµ²ç¶²': 'mÂ²',
        'é‘½å­”æ¤ç­‹è²»': 'å­”'
    };
    return unitMap[itemName] || 'å¼';
}

// æ›´æ–°é ç®—ç¸½é¡é¡¯ç¤º
function updateBudgetTotalDisplay(totalAmount) {
    const budgetTotalElement = document.getElementById('budgetTotalDisplay');
    if (budgetTotalElement) {
        budgetTotalElement.textContent = `æœ¬å·¥ç¨‹é ç®—ç¸½é¡æ–°å°å¹£ï¼š${totalAmount.toFixed(2)} å…ƒ`;
    }
}


/* ===========================
   è³‡æ–™åŒæ­¥æ©Ÿåˆ¶
   =========================== */

// ç•¶å–®åƒ¹è³‡æ–™åº«æ›´æ–°æ™‚ï¼Œé‡æ–°æ•´ç†å·¥ç¨‹é ç®—æ›¸çš„å–®åƒ¹
function syncUnitPriceToBudget() {
    // åªæœ‰åœ¨å·¥ç¨‹é ç®—æ›¸é ç±¤é¡¯ç¤ºæ™‚æ‰æ›´æ–°
    const basicTab = document.getElementById('basic');
    if (basicTab && basicTab.classList.contains('active')) {
        updateBasicDataTable();
    }
}

/* ===========================
   åˆå§‹åŒ–ç•«é¢
   =========================== */
initCalcRows();
initEarthwork();
renderProjects();
renderMaterials();
renderSavedItems();
renderPriceTables();

// è¨­ç½®è²»ç”¨ç›£è½å™¨ï¼ˆé é¢è¼‰å…¥æ™‚ï¼‰
setTimeout(() => {
    initializeAllFeeListeners();
}, 1000);

// å°å·¥å…·ï¼šé¿å…å¤šå€‹ modal åŒæ™‚é¡¯ç¤ºï¼ˆå®šæœŸæª¢æŸ¥ï¼‰
setInterval(ensureSingleModal, 400);

// è³‡æ–™å½™é›†æŒ‰éˆ•åŠŸèƒ½
document.getElementById('collectData').addEventListener('click', collectQuantityData);

// å·¥ç¨‹è³‡æ–™å½™é›†åŠŸèƒ½
document.getElementById('collectProjectData').addEventListener('click', collectProjectData);

// ç¶å®šäº‹ä»¶ç›£è½å™¨
document.getElementById('compileBudget').addEventListener('click', compileBudgetData);

// é é¢è¼‰å…¥æ™‚è¨­ç½®ç›£è½å™¨
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(() => {
        setupFeeQuantityListeners();
        setupFeeCheckboxListeners();
        updateBasicDataTable(); // åˆå§‹åŒ–è¨ˆç®—
    }, 1000);
});

// å–®ä½æ•¸é‡è®ŠåŒ–æ™‚è‡ªå‹•é‡æ–°è¨ˆç®—
document.addEventListener('input', function(e) {
    if (e.target.id === 'unitQuantity') {
        calculateProjectTotalPreview();
    }
});

/* ===========================
   Autocomplete åŠŸèƒ½
   =========================== */

// åˆå§‹åŒ– autocomplete
function initMaterialAutocomplete() {
    const input = document.getElementById('materialAutoComplete');
    const autocompleteList = document.getElementById('materialAutocompleteList');
    
    if (!input) return;
    
    // ç§»é™¤èˆŠçš„äº‹ä»¶ç›£è½å™¨
    input.removeEventListener('input', handleMaterialSearch);
    input.removeEventListener('keydown', handleMaterialKeydown);
    
    // æ·»åŠ æ–°çš„äº‹ä»¶ç›£è½å™¨
    input.addEventListener('input', handleMaterialSearch);
    input.addEventListener('keydown', handleMaterialKeydown);
    
    // é»æ“Šå…¶ä»–åœ°æ–¹é—œé–‰ autocomplete
    document.addEventListener('click', function(e) {
        if (!autocompleteList.contains(e.target) && e.target !== input) {
            autocompleteList.innerHTML = '';
        }
    });
}

// è™•ç†æœå°‹è¼¸å…¥
function handleMaterialSearch(e) {
    const input = e.target;
    const searchTerm = input.value.trim().toLowerCase();
    const autocompleteList = document.getElementById('materialAutocompleteList');
    
    // æ¸…ç©ºä¹‹å‰çš„çµæœ
    autocompleteList.innerHTML = '';
    
    if (searchTerm.length < 1) return;
    
    // éæ¿¾å·¥æ–™
    const filteredMaterials = materials.filter(material => 
        material.name.toLowerCase().includes(searchTerm) ||
        material.code.toLowerCase().includes(searchTerm)
    );
    
    // é¡¯ç¤ºæœ€å¤š 10 å€‹çµæœ
    filteredMaterials.slice(0, 10).forEach(material => {
        const div = document.createElement('div');
        div.innerHTML = `
            <strong>${material.name}</strong> 
            <span style="float:right;color:#666;font-size:12px">
                å–®ä½: ${material.unit} | ç·¨ç¢¼: ${material.code}
            </span>
        `;
        div.dataset.materialId = material.id;
        
        div.addEventListener('click', function() {
            addMaterialToSelection(material.id);
            input.value = '';
            autocompleteList.innerHTML = '';
        });
        
        autocompleteList.appendChild(div);
    });
}

// è™•ç†éµç›¤æ“ä½œ
function handleMaterialKeydown(e) {
    const autocompleteList = document.getElementById('materialAutocompleteList');
    const items = autocompleteList.querySelectorAll('div');
    let currentFocus = -1;
    
    if (e.keyCode === 40) { // å‘ä¸‹ç®­é ­
        currentFocus++;
        addActive(items);
    } else if (e.keyCode === 38) { // å‘ä¸Šç®­é ­
        currentFocus--;
        addActive(items);
    } else if (e.keyCode === 13) { // Enter
        e.preventDefault();
        if (currentFocus > -1 && items[currentFocus]) {
            items[currentFocus].click();
        }
    }
    
    function addActive(items) {
        if (!items) return false;
        removeActive(items);
        if (currentFocus >= items.length) currentFocus = 0;
        if (currentFocus < 0) currentFocus = (items.length - 1);
        items[currentFocus].classList.add('autocomplete-active');
    }
    
    function removeActive(items) {
        items.forEach(item => item.classList.remove('autocomplete-active'));
    }
}

// æ·»åŠ å·¥æ–™åˆ°é¸æ“‡åˆ—è¡¨
function addMaterialToSelection(materialId) {
    const material = materials.find(m => m.id === materialId);
    if (!material) return;
    
    // æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨
    const existingRows = document.querySelectorAll('#materialSelectionRows .material-select-row');
    for (let row of existingRows) {
        const checkbox = row.querySelector('.material-checkbox');
        if (checkbox && parseInt(checkbox.value) === materialId) {
            // å¦‚æœå·²å­˜åœ¨ï¼Œåªå‹¾é¸
            checkbox.checked = true;
            // æ›´æ–°è¤‡åƒ¹
            updateMaterialRowSubtotal(row);
            calculateProjectTotalPreview();
            return;
        }
    }
    
    // å¦‚æœä¸å­˜åœ¨ï¼Œæ–°å¢è¡Œ
    const container = document.getElementById('materialSelectionRows');
    const div = document.createElement('div');
    div.className = 'material-select-row';
    div.style.display = 'flex';
    div.style.alignItems = 'center';
    div.style.padding = '10px';
    div.style.borderBottom = '1px solid #eee';
    
    // æª¢æŸ¥æ˜¯å¦éœ€è¦é¡¯ç¤ºå€åŸŸå–®åƒ¹
    const shouldShowPrice = !material.ignoreRegionalPrice;
    const priceValue = shouldShowPrice ? material.northPrice : '';
    
    div.innerHTML = `
        <div style="flex:2; text-align:left;">
            <label style="cursor:pointer">
                <input type="checkbox" class="material-checkbox" value="${material.id}" style="margin-right:8px" checked> 
                ${material.name}
                ${material.ignoreRegionalPrice ? '<span style="color:#e74c3c; font-size:11px; margin-left:5px;">(éœ€æ‰‹å‹•è¼¸å…¥å–®åƒ¹)</span>' : ''}
            </label>
        </div>
        <div style="flex:1; text-align:center;">${material.unit}</div>
        <div style="flex:1; text-align:center;">${material.code}</div>
        <div style="flex:1; text-align:center;">
            <input type="number" class="material-price" value="${priceValue}" step="0.01" 
                   style="width:80px;padding:6px;border:1px solid #ddd;border-radius:6px"
                   ${shouldShowPrice ? 'readonly' : ''}>
        </div>
        <div style="flex:1; text-align:center;">
            <input type="number" class="material-qty" value="1" step="0.001" 
                   style="width:80px;padding:6px;border:1px solid #ddd;border-radius:6px">
        </div>
        <div style="flex:1; text-align:center;">
            <input type="number" class="material-subtotal" value="${shouldShowPrice ? material.northPrice : ''}" step="0.01" 
                   style="width:80px;padding:6px;border:1px solid #ddd;border-radius:6px" readonly>
        </div>
        <div style="flex:0.5; text-align:center;">
            <button class="btn btn-danger" style="padding:4px 8px;font-size:12px" 
                    onclick="removeMaterialRow(this)">âœ•</button>
        </div>
    `;
    
    container.appendChild(div);
    
    // è¨­ç½®è¼¸å…¥æ¡†ç‹€æ…‹
    const priceInput = div.querySelector('.material-price');
    const qtyInput = div.querySelector('.material-qty');
    const subtotalInput = div.querySelector('.material-subtotal');
    
    if (material.ignoreRegionalPrice) {
        priceInput.style.backgroundColor = '#fff';
        priceInput.style.cursor = 'text';
        priceInput.readOnly = false;
        priceInput.placeholder = 'è«‹è¼¸å…¥å–®åƒ¹';
    } else {
        priceInput.style.backgroundColor = '#f8f9fa';
        priceInput.style.cursor = 'not-allowed';
        priceInput.readOnly = true;
    }
    
    subtotalInput.style.backgroundColor = '#f8f9fa';
    subtotalInput.style.cursor = 'not-allowed';
    subtotalInput.readOnly = true;
    
    // ç¶å®šäº‹ä»¶
    const calculateSubtotal = () => {
        const price = parseFloat(priceInput.value) || 0;
        const qty = parseFloat(qtyInput.value) || 0;
        const subtotal = price * qty;
        subtotalInput.value = subtotal.toFixed(2);
        calculateProjectTotalPreview();
    };
    
    qtyInput.addEventListener('input', calculateSubtotal);
    priceInput.addEventListener('input', calculateSubtotal);
    div.querySelector('.material-checkbox').addEventListener('change', calculateProjectTotalPreview);
    
    // åˆå§‹è¨ˆç®—
    calculateSubtotal();
}

// åˆªé™¤å·¥æ–™è¡Œ
function removeMaterialRow(button) {
    const row = button.closest('.material-select-row');
    if (row) {
        row.remove();
        calculateProjectTotalPreview();
    }
}

// æ›´æ–°è¤‡åƒ¹è¨ˆç®—
function updateMaterialRowSubtotal(row) {
    const priceInput = row.querySelector('.material-price');
    const qtyInput = row.querySelector('.material-qty');
    const subtotalInput = row.querySelector('.material-subtotal');
    
    if (priceInput && qtyInput && subtotalInput) {
        const price = parseFloat(priceInput.value) || 0;
        const qty = parseFloat(qtyInput.value) || 0;
        const subtotal = price * qty;
        subtotalInput.value = subtotal.toFixed(2);
    }
}

// ä¿®æ”¹ populateMaterialSelection å‡½æ•¸ï¼ŒåŠ å…¥åˆªé™¤æŒ‰éˆ•
function populateMaterialSelection() {
    const container = document.getElementById('materialSelectionRows');
    container.innerHTML = '';
    
    // åˆå§‹åŒ– autocomplete
    initMaterialAutocomplete();
}

// ä¿®æ”¹ showModal å‡½æ•¸ï¼Œç¢ºä¿æ¯æ¬¡é¡¯ç¤º modal æ™‚éƒ½åˆå§‹åŒ– autocomplete
const originalShowModal = showModal;
showModal = function(id) {
    originalShowModal(id);
    if (id === 'projectModal') {
        // å»¶é²ä¸€é»ç¢ºä¿ DOM å·²è¼‰å…¥
        setTimeout(() => {
            initMaterialAutocomplete();
        }, 100);
    }
};

// æ›´æ–°å·¥æ–™é …ç›®ç¯©é¸é‚è¼¯
document.getElementById('materialSharedFilter').addEventListener('change', renderMaterials);

// æ›´æ–°å·¥ä½œé …ç›®ç¯©é¸é‚è¼¯
document.getElementById('projectSharedFilter').addEventListener('change', renderProjects);

</script>
</body>
</html>