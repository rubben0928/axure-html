<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>台中市公園稽查管理系統</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-color: #2c8c5a;
            --primary-light: #e8f5ee;
            --secondary-color: #2a6fa5;
            --danger-color: #e74c3c;
            --warning-color: #f39c12;
            --success-color: #27ae60;
            --gray-light: #f5f7fa;
            --gray-medium: #e1e5eb;
            --gray-dark: #6c757d;
            --text-dark: #333;
            --text-light: #666;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            --radius: 8px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif;
        }

        body {
            background-color: #f8f9fa;
            color: var(--text-dark);
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: linear-gradient(135deg, var(--primary-color), #1e6b48);
            color: white;
            padding: 25px 30px;
            border-radius: var(--radius);
            margin-bottom: 30px;
            box-shadow: var(--shadow);
            position: relative;
            overflow: hidden;
        }

        header::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 200px;
            height: 200px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 50%;
            transform: translate(30%, -30%);
        }

        header h1 {
            font-size: 2.2rem;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        header h1 i {
            font-size: 2.5rem;
        }

        header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .tabs {
            display: flex;
            background-color: white;
            border-radius: var(--radius);
            overflow: hidden;
            box-shadow: var(--shadow);
            margin-bottom: 30px;
        }

        .tab {
            flex: 1;
            padding: 18px 20px;
            text-align: center;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
            color: var(--text-light);
        }

        .tab:hover {
            background-color: var(--gray-light);
            color: var(--primary-color);
        }

        .tab.active {
            color: var(--primary-color);
            border-bottom: 3px solid var(--primary-color);
            background-color: var(--primary-light);
        }

        .tab-content {
            display: none;
            background-color: white;
            border-radius: var(--radius);
            padding: 30px;
            box-shadow: var(--shadow);
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .filters {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 25px;
            padding-bottom: 25px;
            border-bottom: 1px solid var(--gray-medium);
        }

        .filter-group {
            flex: 1;
            min-width: 250px;
        }

        .filter-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-dark);
        }

        .filter-input {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid var(--gray-medium);
            border-radius: var(--radius);
            font-size: 1rem;
            transition: border 0.3s;
        }

        .filter-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(44, 140, 90, 0.1);
        }

        .year-month-filter {
            display: flex;
            gap: 15px;
            align-items: flex-end;
            margin-bottom: 20px;
            padding: 15px;
            background-color: var(--primary-light);
            border-radius: var(--radius);
        }

        .year-month-filter .filter-group {
            min-width: 150px;
        }

        .year-month-filter .filter-group:last-child {
            min-width: auto;
        }

        .assign-actions {
            display: flex;
            gap: 10px;
            margin-left: 15px;
        }

        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background-color: white;
            border-radius: var(--radius);
            padding: 25px;
            box-shadow: var(--shadow);
            border-left: 5px solid var(--primary-color);
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-card h3 {
            font-size: 1.1rem;
            color: var(--text-light);
            margin-bottom: 10px;
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--primary-color);
        }

        .stat-sub {
            font-size: 1rem;
            color: var(--gray-dark);
            margin-top: 5px;
        }

        .actions {
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            margin-bottom: 25px;
        }

        .btn {
            padding: 12px 24px;
            border-radius: var(--radius);
            border: none;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: #237048;
            box-shadow: 0 4px 12px rgba(44, 140, 90, 0.3);
        }

        .btn-secondary {
            background-color: var(--secondary-color);
            color: white;
        }

        .btn-secondary:hover {
            background-color: #1e5a8a;
            box-shadow: 0 4px 12px rgba(42, 111, 165, 0.3);
        }

        .btn-outline {
            background-color: transparent;
            color: var(--primary-color);
            border: 2px solid var(--primary-color);
        }

        .btn-outline:hover {
            background-color: var(--primary-light);
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 0.9rem;
            border-radius: 4px;
        }

        .btn-tiny {
            padding: 5px 10px;
            font-size: 0.8rem;
            border-radius: 3px;
        }

        .table-container {
            overflow-x: auto;
            border-radius: var(--radius);
            box-shadow: 0 0 0 1px var(--gray-medium);
            margin-bottom: 30px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1200px;
        }

        thead {
            background-color: var(--primary-color);
            color: white;
        }

        th {
            padding: 18px 15px;
            text-align: left;
            font-weight: 600;
            font-size: 1.05rem;
        }

        tbody tr {
            border-bottom: 1px solid var(--gray-medium);
            transition: background-color 0.2s;
        }

        tbody tr:hover {
            background-color: var(--gray-light);
        }

        tbody tr.requires-maintenance {
            background-color: #fff9e6;
        }

        tbody tr.requires-maintenance:hover {
            background-color: #fff4d4;
        }

        td {
            padding: 16px 15px;
            color: var(--text-dark);
        }

        .checkbox-cell {
            width: 50px;
            text-align: center;
        }

        .checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .status-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 30px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .status-pending {
            background-color: #fff3cd;
            color: #856404;
        }

        .status-completed {
            background-color: #d4edda;
            color: #155724;
        }

        .status-improving {
            background-color: #f8d7da;
            color: #721c24;
        }

        .status-not-due {
            background-color: #e8f4fd;
            color: #0c5460;
        }

        .upload-form-group {
            background-color: var(--gray-light);
            padding: 20px;
            border-radius: var(--radius);
            margin-bottom: 20px;
        }

        .upload-history {
            margin-top: 20px;
            border-top: 1px solid var(--gray-medium);
            padding-top: 20px;
        }

        .upload-history h4 {
            margin-bottom: 15px;
            color: var(--text-dark);
            font-size: 1.1rem;
        }

        .history-years {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .year-tab {
            padding: 8px 16px;
            background-color: var(--gray-light);
            border-radius: var(--radius);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .year-tab:hover {
            background-color: var(--gray-medium);
        }

        .year-tab.active {
            background-color: var(--primary-color);
            color: white;
        }

        .history-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
        }

        .month-card {
            background-color: var(--gray-light);
            border-radius: var(--radius);
            padding: 15px;
            transition: all 0.3s ease;
        }

        .month-card:hover {
            background-color: var(--gray-medium);
        }

        .month-card.uploaded {
            background-color: var(--primary-light);
            border-left: 4px solid var(--primary-color);
        }

        .month-card.not-required {
            background-color: #e8f4fd;
            border-left: 4px solid var(--secondary-color);
        }

        .month-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .month-name {
            font-weight: 600;
            color: var(--text-dark);
        }

        .month-status {
            font-size: 0.8rem;
            padding: 3px 8px;
            border-radius: 30px;
            background-color: var(--success-color);
            color: white;
        }

        .month-status.overdue {
            background-color: var(--danger-color);
        }

        .month-status.pending {
            background-color: var(--warning-color);
        }

        .month-status.not-required {
            background-color: var(--secondary-color);
        }

        .file-list {
            margin-top: 10px;
        }

        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 10px;
            background-color: white;
            border-radius: 4px;
            margin-bottom: 5px;
            font-size: 0.9rem;
        }

        .file-name {
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .file-action {
            color: var(--primary-color);
            cursor: pointer;
            margin-left: 10px;
        }

        .record-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .alert-icon {
            color: var(--danger-color);
            font-size: 1.3rem;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: white;
            border-radius: var(--radius);
            width: 90%;
            max-width: 900px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            animation: modalAppear 0.3s ease;
        }

        @keyframes modalAppear {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }

        .modal-header {
            padding: 25px 30px;
            background-color: var(--primary-color);
            color: white;
            border-radius: var(--radius) var(--radius) 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            font-size: 1.6rem;
        }

        .close-modal {
            background: none;
            border: none;
            color: white;
            font-size: 1.8rem;
            cursor: pointer;
            line-height: 1;
        }

        .modal-body {
            padding: 30px;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid var(--gray-medium);
            border-radius: var(--radius);
            font-size: 1rem;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(44, 140, 90, 0.1);
        }

        .modal-footer {
            padding: 20px 30px;
            background-color: var(--gray-light);
            border-radius: 0 0 var(--radius) var(--radius);
            display: flex;
            justify-content: flex-end;
            gap: 15px;
        }

        .file-upload-section {
            background-color: var(--gray-light);
            padding: 20px;
            border-radius: var(--radius);
            margin-top: 20px;
        }

        .file-upload-group {
            margin-bottom: 15px;
        }

        .file-upload-label {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }

        .file-upload-label i {
            color: var(--primary-color);
        }

        .file-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background-color: white;
            border-radius: 4px;
            margin-bottom: 8px;
            border-left: 4px solid var(--primary-color);
        }

        .file-list-item .file-info {
            flex: 1;
        }

        .file-list-item .file-actions {
            display: flex;
            gap: 10px;
        }

        footer {
            text-align: center;
            margin-top: 50px;
            padding: 20px;
            color: var(--gray-dark);
            font-size: 0.9rem;
            border-top: 1px solid var(--gray-medium);
        }

        .selection-filter {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-bottom: 15px;
            padding: 10px 15px;
            background-color: var(--primary-light);
            border-radius: var(--radius);
        }

        .selection-filter label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            font-weight: 600;
            color: var(--text-dark);
        }

        .month-checkbox-option {
            display: flex;
            align-items: center;
            gap: 5px;
            margin-top: 10px;
        }

        .month-checkbox-option input[type="checkbox"] {
            width: 16px;
            height: 16px;
        }

        .month-checkbox-option label {
            font-size: 0.85rem;
            font-weight: normal;
            cursor: pointer;
        }

        .check-status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 5px;
        }

        .check-status-checked {
            background-color: var(--primary-color);
        }

        .check-status-unchecked {
            background-color: var(--gray-medium);
        }

        /* 紅黃綠燈樣式 */
        .status-light {
            display: inline-flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        .light-container {
            display: flex;
            gap: 5px;
            align-items: center;
            justify-content: center;
        }

        .light {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            border: 1px solid rgba(0, 0, 0, 0.1);
        }

        .light.red {
            background-color: #e74c3c;
            box-shadow: 0 0 8px rgba(231, 76, 60, 0.6);
        }

        .light.yellow {
            background-color: #f39c12;
            box-shadow: 0 0 8px rgba(243, 156, 18, 0.6);
        }

        .light.green {
            background-color: #27ae60;
            box-shadow: 0 0 8px rgba(39, 174, 96, 0.6);
        }

        .light-label {
            font-size: 0.75rem;
            color: var(--gray-dark);
            text-align: center;
        }

        /* 燈號篩選器 */
        .light-filter {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 15px;
            padding: 10px 15px;
            background-color: #f8f9fa;
            border-radius: var(--radius);
            border: 1px solid var(--gray-medium);
        }

        .light-filter label {
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
            font-weight: 500;
        }

        .light-filter-option {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            background-color: white;
            border-radius: 4px;
            border: 1px solid var(--gray-medium);
        }

        .light-filter-option:hover {
            background-color: var(--gray-light);
        }

        .light-filter-option.selected {
            background-color: var(--primary-light);
            border-color: var(--primary-color);
        }

        .light-filter-option .light {
            width: 14px;
            height: 14px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            header {
                padding: 20px;
            }
            
            header h1 {
                font-size: 1.8rem;
            }
            
            .tabs {
                flex-direction: column;
            }
            
            .tab-content {
                padding: 20px;
            }
            
            .stats-container {
                grid-template-columns: 1fr;
            }
            
            .actions {
                flex-direction: column;
            }
            
            .btn {
                justify-content: center;
            }
            
            .year-month-filter {
                flex-direction: column;
                align-items: stretch;
            }
            
            .assign-actions {
                margin-left: 0;
                margin-top: 10px;
            }
            
            .history-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            }
            
            .selection-filter {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .record-buttons {
                flex-direction: column;
            }
            
            .light-filter {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .light-filter-option {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-tree"></i> 台中市公園稽查管理系統</h1>
            <p>公園稽查計畫與自主檢查表管理平台</p>
        </header>

        <div class="tabs">
            <div class="tab active" data-tab="inspection">稽查計畫管理</div>
            <div class="tab" data-tab="self-check">自主檢查表管理</div>
        </div>

        <!-- 稽查計畫管理頁籤 -->
        <div id="inspection" class="tab-content active">
            <!-- 年度月份篩選區塊 -->
            <div class="year-month-filter">
                <div class="filter-group">
                    <label for="year-filter">年度篩選</label>
                    <select id="year-filter" class="filter-input">
                        <option value="">全部年度</option>
                        <option value="112">112年(2023)</option>
                        <option value="113">113年(2024)</option>
                        <option value="114">114年(2025)</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="month-filter">月份篩選</label>
                    <select id="month-filter" class="filter-input">
                        <option value="">全部月份</option>
                        <option value="1">1月</option>
                        <option value="2">2月</option>
                        <option value="3">3月</option>
                        <option value="4">4月</option>
                        <option value="5">5月</option>
                        <option value="6">6月</option>
                        <option value="7">7月</option>
                        <option value="8">8月</option>
                        <option value="9">9月</option>
                        <option value="10">10月</option>
                        <option value="11">11月</option>
                        <option value="12">12月</option>
                    </select>
                </div>
                <div class="assign-actions">
                    <button class="btn btn-tiny btn-outline" id="query-assignments">
                        <i class="fas fa-search"></i> 查詢
                    </button>
                    <button class="btn btn-tiny btn-primary" id="save-assignments">
                        <i class="fas fa-save"></i> 儲存設定
                    </button>
                </div>
            </div>

            <!-- 統計卡片區塊 -->
            <div class="stats-container">
                <div class="stat-card">
                    <h3>本月稽查比例</h3>
                    <div class="stat-value" id="monthly-percentage">15.4%</div>
                    <div class="stat-sub">已選 <span id="monthly-count">20</span> / 總數 130 個公園</div>
                </div>
                <div class="stat-card">
                    <h3>累計稽查比例</h3>
                    <div class="stat-value" id="total-percentage">45.4%</div>
                    <div class="stat-sub">已稽查 <span id="total-count">59</span> / 年度目標 65% (85個)</div>
                </div>
                <div class="stat-card">
                    <h3>本月預定稽查</h3>
                    <div class="stat-value" id="scheduled-count">12</div>
                    <div class="stat-sub">已排定稽查日期</div>
                </div>
                <div class="stat-card">
                    <h3>待改善公園</h3>
                    <div class="stat-value" id="improving-count">8</div>
                    <div class="stat-sub">稽查結果為改善中</div>
                </div>
            </div>

            <!-- 操作按鈕區塊 -->
            <div class="actions">
                <button class="btn btn-outline" id="random-select">
                    <i class="fas fa-random"></i> 隨機選擇本月公園
                </button>
                <button class="btn btn-primary" id="export-inspection">
                    <i class="fas fa-file-excel"></i> 匯出 Excel
                </button>
            </div>

            <!-- 勾選篩選區塊 -->
            <div class="selection-filter">
                <label>
                    <input type="radio" name="checkbox-filter" value="all" checked> 顯示全部公園
                </label>
                <label>
                    <input type="radio" name="checkbox-filter" value="checked"> 僅顯示已勾選的公園
                </label>
                <label>
                    <input type="radio" name="checkbox-filter" value="unchecked"> 僅顯示尚未勾選的公園
                </label>
            </div>

            <!-- 紅黃綠燈篩選區塊 -->
            <div class="light-filter">
                <div>燈號篩選:</div>
                <div class="light-filter-option" data-light="all">
                    <input type="checkbox" id="light-all" checked>
                    <label for="light-all">全部燈號</label>
                </div>
                <div class="light-filter-option" data-light="red">
                    <div class="light red"></div>
                    <input type="checkbox" id="light-red">
                    <label for="light-red">紅燈（逾期/改善中）</label>
                </div>
                <div class="light-filter-option" data-light="yellow">
                    <div class="light yellow"></div>
                    <input type="checkbox" id="light-yellow">
                    <label for="light-yellow">黃燈（6個月內需辦理）</label>
                </div>
                <div class="light-filter-option" data-light="green">
                    <div class="light green"></div>
                    <input type="checkbox" id="light-green">
                    <label for="light-green">綠燈（6個月後辦理）</label>
                </div>
            </div>

            <!-- 篩選條件區塊 -->
            <div class="filters">
                <div class="filter-group">
                    <label for="park-name">公園名稱關鍵字</label>
                    <input type="text" id="park-name" class="filter-input" placeholder="輸入公園名稱關鍵字">
                </div>
                <div class="filter-group">
                    <label for="district">行政區</label>
                    <select id="district" class="filter-input">
                        <option value="">全部行政區</option>
                        <!-- 台中市22個轄區 -->
                        <option value="中區">中區</option>
                        <option value="東區">東區</option>
                        <option value="西區">西區</option>
                        <option value="南區">南區</option>
                        <option value="北區">北區</option>
                        <option value="西屯區">西屯區</option>
                        <option value="南屯區">南屯區</option>
                        <option value="北屯區">北屯區</option>
                        <option value="豐原區">豐原區</option>
                        <option value="大里區">大里區</option>
                        <option value="太平區">太平區</option>
                        <option value="清水區">清水區</option>
                        <option value="沙鹿區">沙鹿區</option>
                        <option value="大甲區">大甲區</option>
                        <option value="東勢區">東勢區</option>
                        <option value="梧棲區">梧棲區</option>
                        <option value="烏日區">烏日區</option>
                        <option value="神岡區">神岡區</option>
                        <option value="大肚區">大肚區</option>
                        <option value="大雅區">大雅區</option>
                        <option value="后里區">後里區</option>
                        <option value="霧峰區">霧峰區</option>
                        <option value="潭子區">潭子區</option>
                        <option value="龍井區">龍井區</option>
                        <option value="外埔區">外埔區</option>
                        <option value="和平區">和平區</option>
                        <option value="石岡區">石岡區</option>
                        <option value="大安區">大安區</option>
                        <option value="新社區">新社區</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="inspection-status">稽查情形</label>
                    <select id="inspection-status" class="filter-input">
                        <option value="">全部</option>
                        <option value="pending">尚未稽查</option>
                        <option value="completed">已稽查合格</option>
                        <option value="improving">改善中</option>
                        <option value="not-due">時間未屆</option>
                    </select>
                </div>
            </div>

            <!-- 表格區塊 -->
            <div class="table-container">
                <table id="inspection-table">
                    <thead>
                        <tr>
                            <th class="checkbox-cell">勾選</th>
                            <th>序號</th>
                            <th>行政區</th>
                            <th>公園名稱</th>
                            <th>檢驗報告狀態</th>
                            <th>預定稽查日期</th>
                            <th>稽查情形</th>
                            <th>登錄</th>
                        </tr>
                    </thead>
                    <tbody id="inspection-tbody">
                        <!-- 表格內容由JavaScript動態生成 -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- 自主檢查表管理頁籤 -->
        <div id="self-check" class="tab-content">
            <!-- 篩選條件區塊 -->
            <div class="filters">
                <div class="filter-group">
                    <label for="selfcheck-park-name">公園名稱關鍵字</label>
                    <input type="text" id="selfcheck-park-name" class="filter-input" placeholder="輸入公園名稱關鍵字">
                </div>
                <div class="filter-group">
                    <label for="selfcheck-district">行政區</label>
                    <select id="selfcheck-district" class="filter-input">
                        <option value="">全部行政區</option>
                        <option value="中區">中區</option>
                        <option value="東區">東區</option>
                        <option value="西區">西區</option>
                        <option value="南區">南區</option>
                        <option value="北區">北區</option>
                        <option value="西屯區">西屯區</option>
                        <option value="南屯區">南屯區</option>
                        <option value="北屯區">北屯區</option>
                        <option value="豐原區">豐原區</option>
                        <!-- 其他行政區選項... -->
                    </select>
                </div>
                <div class="filter-group">
                    <label style="display: flex; align-items: center;">
                        <input type="checkbox" id="selfcheck-show-overdue"> 
                        <span style="margin-left: 8px;">僅顯示逾期未上傳(包含各月份)</span>
                    </label>
                </div>
                <div class="filter-group" style="min-width: 120px;">
                    <button class="btn btn-primary" id="selfcheck-search-btn" style="width: 100%; padding: 12px;">
                        <i class="fas fa-search"></i> 查詢
                    </button>
                </div>
            </div>

            <!-- 操作按鈕區塊 -->
            <div class="actions">
                <button class="btn btn-primary" id="export-selfcheck">
                    <i class="fas fa-file-excel"></i> 匯出 Excel
                </button>
            </div>

            <!-- 表格區塊 -->
            <div class="table-container">
                <table id="selfcheck-table">
                    <thead>
                        <tr>
                            <th>序號</th>
                            <th>行政區</th>
                            <th>公園名稱</th>
                            <th>兒童遊戲場數</th>
                            <th>上個月狀態</th>
                            <th>上傳每月自主檢查表</th>
                        </tr>
                    </thead>
                    <tbody id="selfcheck-tbody">
                        <!-- 表格內容由JavaScript動態生成 -->
                    </tbody>
                </table>
            </div>
        </div>

        <footer>
            <p>台中市政府建設局 公園管理處 &copy; 112年(2023) | 系統版本 1.5.0</p>
        </footer>
    </div>

    <!-- 稽查登錄模態框 -->
    <div id="inspection-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>公園稽查登錄</h2>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="modal-park-name">公園名稱</label>
                    <input type="text" id="modal-park-name" class="form-control" readonly>
                </div>
                <div class="form-group">
                    <label for="scheduled-date">預定稽查日期</label>
                    <input type="date" id="scheduled-date" class="form-control" readonly>
                </div>
                <div class="form-group">
                    <label for="actual-date">實際稽查日期</label>
                    <input type="date" id="actual-date" class="form-control">
                </div>
                <div class="form-group">
                    <label>稽查結果</label>
                    <div style="display: flex; gap: 20px; margin-top: 10px;">
                        <label>
                            <input type="radio" name="result" value="合格" checked> 合格
                        </label>
                        <label>
                            <input type="radio" name="result" value="改善中"> 改善中
                        </label>
                    </div>
                </div>
                
                <!-- 檔案上傳區塊 -->
                <div class="file-upload-section">
                    <h3 style="margin-bottom: 15px; color: var(--text-dark);">相關檔案上傳</h3>
                    
                    <div class="file-upload-group">
                        <div class="file-upload-label">
                            <i class="fas fa-file-alt"></i>
                            <span>兒童遊戲場基本資料</span>
                        </div>
                        <input type="file" id="playground-basic-file" class="form-control" accept=".pdf,.doc,.docx,.xls,.xlsx,.jpg,.png">
                    </div>
                    
                    <div class="file-upload-group">
                        <div class="file-upload-label">
                            <i class="fas fa-certificate"></i>
                            <span>廠商出具合格保證書</span>
                        </div>
                        <input type="file" id="certificate-file" class="form-control" accept=".pdf,.doc,.docx,.xls,.xlsx,.jpg,.png">
                    </div>
                    
                    <div class="file-upload-group">
                        <div class="file-upload-label">
                            <i class="fas fa-id-card"></i>
                            <span>兒童遊戲場管理人員證書</span>
                        </div>
                        <input type="file" id="manager-certificate-file" class="form-control" accept=".pdf,.doc,.docx,.xls,.xlsx,.jpg,.png">
                    </div>
                    
                    <!-- 已上傳檔案清單 -->
                    <div id="uploaded-files-list" style="margin-top: 20px; display: none;">
                        <h4 style="margin-bottom: 10px;">已上傳檔案</h4>
                        <div id="uploaded-files-container">
                            <!-- 檔案清單將動態生成 -->
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="notes">稽查備註</label>
                    <textarea id="notes" class="form-control" rows="4" placeholder="輸入稽查備註..."></textarea>
                </div>
                
                <div class="record-buttons">
                    <button class="btn btn-outline" id="view-inspection-history">
                        <i class="fas fa-history"></i> 查閱備查紀錄
                    </button>
                    <button class="btn btn-outline" id="view-maintenance-history">
                        <i class="fas fa-tools"></i> 查閱定期維護紀錄
                    </button>
                    <button class="btn btn-outline" id="view-selfcheck-history">
                        <i class="fas fa-clipboard-check"></i> 查閱每月自主檢查表紀錄
                    </button>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline close-modal">取消</button>
                <button class="btn btn-primary" id="save-inspection">儲存稽查資料</button>
            </div>
        </div>
    </div>

    <!-- 備查紀錄模態框 -->
    <div id="inspection-history-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>歷年備查紀錄</h2>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="history-park-name">公園名稱</label>
                    <input type="text" id="history-park-name" class="form-control" readonly>
                </div>
                <div class="form-group">
                    <label>備查紀錄</label>
                    <div style="margin-top: 10px; padding: 15px; background-color: #f8f9fa; border-radius: var(--radius);">
                        <p><strong>111年:</strong> 已稽查合格 (111/05/15)</p>
                        <p><strong>110年:</strong> 已稽查合格 (110/06/22)</p>
                        <p><strong>109年:</strong> 已稽查合格 (109/07/10)</p>
                        <p><strong>108年:</strong> 已稽查合格 (108/08/05)</p>
                        <p><strong>107年:</strong> 已稽查合格 (107/09/12)</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline close-modal">關閉</button>
            </div>
        </div>
    </div>

    <!-- 定期維護紀錄模態框 -->
    <div id="maintenance-history-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>定期維護紀錄</h2>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="maintenance-park-name">公園名稱</label>
                    <input type="text" id="maintenance-park-name" class="form-control" readonly>
                </div>
                <div class="form-group">
                    <label>維護紀錄</label>
                    <div style="margin-top: 10px; padding: 15px; background-color: #f8f9fa; border-radius: var(--radius);">
                        <p><strong>112年:</strong> 遊戲場設備更新 (112/03/20)</p>
                        <p><strong>111年:</strong> 例行維護完成 (111/11/05)</p>
                        <p><strong>110年:</strong> 照明設備改善 (110/09/15)</p>
                        <p><strong>109年:</strong> 座椅更換 (109/05/10)</p>
                        <p><strong>108年:</strong> 步道整修 (108/07/22)</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline close-modal">關閉</button>
            </div>
        </div>
    </div>

    <!-- 每月自主檢查表紀錄模態框 -->
    <div id="selfcheck-history-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>每月自主檢查表紀錄</h2>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="selfcheck-history-park-name">公園名稱</label>
                    <input type="text" id="selfcheck-history-park-name" class="form-control" readonly>
                </div>
                
                <!-- 上傳歷史紀錄 -->
                <div class="upload-history">
                    <h4>已上傳檔案紀錄</h4>
                    <div class="history-years">
                        <div class="year-tab active" data-year="112">112年</div>
                        <div class="year-tab" data-year="111">111年</div>
                        <div class="year-tab" data-year="110">110年</div>
                    </div>
                    <div class="history-grid" id="selfcheck-history-grid">
                        <!-- 各月份上傳紀錄由JavaScript動態生成 -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline close-modal">關閉</button>
            </div>
        </div>
    </div>

    <!-- 自主檢查表上傳模態框 -->
    <div id="selfcheck-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>上傳自主檢查表</h2>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="upload-form-group">
                    <div class="form-group">
                        <label for="selfcheck-park">公園名稱</label>
                    <input type="text" id="selfcheck-park" class="form-control" readonly>
                </div>
                <div class="form-group">
                    <label for="check-month">檢查月份</label>
                    <select id="check-month" class="form-control">
                        <option value="112-01">112年1月</option>
                        <option value="112-02">112年2月</option>
                        <option value="112-03">112年3月</option>
                        <option value="112-04">112年4月</option>
                        <option value="112-05">112年5月</option>
                        <option value="112-06" selected>112年6月</option>
                        <option value="112-07">112年7月</option>
                        <option value="112-08">112年8月</option>
                        <option value="112-09">112年9月</option>
                        <option value="112-10">112年10月</option>
                        <option value="112-11">112年11月</option>
                        <option value="112-12">112年12月</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="check-file">選擇檔案</label>
                    <input type="file" id="check-file" class="form-control" accept=".pdf,.doc,.docx,.xls,.xlsx">
                </div>
                <div class="form-group">
                    <label for="check-notes">備註</label>
                    <textarea id="check-notes" class="form-control" rows="3" placeholder="輸入檔案備註..."></textarea>
                </div>
                
                <!-- 儲存資料按鈕（移動到備註下方） -->
                <div class="form-group" style="margin-top: 25px;">
                    <button class="btn btn-primary" id="save-selfcheck-data" style="width: 100%;">
                        <i class="fas fa-save"></i> 儲存資料
                    </button>
                </div>
            </div>
            
            <!-- 已上傳檔案紀錄 -->
            <div class="upload-history">
                <h4>已上傳檔案紀錄 <small style="font-weight: normal; color: var(--gray-dark);">(可設定各月份為無須上傳)</small></h4>
                <div class="history-years">
                    <div class="year-tab active" data-year="112">112年</div>
                    <div class="year-tab" data-year="111">111年</div>
                    <div class="year-tab" data-year="110">110年</div>
                </div>
                <div class="history-grid" id="upload-history-grid">
                    <!-- 各月份上傳紀錄由JavaScript動態生成 -->
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-outline close-modal">取消</button>
        </div>
    </div>
</div>

<script>
    // 民國年轉換函數
    function toRepublicYear(year) {
        return year - 1911;
    }
    
    function fromRepublicYear(republicYear) {
        return republicYear + 1911;
    }
    
    // 格式化日期為民國年格式
    function formatRepublicDate(dateStr) {
        if (!dateStr) return '';
        const date = new Date(dateStr);
        const year = toRepublicYear(date.getFullYear());
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}/${month}/${day}`;
    }

    // 計算日期差距（天數）
    function getDaysDifference(dateStr) {
        if (!dateStr) return Infinity;
        const targetDate = new Date(dateStr);
        const today = new Date();
        const diffTime = targetDate.getTime() - today.getTime();
        return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    }

    // 台中市公園資料（增加紅黃綠燈狀態屬性）
    const parks = [
        { id: 1, district: "西屯區", name: "秋紅谷景觀生態公園", playgrounds: 3, requiresMaintenance: true, scheduledDate: "2023-06-15", inspectionStatus: "pending", assignedYear: "112", assignedMonth: "6", lightStatus: "red", reportDueDate: "2023-05-20", maintenanceDueDate: "2023-04-15" },
        { id: 2, district: "南屯區", name: "豐樂雕塑公園", playgrounds: 2, requiresMaintenance: false, scheduledDate: "", inspectionStatus: "pending", assignedYear: "", assignedMonth: "", lightStatus: "green", reportDueDate: "2023-12-10", maintenanceDueDate: "2024-01-20" },
        { id: 3, district: "北屯區", name: "廍子公園", playgrounds: 4, requiresMaintenance: false, scheduledDate: "2023-06-20", inspectionStatus: "pending", assignedYear: "112", assignedMonth: "6", lightStatus: "yellow", reportDueDate: "2023-08-15", maintenanceDueDate: "2023-09-10" },
        { id: 4, district: "西區", name: "美術園道公園", playgrounds: 1, requiresMaintenance: false, scheduledDate: "", inspectionStatus: "completed", assignedYear: "112", assignedMonth: "5", lightStatus: "green", reportDueDate: "2023-11-30", maintenanceDueDate: "2024-02-15" },
        { id: 5, district: "北區", name: "台中公園", playgrounds: 3, requiresMaintenance: true, scheduledDate: "2023-06-10", inspectionStatus: "improving", assignedYear: "112", assignedMonth: "6", lightStatus: "red", reportDueDate: "2023-04-30", maintenanceDueDate: "2023-03-22" },
        { id: 6, district: "南區", name: "健康公園", playgrounds: 2, requiresMaintenance: false, scheduledDate: "", inspectionStatus: "completed", assignedYear: "112", assignedMonth: "4", lightStatus: "green", reportDueDate: "2023-10-25", maintenanceDueDate: "2024-03-05" },
        { id: 7, district: "豐原區", name: "葫蘆墩公園", playgrounds: 5, requiresMaintenance: false, scheduledDate: "2023-07-05", inspectionStatus: "pending", assignedYear: "112", assignedMonth: "7", lightStatus: "yellow", reportDueDate: "2023-09-10", maintenanceDueDate: "2023-08-15" },
        { id: 8, district: "大里區", name: "運動公園", playgrounds: 3, requiresMaintenance: false, scheduledDate: "", inspectionStatus: "pending", assignedYear: "", assignedMonth: "", lightStatus: "green", reportDueDate: "2024-01-15", maintenanceDueDate: "2024-02-28" },
        { id: 9, district: "太平區", name: "坪林森林公園", playgrounds: 2, requiresMaintenance: false, scheduledDate: "2023-06-25", inspectionStatus: "pending", assignedYear: "112", assignedMonth: "6", lightStatus: "red", reportDueDate: "2023-05-30", maintenanceDueDate: "2023-03-18" },
        { id: 10, district: "清水區", name: "鰲峰山公園", playgrounds: 4, requiresMaintenance: true, scheduledDate: "", inspectionStatus: "completed", assignedYear: "112", assignedMonth: "3", lightStatus: "yellow", reportDueDate: "2023-08-05", maintenanceDueDate: "2023-07-20" },
        { id: 11, district: "沙鹿區", name: "沙鹿公園", playgrounds: 1, requiresMaintenance: false, scheduledDate: "", inspectionStatus: "pending", assignedYear: "", assignedMonth: "", lightStatus: "green", reportDueDate: "2023-12-28", maintenanceDueDate: "2024-04-10" },
        { id: 12, district: "大甲區", name: "鐵砧山雕塑公園", playgrounds: 3, requiresMaintenance: false, scheduledDate: "2023-07-10", inspectionStatus: "pending", assignedYear: "112", assignedMonth: "7", lightStatus: "yellow", reportDueDate: "2023-09-22", maintenanceDueDate: "2023-08-30" },
        { id: 13, district: "東勢區", name: "河濱公園", playgrounds: 2, requiresMaintenance: false, scheduledDate: "", inspectionStatus: "improving", assignedYear: "112", assignedMonth: "5", lightStatus: "red", reportDueDate: "2023-04-10", maintenanceDueDate: "2023-02-15" },
        { id: 14, district: "梧棲區", name: "頂魚寮公園", playgrounds: 2, requiresMaintenance: false, scheduledDate: "", inspectionStatus: "completed", assignedYear: "112", assignedMonth: "4", lightStatus: "green", reportDueDate: "2023-11-05", maintenanceDueDate: "2024-01-30" },
        { id: 15, district: "烏日區", name: "烏日公園", playgrounds: 1, requiresMaintenance: false, scheduledDate: "2023-06-30", inspectionStatus: "pending", assignedYear: "112", assignedMonth: "6", lightStatus: "red", reportDueDate: "2023-05-25", maintenanceDueDate: "2023-04-18" },
        { id: 16, district: "神岡區", name: "神岡公園", playgrounds: 2, requiresMaintenance: true, scheduledDate: "", inspectionStatus: "pending", assignedYear: "", assignedMonth: "", lightStatus: "green", reportDueDate: "2023-10-10", maintenanceDueDate: "2024-02-05" },
        { id: 17, district: "大肚區", name: "環保公園", playgrounds: 1, requiresMaintenance: false, scheduledDate: "", inspectionStatus: "completed", assignedYear: "112", assignedMonth: "2", lightStatus: "green", reportDueDate: "2023-12-15", maintenanceDueDate: "2024-03-20" },
        { id: 18, district: "大雅區", name: "大雅公園", playgrounds: 3, requiresMaintenance: false, scheduledDate: "2023-07-15", inspectionStatus: "pending", assignedYear: "112", assignedMonth: "7", lightStatus: "yellow", reportDueDate: "2023-09-05", maintenanceDueDate: "2023-08-10" },
        { id: 19, district: "后里區", name: "后里運動公園", playgrounds: 4, requiresMaintenance: false, scheduledDate: "", inspectionStatus: "pending", assignedYear: "", assignedMonth: "", lightStatus: "green", reportDueDate: "2024-02-28", maintenanceDueDate: "2024-05-15" },
        { id: 20, district: "霧峰區", name: "亞洲大學現代美術館公園", playgrounds: 2, requiresMaintenance: false, scheduledDate: "", inspectionStatus: "completed", assignedYear: "112", assignedMonth: "1", lightStatus: "green", reportDueDate: "2023-11-20", maintenanceDueDate: "2024-02-10" },
    ];

    // 自主檢查表資料（簡化狀態）
    const selfCheckParks = [
        { id: 1, district: "西屯區", name: "秋紅谷景觀生態公園", playgrounds: 3, lastMonthStatus: "overdue" },
        { id: 2, district: "南屯區", name: "豐樂雕塑公園", playgrounds: 2, lastMonthStatus: "uploaded" },
        { id: 3, district: "北屯區", name: "廍子公園", playgrounds: 4, lastMonthStatus: "uploaded" },
        { id: 4, district: "西區", name: "美術園道公園", playgrounds: 1, lastMonthStatus: "uploaded" },
        { id: 5, district: "北區", name: "台中公園", playgrounds: 3, lastMonthStatus: "overdue" },
        { id: 6, district: "南區", name: "健康公園", playgrounds: 2, lastMonthStatus: "uploaded" },
        { id: 7, district: "豐原區", name: "葫蘆墩公園", playgrounds: 5, lastMonthStatus: "uploaded" },
        { id: 8, district: "大里區", name: "運動公園", playgrounds: 3, lastMonthStatus: "uploaded" },
        { id: 9, district: "太平區", name: "坪林森林公園", playgrounds: 2, lastMonthStatus: "uploaded" },
        { id: 10, district: "清水區", name: "鰲峰山公園", playgrounds: 4, lastMonthStatus: "uploaded" },
    ];

    // 稽查檔案上傳資料
    const inspectionFilesData = {
        "秋紅谷景觀生態公園": [
            { name: "兒童遊戲場基本資料.pdf", type: "basic", date: "112/06/10" },
            { name: "廠商出具合格保證書.pdf", type: "certificate", date: "112/06/10" },
            { name: "管理人員證書.jpg", type: "manager", date: "112/06/10" }
        ],
        "台中公園": [
            { name: "兒童遊戲場基本資料.docx", type: "basic", date: "112/06/05" },
            { name: "廠商出具合格保證書.pdf", type: "certificate", date: "112/06/05" }
        ]
    };

    // 自主檢查表上傳紀錄資料（各年度各月份）
    const uploadHistoryData = {
        "秋紅谷景觀生態公園": {
            112: {
                1: { status: "uploaded", files: ["112-01-自主檢查表.pdf", "112-01-設備檢查記錄.docx"], notRequired: false },
                2: { status: "uploaded", files: ["112-02-自主檢查表.pdf"], notRequired: false },
                3: { status: "uploaded", files: ["112-03-自主檢查表.pdf"], notRequired: false },
                4: { status: "uploaded", files: ["112-04-自主檢查表.pdf"], notRequired: false },
                5: { status: "uploaded", files: ["112-05-自主檢查表.pdf"], notRequired: false },
                6: { status: "overdue", files: [], notRequired: false },
                7: { status: "pending", files: [], notRequired: false },
                8: { status: "pending", files: [], notRequired: false },
                9: { status: "pending", files: [], notRequired: false },
                10: { status: "pending", files: [], notRequired: false },
                11: { status: "pending", files: [], notRequired: false },
                12: { status: "pending", files: [], notRequired: false }
            },
            111: {
                1: { status: "uploaded", files: ["111-01-自主檢查表.pdf"], notRequired: false },
                2: { status: "uploaded", files: ["111-02-自主檢查表.pdf"], notRequired: false },
                3: { status: "uploaded", files: ["111-03-自主檢查表.pdf"], notRequired: false },
                4: { status: "uploaded", files: ["111-04-自主檢查表.pdf"], notRequired: false },
                5: { status: "uploaded", files: ["111-05-自主檢查表.pdf"], notRequired: false },
                6: { status: "uploaded", files: ["111-06-自主檢查表.pdf"], notRequired: false },
                7: { status: "uploaded", files: ["111-07-自主檢查表.pdf"], notRequired: false },
                8: { status: "uploaded", files: ["111-08-自主檢查表.pdf"], notRequired: false },
                9: { status: "uploaded", files: ["111-09-自主檢查表.pdf"], notRequired: false },
                10: { status: "uploaded", files: ["111-10-自主檢查表.pdf"], notRequired: false },
                11: { status: "uploaded", files: ["111-11-自主檢查表.pdf"], notRequired: false },
                12: { status: "uploaded", files: ["111-12-自主檢查表.pdf"], notRequired: false }
            },
            110: {
                1: { status: "uploaded", files: ["110-01-自主檢查表.pdf"], notRequired: false },
                2: { status: "uploaded", files: ["110-02-自主檢查表.pdf"], notRequired: false },
                3: { status: "uploaded", files: ["110-03-自主檢查表.pdf"], notRequired: false },
                4: { status: "uploaded", files: ["110-04-自主檢查表.pdf"], notRequired: false },
                5: { status: "uploaded", files: ["110-05-自主檢查表.pdf"], notRequired: false },
                6: { status: "uploaded", files: ["110-06-自主檢查表.pdf"], notRequired: false },
                7: { status: "uploaded", files: ["110-07-自主檢查表.pdf"], notRequired: false },
                8: { status: "uploaded", files: ["110-08-自主檢查表.pdf"], notRequired: false },
                9: { status: "uploaded", files: ["110-09-自主檢查表.pdf"], notRequired: false },
                10: { status: "uploaded", files: ["110-10-自主檢查表.pdf"], notRequired: false },
                11: { status: "uploaded", files: ["110-11-自主檢查表.pdf"], notRequired: false },
                12: { status: "uploaded", files: ["110-12-自主檢查表.pdf"], notRequired: false }
            }
        },
        "豐樂雕塑公園": {
            112: {
                1: { status: "uploaded", files: ["112-01-自主檢查表.pdf"], notRequired: false },
                2: { status: "uploaded", files: ["112-02-自主檢查表.pdf"], notRequired: false },
                3: { status: "uploaded", files: ["112-03-自主檢查表.pdf"], notRequired: false },
                4: { status: "uploaded", files: ["112-04-自主檢查表.pdf"], notRequired: false },
                5: { status: "uploaded", files: ["112-05-自主檢查表.pdf"], notRequired: false },
                6: { status: "uploaded", files: ["112-06-自主檢查表.pdf"], notRequired: false },
                7: { status: "pending", files: [], notRequired: true },
                8: { status: "pending", files: [], notRequired: false },
                9: { status: "pending", files: [], notRequired: false },
                10: { status: "pending", files: [], notRequired: false },
                11: { status: "pending", files: [], notRequired: false },
                12: { status: "pending", files: [], notRequired: false }
            }
        }
    };

    // 頁籤切換功能
    document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', () => {
            // 移除所有頁籤的active類別
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            // 為點擊的頁籤和對應內容添加active類別
            tab.classList.add('active');
            const tabId = tab.getAttribute('data-tab');
            document.getElementById(tabId).classList.add('active');
        });
    });

    // 根據紅黃綠燈狀態取得燈號說明
    function getLightStatusText(lightStatus) {
        switch(lightStatus) {
            case 'red':
                return '部分檢驗報告已逾期未填或改善中';
            case 'yellow':
                return '部分檢驗報告預定6個月內要辦理';
            case 'green':
                return '所有檢驗報告6個月後才需辦理';
            default:
                return '';
        }
    }

    // 獲取稽查情形顯示文字（根據燈號狀態）
    function getInspectionStatusText(lightStatus, originalStatus) {
        // 如果燈號是綠燈，一律顯示「時間未屆」
        if (lightStatus === 'green') {
            return 'not-due';
        }
        // 否則返回原始狀態
        return originalStatus;
    }

    // 獲取稽查情形顯示標籤
    function getInspectionStatusBadge(status) {
        switch(status) {
            case 'pending':
                return '<span class="status-badge status-pending">尚未稽查</span>';
            case 'completed':
                return '<span class="status-badge status-completed">已稽查合格</span>';
            case 'improving':
                return '<span class="status-badge status-improving">改善中</span>';
            case 'not-due':
                return '<span class="status-badge status-not-due">時間未屆</span>';
            default:
                return '';
        }
    }

    // 渲染稽查計畫表格
    function renderInspectionTable() {
        const tbody = document.getElementById('inspection-tbody');
        tbody.innerHTML = '';
        
        // 取得篩選條件
        const parkNameFilter = document.getElementById('park-name').value.toLowerCase();
        const districtFilter = document.getElementById('district').value;
        const statusFilter = document.getElementById('inspection-status').value;
        const yearFilter = document.getElementById('year-filter').value;
        const monthFilter = document.getElementById('month-filter').value;
        
        // 取得勾選篩選條件
        const checkboxFilter = document.querySelector('input[name="checkbox-filter"]:checked').value;
        
        // 取得紅黃綠燈篩選條件
        const lightFilterAll = document.getElementById('light-all').checked;
        const lightFilterRed = document.getElementById('light-red').checked;
        const lightFilterYellow = document.getElementById('light-yellow').checked;
        const lightFilterGreen = document.getElementById('light-green').checked;
        
        // 如果沒有選中任何燈號篩選，預設顯示全部
        const showAllLights = lightFilterAll || (!lightFilterRed && !lightFilterYellow && !lightFilterGreen);
        
        // 計算統計數據
        let selectedCount = 0;
        let scheduledCount = 0;
        let improvingCount = 0;
        let totalCount = 0;
        
        // 燈號統計
        let redCount = 0;
        let yellowCount = 0;
        let greenCount = 0;
        
        parks.forEach((park, index) => {
            // 篩選條件
            if (parkNameFilter && !park.name.toLowerCase().includes(parkNameFilter)) return;
            if (districtFilter && park.district !== districtFilter) return;
            
            // 根據燈號狀態獲取稽查情形
            const displayStatus = getInspectionStatusText(park.lightStatus, park.inspectionStatus);
            
            if (statusFilter && displayStatus !== statusFilter) return;
            if (yearFilter && park.assignedYear !== yearFilter) return;
            if (monthFilter && park.assignedMonth !== monthFilter) return;
            
            // 紅黃綠燈篩選
            if (!showAllLights) {
                if (park.lightStatus === 'red' && !lightFilterRed) return;
                if (park.lightStatus === 'yellow' && !lightFilterYellow) return;
                if (park.lightStatus === 'green' && !lightFilterGreen) return;
            }
            
            // 決定是否勾選（已排定稽查日期或改善中的公園預設勾選）
            const isChecked = park.scheduledDate || park.inspectionStatus === 'improving';
            
            // 根據勾選篩選條件篩選
            if (checkboxFilter === 'checked' && !isChecked) return;
            if (checkboxFilter === 'unchecked' && isChecked) return;
            
            totalCount++;
            
            // 統計
            if (park.scheduledDate) scheduledCount++;
            if (park.inspectionStatus === 'improving') improvingCount++;
            if (isChecked) selectedCount++;
            
            // 燈號統計
            if (park.lightStatus === 'red') redCount++;
            if (park.lightStatus === 'yellow') yellowCount++;
            if (park.lightStatus === 'green') greenCount++;
            
            // 建立表格列
            const row = document.createElement('tr');
            if (park.requiresMaintenance) {
                row.classList.add('requires-maintenance');
            }
            
            // 根據燈號狀態決定顯示的燈號
            let lightHTML = '';
            let lightText = getLightStatusText(park.lightStatus);
            
            if (park.lightStatus === 'red') {
                lightHTML = `
                    <div class="status-light">
                        <div class="light-container">
                            <div class="light red"></div>
                            <div class="light"></div>
                            <div class="light"></div>
                        </div>
                        <div class="light-label">${lightText}</div>
                    </div>
                `;
            } else if (park.lightStatus === 'yellow') {
                lightHTML = `
                    <div class="status-light">
                        <div class="light-container">
                            <div class="light"></div>
                            <div class="light yellow"></div>
                            <div class="light"></div>
                        </div>
                        <div class="light-label">${lightText}</div>
                    </div>
                `;
            } else if (park.lightStatus === 'green') {
                lightHTML = `
                    <div class="status-light">
                        <div class="light-container">
                            <div class="light"></div>
                            <div class="light"></div>
                            <div class="light green"></div>
                        </div>
                        <div class="light-label">${lightText}</div>
                    </div>
                `;
            }
            
            row.innerHTML = `
                <td class="checkbox-cell">
                    <input type="checkbox" class="checkbox park-checkbox" ${isChecked ? 'checked' : ''} data-id="${park.id}">
                </td>
                <td>${park.id}</td>
                <td>${park.district}</td>
                <td>${park.name}</td>
                <td>${lightHTML}</td>
                <td>${park.scheduledDate ? formatRepublicDate(park.scheduledDate) : '尚未設定'}</td>
                <td>
                    ${getInspectionStatusBadge(displayStatus)}
                </td>
                <td>
                    <button class="btn btn-small btn-outline log-btn" data-id="${park.id}">
                        <i class="fas fa-edit"></i> 登錄資料
                    </button>
                </td>
            `;
            
            tbody.appendChild(row);
        });
        
        // 更新統計數據
        const monthlyPercentage = ((selectedCount / parks.length) * 100).toFixed(1);
        const totalPercentage = ((scheduledCount + improvingCount) / parks.length * 100).toFixed(1);
        
        document.getElementById('monthly-percentage').textContent = `${monthlyPercentage}%`;
        document.getElementById('monthly-count').textContent = selectedCount;
        document.getElementById('total-percentage').textContent = `${totalPercentage}%`;
        document.getElementById('total-count').textContent = scheduledCount + improvingCount;
        document.getElementById('scheduled-count').textContent = scheduledCount;
        document.getElementById('improving-count').textContent = improvingCount;
        
        // 更新燈號篩選器標籤上的計數
        document.querySelector('#light-red + label').innerHTML = `紅燈（逾期/改善中） <small>(${redCount})</small>`;
        document.querySelector('#light-yellow + label').innerHTML = `黃燈（6個月內需辦理） <small>(${yellowCount})</small>`;
        document.querySelector('#light-green + label').innerHTML = `綠燈（6個月後辦理） <small>(${greenCount})</small>`;
    }

    // 渲染自主檢查表表格
    function renderSelfCheckTable() {
        const tbody = document.getElementById('selfcheck-tbody');
        tbody.innerHTML = '';
        
        // 取得篩選條件
        const parkNameFilter = document.getElementById('selfcheck-park-name').value.toLowerCase();
        const districtFilter = document.getElementById('selfcheck-district').value;
        const showOverdue = document.getElementById('selfcheck-show-overdue').checked;
        
        // 檢查是否有公園逾期未上傳（包含各月份）
        const checkParkOverdue = (parkName) => {
            const parkHistory = uploadHistoryData[parkName];
            if (!parkHistory) return false;
            
            // 檢查當前年份的逾期情況
            const currentYear = "112";
            const yearData = parkHistory[currentYear];
            if (!yearData) return false;
            
            // 檢查是否有任何月份逾期
            for (let month = 1; month <= 12; month++) {
                if (yearData[month] && yearData[month].status === "overdue" && !yearData[month].notRequired) {
                    return true;
                }
            }
            
            return false;
        };
        
        selfCheckParks.forEach((park, index) => {
            // 篩選條件
            if (parkNameFilter && !park.name.toLowerCase().includes(parkNameFilter)) return;
            if (districtFilter && park.district !== districtFilter) return;
            if (showOverdue && !checkParkOverdue(park.name)) return;
            
            // 建立表格列
            const row = document.createElement('tr');
            
            row.innerHTML = `
                <td>${park.id}</td>
                <td>${park.district}</td>
                <td>${park.name}</td>
                <td>${park.playgrounds}</td>
                <td>
                    ${park.lastMonthStatus === 'uploaded' ? 
                        '<span class="status-badge status-completed">已上傳</span>' : 
                        '<span class="status-badge status-improving"><i class="fas fa-exclamation-triangle"></i> 逾期未上傳</span>'}
                </td>
                <td>
                    <button class="btn btn-small btn-primary upload-btn" data-id="${park.id}">
                        <i class="fas fa-upload"></i> 上傳檔案
                    </button>
                </td>
            `;
            
            tbody.appendChild(row);
        });
    }

    // 渲染稽查檔案上傳清單
    function renderInspectionFiles(parkName) {
        const container = document.getElementById('uploaded-files-container');
        container.innerHTML = '';
        
        const files = inspectionFilesData[parkName] || [];
        
        if (files.length === 0) {
            document.getElementById('uploaded-files-list').style.display = 'none';
            return;
        }
        
        document.getElementById('uploaded-files-list').style.display = 'block';
        
        files.forEach(file => {
            const fileItem = document.createElement('div');
            fileItem.className = 'file-list-item';
            
            // 根據檔案類型顯示不同圖示
            let fileIcon = 'fa-file';
            let fileTypeText = '其他檔案';
            
            if (file.type === 'basic') {
                fileIcon = 'fa-file-alt';
                fileTypeText = '基本資料';
            } else if (file.type === 'certificate') {
                fileIcon = 'fa-certificate';
                fileTypeText = '合格保證書';
            } else if (file.type === 'manager') {
                fileIcon = 'fa-id-card';
                fileTypeText = '管理人員證書';
            }
            
            fileItem.innerHTML = `
                <div class="file-info">
                    <div><strong>${file.name}</strong></div>
                    <div style="font-size: 0.85rem; color: var(--gray-dark);">
                        <i class="fas ${fileIcon}"></i> ${fileTypeText} - 上傳日期: ${file.date}
                    </div>
                </div>
                <div class="file-actions">
                    <button class="btn btn-tiny btn-outline" onclick="downloadFile('${file.name}')">
                        <i class="fas fa-download"></i>
                    </button>
                    <button class="btn btn-tiny btn-outline" onclick="deleteFile('${parkName}', '${file.name}')">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;
            
            container.appendChild(fileItem);
        });
    }

    // 渲染上傳歷史紀錄（用於自主檢查表上傳模態框）
    function renderUploadHistory(parkName, selectedYear = "112") {
        const historyGrid = document.getElementById('upload-history-grid');
        historyGrid.innerHTML = '';
        
        // 更新年份標籤
        document.querySelectorAll('.year-tab').forEach(tab => {
            tab.classList.remove('active');
            if (tab.getAttribute('data-year') === selectedYear) {
                tab.classList.add('active');
            }
        });
        
        // 取得該公園的上傳紀錄
        const parkHistory = uploadHistoryData[parkName] || {};
        const yearData = parkHistory[selectedYear] || {};
        
        // 渲染12個月份
        for (let month = 1; month <= 12; month++) {
            const monthData = yearData[month] || { status: "pending", files: [], notRequired: false };
            const monthNames = ["1月", "2月", "3月", "4月", "5月", "6月", "7月", "8月", "9月", "10月", "11月", "12月"];
            
            const monthCard = document.createElement('div');
            let cardClass = "month-card";
            if (monthData.notRequired) {
                cardClass += " not-required";
            } else if (monthData.status === "uploaded") {
                cardClass += " uploaded";
            }
            
            monthCard.className = cardClass;
            
            monthCard.innerHTML = `
                <div class="month-header">
                    <div class="month-name">${monthNames[month-1]}</div>
                    <div class="month-status ${monthData.notRequired ? 'not-required' : monthData.status}">
                        ${monthData.notRequired ? "無須上傳" : 
                          monthData.status === "uploaded" ? "已上傳" : 
                          monthData.status === "overdue" ? "逾期" : "未上傳"}
                    </div>
                </div>
                <div class="month-checkbox-option">
                    <input type="checkbox" id="not-required-${selectedYear}-${month}" ${monthData.notRequired ? 'checked' : ''} 
                           onchange="toggleNotRequired('${parkName}', ${selectedYear}, ${month}, this.checked)">
                    <label for="not-required-${selectedYear}-${month}">設定為無須上傳</label>
                </div>
                <div class="file-list">
                    ${monthData.files.length > 0 ? 
                        monthData.files.map(file => `
                            <div class="file-item">
                                <div class="file-name">${file}</div>
                                <div class="file-action" onclick="downloadFile('${file}')">
                                    <i class="fas fa-download"></i>
                                </div>
                            </div>
                        `).join('') : 
                        '<div style="text-align: center; color: var(--gray-dark); padding: 10px 0; font-size: 0.9rem;">無上傳檔案</div>'
                    }
                </div>
            `;
            
            historyGrid.appendChild(monthCard);
        }
    }

    // 渲染自主檢查表歷史紀錄（用於稽查登錄模態框中的查看功能）
    function renderSelfCheckHistory(parkName, selectedYear = "112") {
        const historyGrid = document.getElementById('selfcheck-history-grid');
        historyGrid.innerHTML = '';
        
        // 更新年份標籤
        document.querySelectorAll('#selfcheck-history-modal .year-tab').forEach(tab => {
            tab.classList.remove('active');
            if (tab.getAttribute('data-year') === selectedYear) {
                tab.classList.add('active');
            }
        });
        
        // 取得該公園的上傳紀錄
        const parkHistory = uploadHistoryData[parkName] || {};
        const yearData = parkHistory[selectedYear] || {};
        
        // 渲染12個月份
        for (let month = 1; month <= 12; month++) {
            const monthData = yearData[month] || { status: "pending", files: [], notRequired: false };
            const monthNames = ["1月", "2月", "3月", "4月", "5月", "6月", "7月", "8月", "9月", "10月", "11月", "12月"];
            
            const monthCard = document.createElement('div');
            let cardClass = "month-card";
            if (monthData.notRequired) {
                cardClass += " not-required";
            } else if (monthData.status === "uploaded") {
                cardClass += " uploaded";
            }
            
            monthCard.className = cardClass;
            
            monthCard.innerHTML = `
                <div class="month-header">
                    <div class="month-name">${monthNames[month-1]}</div>
                    <div class="month-status ${monthData.notRequired ? 'not-required' : monthData.status}">
                        ${monthData.notRequired ? "無須上傳" : 
                          monthData.status === "uploaded" ? "已上傳" : 
                          monthData.status === "overdue" ? "逾期" : "未上傳"}
                    </div>
                </div>
                <div class="file-list">
                    ${monthData.files.length > 0 ? 
                        monthData.files.map(file => `
                            <div class="file-item">
                                <div class="file-name">${file}</div>
                                <div class="file-action" onclick="downloadFile('${file}')">
                                    <i class="fas fa-download"></i>
                                </div>
                            </div>
                        `).join('') : 
                        '<div style="text-align: center; color: var(--gray-dark); padding: 10px 0; font-size: 0.9rem;">無上傳檔案</div>'
                    }
                </div>
            `;
            
            historyGrid.appendChild(monthCard);
        }
    }

    // 切換「無須上傳」設定
    window.toggleNotRequired = function(parkName, year, month, isNotRequired) {
        if (!uploadHistoryData[parkName]) {
            uploadHistoryData[parkName] = {};
        }
        if (!uploadHistoryData[parkName][year]) {
            uploadHistoryData[parkName][year] = {};
        }
        if (!uploadHistoryData[parkName][year][month]) {
            uploadHistoryData[parkName][year][month] = { status: "pending", files: [], notRequired: false };
        }
        
        uploadHistoryData[parkName][year][month].notRequired = isNotRequired;
        
        // 如果設定為無須上傳，則狀態改為「not-required」
        if (isNotRequired) {
            uploadHistoryData[parkName][year][month].status = "not-required";
        } else {
            // 如果取消無須上傳，根據是否有檔案來決定狀態
            if (uploadHistoryData[parkName][year][month].files.length > 0) {
                uploadHistoryData[parkName][year][month].status = "uploaded";
            } else {
                uploadHistoryData[parkName][year][month].status = "pending";
            }
        }
        
        // 重新渲染上傳歷史
        renderUploadHistory(parkName, year);
    };

    // 下載檔案功能
    window.downloadFile = function(filename) {
        alert(`模擬下載檔案: ${filename}`);
    };

    // 刪除檔案功能
    window.deleteFile = function(parkName, filename) {
        if (confirm(`確定要刪除檔案「${filename}」嗎？`)) {
            const parkFiles = inspectionFilesData[parkName];
            if (parkFiles) {
                const index = parkFiles.findIndex(file => file.name === filename);
                if (index !== -1) {
                    parkFiles.splice(index, 1);
                    renderInspectionFiles(parkName);
                    alert('檔案已刪除');
                }
            }
        }
    };

    // 隨機選擇本月公園功能
    document.getElementById('random-select').addEventListener('click', () => {
        const yearFilter = document.getElementById('year-filter').value;
        const monthFilter = document.getElementById('month-filter').value;
        
        // 如果沒有選擇年度月份，提示使用者
        if (!yearFilter || !monthFilter) {
            alert('請先選擇年度和月份篩選條件！');
            return;
        }
        
        // 隨機選擇約15%的公園（排除需要維護的公園）
        const availableParks = parks.filter(park => 
            !park.requiresMaintenance && 
            !park.scheduledDate && 
            park.inspectionStatus === 'pending' &&
            (!park.assignedYear || park.assignedYear !== yearFilter || park.assignedMonth !== monthFilter)
        );
        
        const randomCount = Math.floor(availableParks.length * 0.15);
        
        // 隨機選擇公園
        const selectedParks = [];
        while (selectedParks.length < randomCount && availableParks.length > 0) {
            const randomIndex = Math.floor(Math.random() * availableParks.length);
            selectedParks.push(availableParks.splice(randomIndex, 1)[0]);
        }
        
        // 為選中的公園設定稽查日期（下個月）和歸屬月份
        const nextMonth = new Date();
        nextMonth.setMonth(nextMonth.getMonth() + 1);
        
        selectedParks.forEach(park => {
            // 隨機選擇下個月的某一天
            const day = Math.floor(Math.random() * 28) + 1;
            const year = fromRepublicYear(parseInt(yearFilter));
            const dateStr = `${year}-${String(monthFilter).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            
            // 更新公園資料
            const parkIndex = parks.findIndex(p => p.id === park.id);
            if (parkIndex !== -1) {
                parks[parkIndex].scheduledDate = dateStr;
                parks[parkIndex].assignedYear = yearFilter;
                parks[parkIndex].assignedMonth = monthFilter;
            }
        });
        
        // 重新渲染表格
        renderInspectionTable();
        
        // 顯示提示訊息
        alert(`已隨機選擇 ${selectedParks.length} 個公園進行${yearFilter}年${monthFilter}月稽查`);
    });

    // 模態框功能
    const inspectionModal = document.getElementById('inspection-modal');
    const inspectionHistoryModal = document.getElementById('inspection-history-modal');
    const maintenanceHistoryModal = document.getElementById('maintenance-history-modal');
    const selfcheckHistoryModal = document.getElementById('selfcheck-history-modal');
    const selfcheckModal = document.getElementById('selfcheck-modal');
    const closeModalButtons = document.querySelectorAll('.close-modal');
    let currentParkName = "";
    let currentLogParkName = "";

    // 開啟稽查登錄模態框
    document.addEventListener('click', (e) => {
        if (e.target.closest('.log-btn')) {
            const parkId = e.target.closest('.log-btn').getAttribute('data-id');
            const park = parks.find(p => p.id === parseInt(parkId));
            
            if (park) {
                currentLogParkName = park.name;
                document.getElementById('modal-park-name').value = park.name;
                document.getElementById('scheduled-date').value = park.scheduledDate || '';
                document.getElementById('actual-date').value = park.scheduledDate || '';
                
                // 根據當前狀態設定稽查結果
                if (park.inspectionStatus === 'completed') {
                    document.querySelector('input[name="result"][value="合格"]').checked = true;
                } else if (park.inspectionStatus === 'improving') {
                    document.querySelector('input[name="result"][value="改善中"]').checked = true;
                }
                
                // 清空檔案上傳欄位
                document.getElementById('playground-basic-file').value = '';
                document.getElementById('certificate-file').value = '';
                document.getElementById('manager-certificate-file').value = '';
                
                // 渲染已上傳檔案清單
                renderInspectionFiles(park.name);
                
                inspectionModal.style.display = 'flex';
            }
        }
    });

    // 開啟自主檢查表上傳模態框
    document.addEventListener('click', (e) => {
        if (e.target.closest('.upload-btn')) {
            const parkId = e.target.closest('.upload-btn').getAttribute('data-id');
            const park = selfCheckParks.find(p => p.id === parseInt(parkId));
            
            if (park) {
                currentParkName = park.name;
                document.getElementById('selfcheck-park').value = park.name;
                
                // 渲染上傳歷史紀錄
                renderUploadHistory(park.name);
                
                selfcheckModal.style.display = 'flex';
            }
        }
    });

    // 查閱備查紀錄
    document.getElementById('view-inspection-history').addEventListener('click', () => {
        document.getElementById('history-park-name').value = currentLogParkName;
        inspectionModal.style.display = 'none';
        inspectionHistoryModal.style.display = 'flex';
    });

    // 查閱定期維護紀錄
    document.getElementById('view-maintenance-history').addEventListener('click', () => {
        document.getElementById('maintenance-park-name').value = currentLogParkName;
        inspectionModal.style.display = 'none';
        maintenanceHistoryModal.style.display = 'flex';
    });

    // 查閱每月自主檢查表紀錄
    document.getElementById('view-selfcheck-history').addEventListener('click', () => {
        document.getElementById('selfcheck-history-park-name').value = currentLogParkName;
        
        // 渲染自主檢查表歷史紀錄
        renderSelfCheckHistory(currentLogParkName);
        
        inspectionModal.style.display = 'none';
        selfcheckHistoryModal.style.display = 'flex';
    });

    // 自主檢查表歷史紀錄年份標籤切換
    document.addEventListener('click', (e) => {
        if (e.target.closest('#selfcheck-history-modal .year-tab')) {
            const year = e.target.closest('.year-tab').getAttribute('data-year');
            renderSelfCheckHistory(currentLogParkName, year);
        }
    });

    // 查詢按鈕（原查詢歸屬）
    document.getElementById('query-assignments').addEventListener('click', () => {
        const yearFilter = document.getElementById('year-filter').value;
        const monthFilter = document.getElementById('month-filter').value;
        
        if (!yearFilter || !monthFilter) {
            alert('請先選擇年度和月份！');
            return;
        }
        
        // 顯示該年月的公園歸屬清單
        const assignedParks = parks.filter(park => 
            park.assignedYear === yearFilter && park.assignedMonth === monthFilter
        );
        
        if (assignedParks.length === 0) {
            alert(`${yearFilter}年${monthFilter}月沒有已歸屬的公園`);
        } else {
            const parkNames = assignedParks.map(park => park.name).join('\n');
            alert(`${yearFilter}年${monthFilter}月已歸屬的公園：\n\n${parkNames}`);
        }
    });

    // 儲存歸屬設定
    document.getElementById('save-assignments').addEventListener('click', () => {
        const yearFilter = document.getElementById('year-filter').value;
        const monthFilter = document.getElementById('month-filter').value;
        
        if (!yearFilter || !monthFilter) {
            alert('請先選擇年度和月份！');
            return;
        }
        
        // 取得所有勾選的公園
        const checkboxes = document.querySelectorAll('.park-checkbox:checked');
        const selectedIds = Array.from(checkboxes).map(cb => parseInt(cb.getAttribute('data-id')));
        
        if (selectedIds.length === 0) {
            alert('請先勾選要歸屬的公園！');
            return;
        }
        
        // 更新公園的歸屬設定
        selectedIds.forEach(id => {
            const parkIndex = parks.findIndex(p => p.id === id);
            if (parkIndex !== -1) {
                parks[parkIndex].assignedYear = yearFilter;
                parks[parkIndex].assignedMonth = monthFilter;
            }
        });
        
        // 重新渲染表格
        renderInspectionTable();
        
        alert(`已將 ${selectedIds.length} 個公園歸屬到 ${yearFilter}年${monthFilter}月`);
    });

    // 自主檢查表查詢按鈕
    document.getElementById('selfcheck-search-btn').addEventListener('click', renderSelfCheckTable);

    // 年份標籤切換
    document.addEventListener('click', (e) => {
        if (e.target.closest('.year-tab:not(#selfcheck-history-modal .year-tab)')) {
            const year = e.target.closest('.year-tab').getAttribute('data-year');
            renderUploadHistory(currentParkName, year);
        }
    });

    // 紅黃綠燈篩選器事件處理
    document.querySelectorAll('.light-filter-option').forEach(option => {
        option.addEventListener('click', (e) => {
            const checkbox = option.querySelector('input[type="checkbox"]');
            const isChecked = checkbox.checked;
            
            // 切換勾選狀態
            checkbox.checked = !isChecked;
            
            // 更新視覺樣式
            if (checkbox.checked) {
                option.classList.add('selected');
            } else {
                option.classList.remove('selected');
            }
            
            // 如果選擇了特定燈號，取消「全部燈號」的勾選
            if (checkbox.id !== 'light-all' && checkbox.checked) {
                document.getElementById('light-all').checked = false;
                document.querySelector('.light-filter-option[data-light="all"]').classList.remove('selected');
            }
            
            // 如果「全部燈號」被勾選，取消其他燈號的勾選
            if (checkbox.id === 'light-all' && checkbox.checked) {
                document.getElementById('light-red').checked = false;
                document.getElementById('light-yellow').checked = false;
                document.getElementById('light-green').checked = false;
                
                document.querySelectorAll('.light-filter-option:not([data-light="all"])').forEach(opt => {
                    opt.classList.remove('selected');
                });
            }
            
            // 重新渲染表格
            renderInspectionTable();
        });
    });

    // 關閉模態框
    closeModalButtons.forEach(button => {
        button.addEventListener('click', () => {
            inspectionModal.style.display = 'none';
            inspectionHistoryModal.style.display = 'none';
            maintenanceHistoryModal.style.display = 'none';
            selfcheckHistoryModal.style.display = 'none';
            selfcheckModal.style.display = 'none';
        });
    });

    // 點擊模態框外部關閉
    window.addEventListener('click', (e) => {
        if (e.target === inspectionModal) {
            inspectionModal.style.display = 'none';
        }
        if (e.target === inspectionHistoryModal) {
            inspectionHistoryModal.style.display = 'none';
        }
        if (e.target === maintenanceHistoryModal) {
            maintenanceHistoryModal.style.display = 'none';
        }
        if (e.target === selfcheckHistoryModal) {
            selfcheckHistoryModal.style.display = 'none';
        }
        if (e.target === selfcheckModal) {
            selfcheckModal.style.display = 'none';
        }
    });

    // 儲存稽查資料
    document.getElementById('save-inspection').addEventListener('click', () => {
        const parkName = document.getElementById('modal-park-name').value;
        const scheduledDate = document.getElementById('scheduled-date').value;
        const actualDate = document.getElementById('actual-date').value;
        const result = document.querySelector('input[name="result"]:checked').value;
        const notes = document.getElementById('notes').value;
        
        // 處理檔案上傳
        const basicFile = document.getElementById('playground-basic-file').files[0];
        const certificateFile = document.getElementById('certificate-file').files[0];
        const managerFile = document.getElementById('manager-certificate-file').files[0];
        
        // 如果有上傳新檔案，添加到檔案清單中
        if (basicFile || certificateFile || managerFile) {
            if (!inspectionFilesData[parkName]) {
                inspectionFilesData[parkName] = [];
            }
            
            const today = new Date();
            const todayStr = `${toRepublicYear(today.getFullYear())}/${String(today.getMonth() + 1).padStart(2, '0')}/${String(today.getDate()).padStart(2, '0')}`;
            
            if (basicFile) {
                inspectionFilesData[parkName].push({
                    name: basicFile.name,
                    type: 'basic',
                    date: todayStr
                });
            }
            
            if (certificateFile) {
                inspectionFilesData[parkName].push({
                    name: certificateFile.name,
                    type: 'certificate',
                    date: todayStr
                });
            }
            
            if (managerFile) {
                inspectionFilesData[parkName].push({
                    name: managerFile.name,
                    type: 'manager',
                    date: todayStr
                });
            }
        }
        
        // 更新公園資料
        const park = parks.find(p => p.name === parkName);
        if (park) {
            park.inspectionStatus = result === '合格' ? 'completed' : 'improving';
            park.scheduledDate = actualDate || scheduledDate || park.scheduledDate;
            
            // 重新渲染表格
            renderInspectionTable();
            
            // 關閉模態框
            inspectionModal.style.display = 'none';
            
            // 顯示成功訊息
            alert('稽查資料已成功儲存！');
        }
    });

    // 儲存自主檢查表資料（原上傳自主檢查表按鈕，已移至備註欄位下方）
    document.getElementById('save-selfcheck-data').addEventListener('click', () => {
        const parkName = document.getElementById('selfcheck-park').value;
        const checkMonth = document.getElementById('check-month').value;
        const checkFile = document.getElementById('check-file').files[0];
        const checkNotes = document.getElementById('check-notes').value;
        
        if (!checkFile) {
            alert('請選擇要上傳的檔案！');
            return;
        }
        
        // 解析年月
        const [year, month] = checkMonth.split('-');
        
        // 檢查是否設定為無須上傳
        const monthData = uploadHistoryData[parkName]?.[year]?.[month];
        if (monthData && monthData.notRequired) {
            alert('此月份已設定為「無須上傳」，無法上傳檔案。請先取消「無須上傳」設定。');
            return;
        }
        
        // 更新上傳紀錄
        if (!uploadHistoryData[parkName]) {
            uploadHistoryData[parkName] = {};
        }
        if (!uploadHistoryData[parkName][year]) {
            uploadHistoryData[parkName][year] = {};
        }
        
        // 建立檔案名稱
        const fileName = `${checkMonth}-自主檢查表-${checkFile.name}`;
        
        if (!uploadHistoryData[parkName][year][month]) {
            uploadHistoryData[parkName][year][month] = { status: "uploaded", files: [], notRequired: false };
        }
        
        uploadHistoryData[parkName][year][month].files.push(fileName);
        uploadHistoryData[parkName][year][month].status = "uploaded";
        uploadHistoryData[parkName][year][month].notRequired = false;
        
        // 更新公園狀態
        const park = selfCheckParks.find(p => p.name === parkName);
        if (park) {
            park.lastMonthStatus = 'uploaded';
            
            // 重新渲染表格
            renderSelfCheckTable();
            
            // 重新渲染上傳歷史
            renderUploadHistory(parkName, year);
            
            // 顯示成功訊息
            alert(`「${parkName}」的${checkMonth}自主檢查表已成功儲存！`);
            
            // 清空表單
            document.getElementById('check-file').value = '';
            document.getElementById('check-notes').value = '';
        }
    });

    // 處理公園勾選功能
    document.addEventListener('change', (e) => {
        if (e.target.classList.contains('park-checkbox')) {
            // 不需要額外處理，儲存設定時會一次處理所有勾選的公園
        }
        
        // 處理勾選篩選條件
        if (e.target.name === 'checkbox-filter') {
            renderInspectionTable();
        }
    });

    // 匯出Excel功能（模擬）
    document.getElementById('export-inspection').addEventListener('click', () => {
        alert('稽查計畫資料已匯出為Excel檔案！');
    });

    document.getElementById('export-selfcheck').addEventListener('click', () => {
        alert('自主檢查表資料已匯出為Excel檔案！');
    });

    // 篩選功能
    document.getElementById('park-name').addEventListener('input', renderInspectionTable);
    document.getElementById('district').addEventListener('change', renderInspectionTable);
    document.getElementById('inspection-status').addEventListener('change', renderInspectionTable);
    document.getElementById('year-filter').addEventListener('change', renderInspectionTable);
    document.getElementById('month-filter').addEventListener('change', renderInspectionTable);
    
    // 自主檢查表篩選功能
    document.getElementById('selfcheck-park-name').addEventListener('input', renderSelfCheckTable);
    document.getElementById('selfcheck-district').addEventListener('change', renderSelfCheckTable);
    document.getElementById('selfcheck-show-overdue').addEventListener('change', renderSelfCheckTable);

    // 初始化
    document.addEventListener('DOMContentLoaded', () => {
        renderInspectionTable();
        renderSelfCheckTable();
    });
</script>
</body>
</html>